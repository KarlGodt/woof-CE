#!/bin/ash
#set

# global variables
# find:
MAXDEPTH=4
MMIN=-720
#

DIR_PRE='../'

. /etc/rc.d/f4puppy5
_cd_program_dir || exit 1

_help(){
echo "Searches files in "
echo "/etc /root /bin /sbin /usr/bin /usr/sbin /usr/local/"
echo "with maxdpeth $MAXDEPTH and mmin $MMIN ."
echo "If diff -up exits non-zero,"
echo "asks to replace file in git repository,"
echo "asks to add file to git,"
echo "and starts commit editor"
exit 0
}

case $1 in ''):;;*) _help;;esac

TTY=`tty`

which git || export PATH=/usr/SVC/bin:$PATH

_do_exit(){
echo exitcode $*
exit $*
}

_do_git(){
unset YES_NO NO_YES
#read -p "Replace current file $file ? (y/n) : " <$TTY YES_NO >$TTY
read -p "Replace current file $file ? (y/n) : " YES_NO
echo "YES_NO='$YES_NO'"
case $YES_NO in
y|Y) :;;
n|N) return 0;;
*) _do_exit 3;;
esac
#sleep 1s

cp -ai "$file" ${DIR_PRE}woof-code/rootfs-skeleton/${file%/*}/ <$TTY >$TTY || _do_exit 4
echo $?
#cp -ai "$file" ${DIR_PRE}woof-code/rootfs-skeleton/${file%/*}/ || _do_exit 4

#read -n1 -p "Add file ${DIR_PRE}woof-code/rootfs-skeleton/$file to git ? (y/n) : " <$TTY NO_YES >$TTY
read -p "Add file ${DIR_PRE}woof-code/rootfs-skeleton/$file to git ? (y/n) : " NO_YES
case $NO_YES in
y|Y) :;;
n|N) return 0;;
*) _do_exit 5;;
esac
sleep 1s

git add ${DIR_PRE}woof-code/rootfs-skeleton/${file}

git commit
sleep 1s
return 0
}


for dirDIR in /etc/ /root/ /bin/ /sbin/ /usr/bin/ /usr/sbin/ /usr/local/
do

#find $dirDIR -mmin -720 |
dirFIND=`find $dirDIR -maxdepth $MAXDEPTH -mmin $MMIN`


 oldIFS="$IFS"
 IFS=$'\n'
 #for file in $dirFIND
 while read file;
 do
[ "$file" ] || continue
[ -d "${DIR_PRE}woof-code/rootfs-skeleton/$file" ] && { echo "$file is a directory"; continue; }
[ -L "${DIR_PRE}woof-code/rootfs-skeleton/$file" ] && { echo "$file is a Link"; continue; }
[ -f "${DIR_PRE}woof-code/rootfs-skeleton/$file" ] && {

 diff -up ${DIR_PRE}woof-code/rootfs-skeleton/$file $file && echo "$file not changed" || {

_do_git <$TTY >$TTY || _do_exit $?;
#_do_git || _do_exit $?;

 };

} || echo "$file not in woof or no regular file therein";

# done
# IFS="$oldIFS"

done <<EOI
`echo "$dirFIND"`
EOI

 IFS="$oldIFS"

done
