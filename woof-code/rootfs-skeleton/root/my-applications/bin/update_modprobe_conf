#!/bin/sh

PROG="$0"
prog=`basename $PROG`
cp /etc/modprobe.conf /etc/modprobe.conf.$prog.$$.bac
[ -f $HOME/FILE ] && mv $HOME/FILE $HOME/FILE.$prog.$$.bac

func_1(){
UEVENTS="`ls /sys/bus/*/devices/*/*/uevent`"

for i in $UEVENTS ; do 
echo $i; 
chmod +r $i ;

DRV=`grep 'DRIVER' $i | cut -f 2 -d '='`; 
MODA=`grep 'MODALIAS' $i | cut -f 2 -d '='` ; 

if [ -n "$DRV" ] && [ -n "$MODA" ] ; then
echo -n 'alias ' >> FILE 
echo -n "$MODA " >> FILE;
echo "$DRV" >> FILE;
fi

done
}

UEVENTS="`ls /sys/bus/*/devices/*/uevent`"

for i in $UEVENTS ; do 
echo $i; 
chmod +r $i ;

DRV=`grep 'DRIVER' $i | cut -f 2 -d '='`; 
MODA=`grep 'MODALIAS' $i | cut -f 2 -d '='` ; 

if [ -n "$DRV" ] && [ -n "$MODA" ] ; then
echo -n 'alias ' >> FILE 
echo -n "$MODA " >> FILE;
echo "$DRV" >> FILE;
fi

done


SYSTEM=`dmidecode -t 0 | grep -i -E 'vendor|version|release'`
WC=`echo "$SYSTEM" | wc -l`
echo "$SYSTEM"
echo $WC

j=0
for i in `seq 1 $WC` ; do
j=$((j+1))
PARAM[$i]=`echo "$SYSTEM" | head -n $i | tail -n1`
echo ${PARAM[$i]}
STRING[$i]="### ${PARAM[$i]} "
echo ${STRING[$i]}
done

echo >> /etc/modprobe.conf
echo -e "##### Updated modaliases for system ##########" >> /etc/modprobe.conf
echo $j

for i in `seq 1 $j` ; do
echo -e ${STRING[$i]} >> /etc/modprobe.conf
done
echo >> /etc/modprobe.conf

cat FILE | sort -u | sort -k 3 -t ' ' >> /etc/modprobe.conf

echo >> /etc/modprobe.conf
echo -e '### '`date` >> /etc/modprobe.conf
echo -e "##### by $prog ##############################"  >> /etc/modprobe.conf
echo >> /etc/modprobe.conf



