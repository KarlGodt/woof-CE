#!/bin/sh

DEBUG=Y

[ "`tty`" = 'not a tty' ] && exit $?

crossfire_server_dir=/usr/games/crossfire
crossfire_server_config_dir="$crossfire_server_dir"/etc/crossfire
crossfire_server_tmp_dir="$crossfire_server_dir"/tmp
mkdir -p "$crossfire_server_tmp_dir"

trap "echo ${client_[@]}; exit" 0 1 2

## generate possible database in my case from 1.9.1 upwards; adjust accordingly to your namings
for version in 1.7.0 1.9.1 1.10.0 1.11.0 1.12.0 1.12.0.mini 1.12.0.full 1.12.svn 1.50.0 1.60.0 1.70.0 ;
do

short_version="${version//[[:punct:]]/}"

[ "$DEBUG" ] && echo "$short_version"
[[ "$short_version" =~ '[[:alpha:]]' ]] && {
(( c++ ))
short_version_nr="${short_version//[[:alpha:]]/}"
short_version_chars="${short_version//[[:digit:]]/}"
#short_version="${short_version_chars}${short_version_nr}"
short_version=$((short_version_nr + c))
[ "$DEBUG" ] && echo "$short_version"
}
if [[ "$short_version" = '170' ]] || [[ "$short_version" =~ '191' ]] || [[ "$short_version" =~ '1100' ]] || [[ "$short_version" =~ '1110' ]] ; then
#if [[ "$short_version" =~ '191' ]] || [[ "$short_version" =~ '1100' ]] || [[ "$short_version" =~ '1110' ]] || [[ "$short_version" =~ '1120' ]]; then
client_[$short_version]=cfclient-${version}
client_x_[$short_version]=xcfclient-${version}
client_x11_[$short_version]=cfclient-x11-${version}
client_gtk_[$short_version]=gcfclient-${version}
client_gtk1_[$short_version]=gcfclient1-${version}
client_gtk1v2_[$short_version]=gcfclient1v2-${version}
client_gtk2_[$short_version]=gcfclient2-${version}

else

client_[$short_version]=crossfire-client-${version}
client_x_[$short_version]=crossfire-client-x-${version}
client_x11_[$short_version]=crossfire-client-x11-${version}
client_gtk_[$short_version]=crossfire-client-gtk-${version}
client_gtk1_[$short_version]=crossfire-client1-gtk1-${version}
client_gtk1v2_[$short_version]=crossfire-client-gtk1v2-${version}
client_gtk2_[$short_version]=crossfire-client-gtk2-${version}

fi
done

[ "$DEBUG" ] && echo "${client_[@]}

${client_x_[@]}

${client_x11_[@]}

${client_gtk_[@]}

${client_gtk1_[@]}

${client_gtk1v2_[@]}

${client_gtk2_[@]}
"

for client in ${client_[@]} ${client_x_[@]} ${client_x11_[@]} ${client_gtk_[@]} ${client_gtk1_[@]} ${client_gtk1v2_[@]} ${client_gtk2_[@]} ; do
[ "`which $client`" ] || continue
CLIENTS_ALL="${CLIENTS_ALL}
`echo $client`"
done

[ "$DEBUG" ] && echo "$CLIENTS_ALL"

CLIENTS_ALL=`echo "$CLIENTS_ALL" |sort -d`

[ "$DEBUG" ] && echo "$CLIENTS_ALL"

echo "$0 : '`readlink -e $0`' ::
Wrapper to choose the installed crossfire client
if several are defined in this script .
"

while [ 1 ] ; do
select client_choose in $CLIENTS_ALL ; do echo "
$client_choose chosen"; break ; done ;
[ "$client_choose" ] && break ;
sleep 1s
done

#assigned_client=`echo "$CLIENTS" | grep -w ^$client_choose | cut -f2 -d=`
assigned_client="$client_choose"

which "$assigned_client" || { echo "'$client_choose' = '$assigned_client' not in PATH ?" >&2;exit $?; }

function_start_server(){

pidof crossfire && { echo "OK, crossfire already running" ; return 0 ; }
pidof crossfire-server && { echo "OK, crossfire-server already running";return 0; }
ps | grep crossfire | grep server || {

crossfire_server="$crossfire_server_dir"/bin/crossfire
[ -f "$crossfire_server" ] ||  crossfire_server="$crossfire_server_dir"/bin/crossfire-server

[ -x "$crossfire_server" ] && {

echo starting crossfire server ... >&2

[ -f "$crossfire_server_tmp_dir"/crossfire_server.log ] && mv "$crossfire_server_tmp_dir"/crossfire_server.log "$crossfire_server_tmp_dir"/crossfire_server.log.0

ME_IP_ADDRESS=`ifconfig |grep inet |tail -n1 |awk '{print $2}' |cut -f2 -d:`
echo "ME_IP_ADDRESS='$ME_IP_ADDRESS'"
sed -i "s,^metaserver_host .*,metaserver_host ${ME_IP_ADDRESS}," "$crossfire_server_config_dir"/settings
sed -i "s,^localhostname .*,localhostname ${ME_IP_ADDRESS}," "$crossfire_server_config_dir"/metaserver2

"$crossfire_server" +d -detach -log "$crossfire_server_tmp_dir"/crossfire_server.log
#"$crossfire_server" +d -log "$crossfire_server_tmp_dir"/crossfire_server.log &


sleep 5
sync

echo ... done ...
  }
 }
return $?
}
function_start_server

function_link_glade_dir(){

IS_GLADE=`echo "${assigned_client}" | grep -o 'gtk2.*' |cut -f2 -d'-'`
[ "$DEBUG" ] && echo "$IS_GLADE"
if [ "$IS_GLADE" ] ; then
 if [ -d /usr/local/share/crossfire-client/glade-gtk2 ] ; then
mv -f /usr/local/share/crossfire-client/glade-gtk2 /usr/local/share/crossfire-client/glade-gtk2.backup
 fi
 if [ -d /usr/local/share/crossfire-client/glade-gtk2-${IS_GLADE} ] ; then
  ln -s glade-gtk2-${IS_GLADE} /usr/local/share/crossfire-client/glade-gtk2
 else
  ln -s glade-gtk2.backup /usr/local/share/crossfire-client/glade-gtk2
 fi
fi
}

function_link_glade_dir

function_link_sound_serv(){
VERSION="${assigned_client##*\-}"
[ "$DEBUG" ] && echo "$VERSION"
if [ -f /usr/local/bin/cfsndserv ] && [ ! -L /usr/local/bin/cfsndserv ] ; then
 mv /usr/local/bin/cfsndserv /usr/local/bin/cfsndserv.backup
fi
if [ -f /usr/local/bin/cfsndserv_alsa9 ] && [ ! -L /usr/local/bin/cfsndserv_alsa9 ] ; then
 mv /usr/local/bin/cfsndserv_alsa9 /usr/local/bin/cfsndserv_alsa9.backup
fi

#ln -sf cfsndserv-${VERSION} /usr/local/bin/cfsndserv
ln -sf cfsndserv_alsa9-${VERSION} /usr/local/bin/cfsndserv
ln -sf cfsndserv_alsa9-${VERSION} /usr/local/bin/cfsndserv_alsa9

}

function_link_sound_serv

echo "
[ INFO ] Some clients tend to occupy one CPU core
when no local server is running
or no internet access available at startup
if not configured with --disable-metaserver2 .
Others startup ok but will behave similar if dieconnected.
The X11 and GTK frontends are unusable then.
This is a *BUG* .
Please kill the program manually if neccessary:
Example macro for the terminal:
ps | grep client ; kill -9 \`pidof cfclient\`)
where [cf]client has to be adjusted to the naming like
gcfclient or crossfire-client-gtk .
[ INFO ]
" >&2

killfunction(){
/bin/sleep 9s
me_name=`echo "${assigned_client:0:15}" | /bin/tr -d ' '`

while [ 1 ] ; do
#/bin/ps -o %c%p%C%P | /bin/grep "^$me_name" >&2
/bin/ps -o %C%p%a | /bin/grep "$me_name" | /bin/grep -v 'grep' >&2
#CHECK=`/bin/ps -o %c%p%C | /bin/grep -m1 "^$me_name"`
CHECK=`/bin/ps -o %C%p%a | /bin/grep -m1 "$me_name" |/bin/grep -v 'grep'`
CPU_US=`echo "$CHECK" | /bin/awk '{print $1}' | /bin/cut -f1 -d'.'`
ME_PID=`echo "$CHECK" | /bin/awk '{print $2}'`

[ "$DEBUG" ] && echo "$CHECK
$CPU_US $ME_PID" >&2
[ "$CPU_US" ] || break

if [ "$CPU_US" -gt 40 ] ; then
/usr/bin/xmessage -buttons "Yes:100,No:101" -bg red "WARNING:
'$CHECK'
is running high.
Do you want to kill the program ?
"
if [ "$?" -eq 100 ] ; then
/bin/kill -9 $ME_PID
fi;break;fi
/bin/sleep 2s
done
return $?
}

killfunction &

dn_assigned_client=`dirname $(which "$assigned_client")`

FONTS=`xlsfonts`
NR_OF=`echo "$FONTS" |wc -l`
RANDOM_FONT=`echo $((${RANDOM}%$NR_OF))`
[ "$DEBUG" ] && echo "$RANDOM_FONT"
FONT=`echo "$FONTS" | sed -n "$RANDOM_FONT p"`
[ "$DEBUG" ] && echo "$FONT"

export PATH="${dn_assigned_client}:${dn_assigned_client}/../games/crossfire/bin:${dn_assigned_client}/../games/crossfire/scripts:${dn_assigned_client}/../games/crossfire/crossfire-client/scripts:${dn_assigned_client}/../share/crossfire-client/scripts:${crossfire_server_dir}/crossfire-client/scripts:$HOME/.crossfire/scripts"
[ "$DEBUG" ] && echo "$PATH"
for p in `echo $PATH | /bin/tr ':' ' '`; do /bin/mkdir -p "$p" ; done

err_log="$HOME"/crossfire_client."$assigned_client".err.log
nor_log="$HOME"/crossfire_client."$assigned_client".log

echo "'$assigned_client' '$@'" >> "$err_log"
echo "'$assigned_client' '$@'" >> "$nor_log"

echo "Starting '$assigned_client' and hoping for the best ..."

if [ "`echo "$assigned_client" | /bin/grep -i 'X'`" -o "`echo "$assigned_client" | /bin/grep '^cfclient'`" ] ; then
 if [ "$@" ] ; then
 "$assigned_client" $@ 2>>"$err_log" 1>>"$nor_log"
 else
 "$assigned_client" -font "$FONT" -split -scrolllines 40 -updatekeycodes 2>>"$err_log" 1>>"$nor_log"
 fi
else
"$assigned_client" $@ 2>>"$err_log" 1>>"$nor_log"
fi

