#!/bin/bash

[ "$1" ] || { echo "Need parameter ie 'usb'";exit 1; }

for p in $@ ; do

[ "$p" = '-v' ] && break
[ "$p" = '-s' ] && break

if [ "$grepP" ] ; then
grepP="${grepP}|$p"
else
grepP="$p"
fi

done

[ "$grepP" ] || exit 1
NOT=`echo "$@" | grep -o '\-v .*' |cut -f2- -d' ' | tr ' ' '|' | sed 's@^|*@@;s@|*$@@'`
SHORT=`echo "$@" | grep -o '\-s .* \-v' |cut -f2- -d' ' | sed 's@ -v$@@' | tr ' ' '|' | sed 's@^|*@@;s@|*$@@'`

echo "grepP='$grepP' SHORT='$SHORT' NOT='$NOT'"

if [ "$SHORT" ] ; then
if [ "$NOT" ] ; then
modprobe -l | grep -E "$grepP" | grep -E "$SHORT" | grep -vE "$NOT" | while read module ; do
mod=${module##*/}
module=${mod//\.ko/}
modprobe -v $module >&2
sleep 1
done
else
modprobe -l | grep -E "$grepP" | grep -E "$SHORT" |while read module ; do
mod=${module##*/}
module=${mod//\.ko/}
modprobe -v $module >&2
sleep 1
done
fi

else
if [ "$NOT" ] ; then
modprobe -l | grep -E "$grepP" | grep -vE "$NOT" | while read module ; do
mod=${module##*/}
module=${mod//\.ko/}
modprobe -v $module >&2
sleep 1
done
else
modprobe -l | grep -E "$grepP" |while read module ; do
mod=${module##*/}
module=${mod//\.ko/}
modprobe -v $module >&2
sleep 1
done
fi
fi
