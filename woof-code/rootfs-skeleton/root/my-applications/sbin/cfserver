#!/bin/bash

##
#
# Hybryd init.d - shell start-stop wrapper for crossfire server
# Thought and written by Karl Reimer Godt
#
##

crossfire_server_dir=/usr/games/crossfire
CROSSFIRE_SERVERS_DIRS=`ls -1d "${crossfire_server_dir}"* | grep ^/ |tr -d ':'`
CROSSFIRE_SERVERS=`for d in $CROSSFIRE_SERVERS_DIRS ; do find "$d"/bin \( -iname "crossfire" -o -iname "crossfire[-_][0-9\.]*" -o -iname "crossfire[-_]server" -o -iname "crossfire[-_]server[-_][0-9\.]*" \) -print;done`

echo "$0 : '`readlink -e $0`' ::
Wrapper to choose the installed crossfire server
if several are defined or found in this script .
"

case $1 in

start)
shift;

while [ 1 ] ; do
select server_choose in $CROSSFIRE_SERVERS ; do echo "
$server_choose chosen"; break ; done ;
[ "$server_choose" ] && break ;
done

for server in $CROSSFIRE_SERVERS ; do
bn_server="${server##*/}"
pidof "$bn_server" && { echo "Seems that '$bn_server' is already running.";exit 1; }
done

dn_server="${server_choose%/*}"
choosen_crossfire_server_dir="${dn_server%/*}"

mkdir -p "$choosen_crossfire_server_dir"/tmp

[ -f "$choosen_crossfire_server_dir"/tmp/crossfire_server.log ] && mv "$choosen_crossfire_server_dir"/tmp/crossfire_server.log "$choosen_crossfire_server_dir"/tmp/crossfire_server.log.0

ME_IP_ADDRESS=`ifconfig |grep inet |tail -n1 |awk '{print $2}' |cut -f2 -d:`
echo "ME_IP_ADDRESS='$ME_IP_ADDRESS'"
sed -i "s,^metaserver_host .*,metaserver_host ${ME_IP_ADDRESS}," "$choosen_crossfire_server_dir"/etc/crossfire/settings
sed -i "s,^localhostname .*,localhostname ${ME_IP_ADDRESS}," "$choosen_crossfire_server_dir"/etc/crossfire/metaserver2

if [ -L /usr/games/crossfire ] ; then
ln -sf "$choosen_crossfire_server_dir" /usr/games/crossfire
fi
sync

if [ "$@" ] ; then
"$server_choose" $@
else
mkdir -p /var/log/crossfire
touch /var/log/crossfire/logfile
sleep 1s
sync
"$server_choose" +d -tmpdir "$choosen_crossfire_server_dir"/tmp 1>"$choosen_crossfire_server_dir"/tmp/crossfire_server.log 2>&1
fi
;;

stop)
if [ "`pidof crossfire`" ] ; then
kill -s HUP `pidof crossfire`
sleep 2s
pidof crossfire && kill -s ILL `pidof crossfire`
sleep 2s
pidof crossfire && echo "FAILED to stop crossfire server" || echo "Stopped crossfire server."
fi
if [ "`pidof crossfire-server`" ] ; then
kill -s ILL `pidof crossfire-server`
sleep 2s
pidof crossfire-server && echo "FAILED to stop crossfire server" || echo "Stopped crossfire server."
fi
;;
*) echo "Usage : `readlink -e $0` [ start | stop ] [ crossfire server parameters ]"
;;
esac
exit $?
