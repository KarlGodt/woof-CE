#!/bin/ash
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
#small mods by BK 16 june 2007
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v3.97 31jan2008 BK: refinement for detecting kernels with /dev/hd* drives.
#v4.01 10may2008 BK: bugfix for detecting if usb drive.


  _TITLE_="pup_probedisk.sh"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG=""
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

. /etc/rc.d/PUPSTATE
#v4.01
# ...older kernel with /proc/ide support will have SATADRIVES variable, else ATADRIVES
#   will be all ide/sata drives (not usb) (which all have /dev/sd notation).
INTERNAL_SD_DRIVES="$SATADRIVES"
[ "$ATADRIVES" != "" ] && INTERNAL_SD_DRIVES="$ATADRIVES"

if [ -f $HOME/.pup_event/usb-drive-log-probedisk ];then #force /proc upate mechanism
 for oneUSBDRV in `cat $HOME/.pup_event/usb-drive-log-probedisk`
 do
  disktype /dev/$oneUSBDRV >$OUT 2>$ERR
 done
fi

##all disk devices, mask off partitions...
#ALLDRVS=`grep -E ' hd| scd| sd| mmc| sr' /proc/diskstats | tr -s ' ' | cut -f 4 -d ' ' | grep -vE 'hd.*[0-9]$|sd.*[0-9]$|mmc.*p[0-9]' | tr '\n' ' '`
##plug in a cd, /proc/diskstats does not register it until drive is accessed...
##for oneIDE in `ls -1 /proc/ide | grep '^hd' | tr '\n' ' '`
#for oneBLKDRV in `ls -1 /sys/block | grep -E '^hd|^scd|^sd|^mmc|^sr' | tr '\n' ' '`
#do
# IPATTERN="$oneBLKDRV "
# [ "`echo -n "$ALLDRVS" | grep "$IPATTERN"`" = "" ] && ALLDRVS="$ALLDRVS $oneBLKDRV"
#done

#yeah, so why not just do this...
#ALLDRVS=`ls -1 /sys/block | grep -E '^hd|^scd|^sd|^mmc|^sr' | tr '\n' ' '`

#crap, right now, /sys/block does not show my hdb cd/dvd drive, but it is in
#/proc/ide. pathetic kernel! oh well...
if [ ! -e /proc/ide ];then #v3.97
 ALLDRVS=`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd'` #v3.93 no /proc/ide
else
 ALLDRVS=`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd'`
`ls -1 /proc/ide | grep '^hd'`
fi
#note: after further testing, the 2.6.21.5 kernel exhibits inconsistent behaviour for hd devices, best to avoid.

for oneDRV in $ALLDRVS
do
  case $oneDRV in
   hd*) # ide device, look in /proc/ide for info
     MEDIA=`cat /proc/ide/$oneDRV/media`
     INFO=`cat /proc/ide/$oneDRV/model`
     ;;
   sd*) # scsi devices, look in /sys/block (all appear as Direct-Access)
     MEDIA="Direct-Access"
     VENDOR=`cat /sys/block/$oneDRV/device/vendor`
     MODEL=`cat /sys/block/$oneDRV/device/model`
     INFO="$VENDOR$MODEL"
     DRVNAMES="$DRVNAMES `echo -n "$oneDRV" | cut -b 1-3` "

     #log if usb drive (not a sata drive)... v4.01...
     if [ "`echo "$INTERNAL_SD_DRIVES" | grep "$oneDRV"`" = "" ];then
      echo "$oneDRV" >> $HOME/.pup_event/usb-drive-log-probedisk
      sort -u $HOME/.pup_event/usb-drive-log-probedisk > /tmp/usb-drive-log-probedisk-tmp
      mv -f /tmp/usb-drive-log-probedisk-tmp $HOME/.pup_event/usb-drive-log-probedisk
     fi

     ;;
   scd*|sr*) #  scsi cdroms
     MEDIA="cdrom"
     VENDOR=`cat /sys/block/$oneDRV/device/vendor`
     MODEL=`cat /sys/block/$oneDRV/device/model`
     INFO="$VENDOR$MODEL"
     ;;
   mmc*) #/dev/mmcblk0
     MEDIA="Direct-Access"
     INFO="MMC/SD: `cat /sys/block/$oneDRV/device/name`"
     ;;
   fd*)
     MEDIA='floppy'
     INFO='Generic 1440KB'
     ;;
   *) # maybe I let something bad in -- skip it
     continue
     ;;
  esac
  #PARTITINOS=`ls -1d /sys/classs/block/$oneDRV |sed 's#.*\([0-9]*$\)#\1#'`
  PARTITIONS=`ls -1 /sys/class/block/$oneDRV |grep -o -e '[[:digit:]]*' |sort -n |tr '\n' ' '`
  SIZE=`cat /sys/block/$oneDRV/size`
  #[ "$SIZE" ] && SIZE="$((SIZE/2/1000/1000))gb"
  [ "$SIZE" ] && SIZE=`echo "scale=2;$SIZE /2 /1024 /1024" | bc -l`'gb'
  [ "$SIZE" ] || SIZE=unknown
  INFO=`echo "$INFO" | tr '\t' ' ' |tr -s ' '`   ##+++2012-03-20 added size and unknown
  [ "`echo "$INFO" | grep '[[:alnum:]]'`" ] || INFO=unknown
  echo "/dev/$oneDRV|$MEDIA|$INFO|$SIZE|$PARTITIONS"  ##+++2012-03-18 added partitions

done

#mounted drives/partitions...
MNTDDEVS=`mount | cut -f 1 -d ' ' | cut -f 3 -d '/' | grep -E '^hd|^sd|^scd|^sr|^mmc|^fd'`

#find out if a mounted device has been unplugged...
#for hotplug drives, remove it and it will disappear from /sys/block, however
#still shows up in 'mount' if hasn't been unmounted.
for oneMNTD in $MNTDDEVS
do
 case $oneMNTD in
  hd*|sd*|sr*)
   MNTDDRVs="${oneMNTD:0:3}"
   ;;
  scd*)
   MNTDDRVs="${oneMNTD:0:4}"
   ;;
  mmc*)
   MNTDDRVs="$oneMNTD:0:7}"
   ;;
  *) echo "Unhandled '$oneMNTD'";;
 esac
 #prints to system log and to stderr...
 #MNTDDRVs=`echo "$MNTDDRVs" | sed '/^$/d'`
 #echo "MNTDDRVs='$MNTDDRVs'"
 #echo "ALLDRVS='$ALLDRVS'"
 [ "$ALLDRVS" -a "$MNTDDRVs" ] && { [ "`echo "$ALLDRVS" | grep "$MNTDDRVs"`" = "" ] && logger -s "$0: WARN: UNPLUGGED '$oneMNTD' STILL REGARDED AS MOUNTED"; }
done

###END###
