#!/bin/ash


if [ "`ps | grep 'X' | grep -v 'grep'`" != "" ]; then

read WM </etc/windowmanager

if [ "`ps | grep "$WM" | grep -v '\[' | grep -v 'grep'`" != "" ]; then

exec wmreboot #&
#exit
fi
fi

. /etc/rc.d/PUPSTATE
case $PUPMODE in 5) :
;;

*)

_f1(){
# todo 1:
openvt 7
setlogcons 7 #Redirect the kernel output to console N (0 for current)
openvt -s -- /etc/rc.d/rc.shutdown  || exit
while :; do pidof rc.shutdown && sleep 1; done
}

_f2(){
# todo 2:
openvt -sw -- /etc/rc.d/rc.shutdown || exit
}

_f3(){
# todo 3:
curFGC=`fgconsole`
NEW_FGC=$(openvt -s fgconsole 2>&1)
#read FGC </tmp/fgconsole.out #&& rm /tmp/fgconsole.out
test "$NEW_FGC" && deallocvt $NEW_FGC
chvt $curFGC
openvt -c $NEW_FGC
chvt $NEW_FGC
}

USED_CONS=`ps -o tty | grep -E '^4|^tty' | sort -u`
for atty in `seq 1 1 12`; do
echo "$USED_CONS" | grep -E "tty$atty$|,$atty$" && continue
NEW_TTY=$atty
break
done

test "$NEW_TTY"
echo NEW_TTY=$NEW_TTY
#openvt -c $NEW_TTY
deallocvt $NEW_TTY
setconsole /dev/tty$NEW_TTY
chvt $NEW_TTY
#setconsole /dev/tty$NEW_TTY

/etc/rc.d/rc.shutdown </dev/tty$NEW_TTY >/dev/tty$NEW_TTY
;;
esac
RV="$?"
[ "$RV" = '199' ] && exit 0
[ "$RV" != '0' ]  && exit 1

exec /bin/busybox reboot
