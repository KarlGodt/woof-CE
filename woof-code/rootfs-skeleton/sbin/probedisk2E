#!/bin/ash
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
#small mods by BK 16 june 2007
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v3.97 31jan2008 BK: refinement for detecting kernels with /dev/hd* drives.
#v4.01 10may2008 BK: bugfix for detecting if usb drive.
#v4.01 10may2008 BK: new 2nd-param categories. named 'probedisk2'.
#v4.01 21may2008 BK: zip and ls120 now categorized as 'floppy'.
#v4.02 9jun08 BK: correct detection of usb floppy.
#v403 fixed excessive spaces in description field.
#v406 support for old kernel, /proc/ide, /dev/hd*.


###KRG Fr 31. Aug 23:34:58 GMT+1 2012

trap "exit 1" HUP INT QUIT KILL TERM

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = "2" ] && set -x


Version='1.1'  ##added partitions
Version='1.2E' ##added function_size, moved code

usage(){
USAGE_MSG="
$0 [ PARAMETERS ]

-V : Shows version information.
-H|-h : Shows this usage.

-E : Use dc external binary if option -S applies.
-M : Shorter machine readable output for to be used in scripts.
-P : Show partition numbers.
-p : Pretty and long output for terminal usage.
-S : Show drive sizes in 1000/1024 format.
-s : Shorter output.

*******  *******  *******  *******  *******  *******  *******  *******  *******
$2"

echo "$USAGE_MSG"
exit $1
}

###KRG Fr 31. Aug 23:34:58 GMT+1 2012


###KRG Mon Jul  8 22:35:19 GMT+1 2013

function_format_size(){
if [ "$USE_DC" ] ; then
   SIZE_I=`dc $blocks_1024 $F1024 \/ p`
   SIZE_K=`dc $blocks_1000 $F1000 \/ p`
else
   SIZE_I=$(($blocks_1024 / $F1024))
   SIZE_K=$(($blocks_1000 / $F1000))
fi
SIZES="|${SIZE_K}/${SIZE_I} $USE_C"
}

function_size(){
  if [ -f /sys/block/$oneDRV/size ] ; then
  read blocks_512 </sys/block/$oneDRV/size
  blocks_1024=$(($blocks_512/2))
  blocks_1000=$((($blocks_512 * 512) / 1000 ))
   if [ "$blocks_1024" -gt $((1024*1024)) ] ; then
   F1024=$((1024*1024)) F1000=$((1000*1000)) USE_C=G function_format_size
   elif [ "$blocks_1024" -gt 1024 ] ; then
   F1024=1024 F1000=1000 USE_C=M function_format_size
   else
   F1024=1 F1000=1 USE_C=K function_format_size
   fi
  else
  SIZES='|not available'
  fi
}

function_partitions(){
  PARTITIONS='|'`ls -1 /sys/class/block/$oneDRV |grep -o -e '[[:digit:]]*' |sort -n |tr '\n' ' '`
}

PRETTY=YES;DICE=/dev/
while getopts hEMsSpPV option ; do
case $option in
E) USE_DC=YES ;;  ## Exact count
h|H) usage 0 ;;
M) MACHINE=YES;PRETTY='';NO_CATEG='';USE_SIZES=YES;USE_PARTS='' ;; # pup_event OUPUT style
s) NO_CATEG=YES ;;  ## omit $CATEGORY
S) USE_SIZES=YES ;;  ## show sizes of drives
p) PRETTY=YES;MACHINE='';USE_DC=YES;USE_SIZES=YES;USE_PARTS=yes ;; # Pretty OUTPUT style
P) USE_PARTS=YES ;; ## show partitions
V) echo "$0 -version $Version";exit 0 ;;
esac
done
[ "$PRETTY" ] || DICE='';

function_output(){
[ "$NO_CATEG" ] && INFO="$MODEL" || INFO="$VENDOR $MODEL"
   INFO=`echo $INFO | sed '/^$/d'`
[ "$INFO" ] && INFO="|$INFO" || INFO='|?'
[ "$NO_CATEG" ] && MEDIA=''
[ "$USE_SIZES" ] && function_size
[ "$USE_PARTS" ] && function_partitions
echo ${DICE}${oneDRV}${MEDIA}${INFO}${SIZES}${PARTITIONS}
}

###KRGMon Jul  8 22:35:19 GMT+1 2013

. /etc/rc.d/PUPSTATE
#ATADRIVES is all ide/sata drives (not usb) (which all have /dev/sd notation).
#if old kernel supporting /dev/hd* then using SATADRIVES variable...
INTERNAL_SD_DRIVES="$SATADRIVES"
[ "$ATADRIVES" != "" ] && INTERNAL_SD_DRIVES="$ATADRIVES"

if [ -f $HOME/.pup_event/usb-drive-log-probedisk ];then #force /proc upate mechanism
 for oneUSBDRV in `cat $HOME/.pup_event/usb-drive-log-probedisk`;
 do
  #disktype /dev/$oneUSBDRV > /dev/null 2>&1
  [ -b /dev/$oneUSBDRV ] && dd if=/dev/$oneUSBDRV of=/dev/null bs=512 count=1 1>$OUT 2>$ERR #v4.01 faster.
 done
fi

if [ ! "$MACHINE" ] ; then
#mounted drives/partitions...
MNTDDEVS=`awk '{print $1}' /proc/mounts | grep -o -E '[fhs]d.*|sr.*|scd.*|mmc.*'`
fi

#crap, right now, /sys/block does not show my hdb cd/dvd drive, but it is in
#/proc/ide. pathetic kernel! oh well...
if [ ! -e /proc/ide ];then #v3.97
 ALLDRVS=`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd'`
else
 ALLDRVS=`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd' | tr '\n' ' '``ls -1 /proc/ide | grep '^hd'`
fi
#note: after further testing, the 2.6.21.5 kernel exhibits inconsistent behaviour for hd devices, best to avoid old CONFIG_IDE kernel driver.

for oneDRV in $ALLDRVS
do
  case $oneDRV in
   hd*) # ide device, look in /proc/ide for info
     read MEDIA </proc/ide/$oneDRV/media
     [ "$MEDIA" = "disk" ] && MEDIA="drive"
     [ "$MEDIA" = "cdrom" ] && MEDIA="optical"
     read INFO </proc/ide/$oneDRV/model
   ;;
   sd*) # scsi devices, look in /sys/block (all appear as Direct-Access)
     MEDIA="|drive"
     read VENDOR </sys/block/$oneDRV/device/vendor
     read MODEL </sys/block/$oneDRV/device/model
     DRVNAMES="$DRVNAMES `echo -n "$oneDRV" | cut -b 1-3` "

     #log if usb drive (not a sata drive)... v4.01...
     #if [ "`echo "$INTERNAL_SD_DRIVES" | grep "$oneDRV"`" = "" ];then
     if [ "`find /sys -name $oneDRV | grep 'usb' | grep 'block'`" ] ; then
      MEDIA="|usbdrv" #v4.01
      echo "$oneDRV" >> $HOME/.pup_event/usb-drive-log-probedisk
      sort -u $HOME/.pup_event/usb-drive-log-probedisk > /tmp/usb-drive-log-probedisk-tmp
      mv -f /tmp/usb-drive-log-probedisk-tmp $HOME/.pup_event/usb-drive-log-probedisk
      #find out if a usb floppy drive...

       if [ -e /sys/block/${oneDRV}/size ];then
       [ "`cat /sys/block/${oneDRV}/size`" = "2880" ] && MEDIA="|floppy"
       fi

       if [ -e /sys/block/${oneDRV}/device/model ];then
       [ "`grep -E ' FDD| UF000x|Floppy|USB\-FDU|^FD\-|FLOPPY' /sys/block/${oneDRV}/device/model`" ] && MEDIA="|floppy"
       fi
     #find out if it is a removable internal drive (zip, ls120, etc)...
     elif [ -e /sys/block/${oneDRV}/removable ];then
       [ "`cat /sys/block/${oneDRV}/removable`" = "1" ] && MEDIA="|floppy"
     fi

   ;;
   scd*|sr*) #  scsi cdroms
     MEDIA="|optical"
     read VENDOR </sys/block/$oneDRV/device/vendor
     read MODEL </sys/block/$oneDRV/device/model
   ;;
   mmc*) #/dev/mmcblk0
     MEDIA="|card"
     VENDOR='MMC/SD:'
     read MODEL </sys/block/$oneDRV/device/name
   ;;
    fd*)
     MEDIA='|floppy'
     VENDOR='Generic'
     MODEL='1440kb FD'
   ;;
   *)
     MEDIA='|unknown'
     VENDOR='?'
   ;;
  esac

  function_output

done

if [ ! "$MACHINE" ] ; then
#find out if a mounted device has been unplugged...
#for hotplug drives, remove it and it will disappear from /sys/block, however
#still shows up in 'mount' if hasn't been unmounted.
for oneMNTD in $MNTDDEVS
do
 case $oneMNTD in
  hd*|sd*|sr*|fd*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-3` "
   ;;
  scd*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-4` "
   ;;
  mmc*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-7` "
   ;;
 esac
 #prints to system log and to stderr...
 [ "`echo "$ALLDRVS" | grep "$MNTDDRV"`" ] || logger -s "PROBEDISK WARNING: $oneMNTD UNPLUGGED WITHOUT UNMOUNTING it FOREHAND !"
done
fi

###END###
exit 0  #force exitcode for klibc K.Almquist dash/sh
