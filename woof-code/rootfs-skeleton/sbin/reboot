#!/bin/sh

ERR=/dev/null;OUT=$ERR;VERB='';L_VERB='';A_VERB='';QUIET='-q'; ##+++2012-03-10
[ "$DEBUG" ] && { ERR=/dev/stderr;OUT=/dev/stdout;VERB=-v;L_VERB=--verbose;A_VERB=-verbose;QUIET=''; }

usage(){ echo "help for $0:
When runs , checks if X not running .
If X is running executing `which wmreboot` .
wmreboot kills X and wm and 
$0 runs /etc/rc.d/rc.shutdown
and finally executes /bin/busybox reboot ." ; }

PARAMETERS="$@"
#PARAMETERS=`echo "$PARAMETERS" | tr '[[:upper:]]' '[[:lower:]]'`
for param in $PARAMETERS; do
echo $param >$OUT
case $param in
#h|-h|help|-help|--help) usage;exit 0;;
[Hh]|-[Hh]|[-]*[Hh]*|[Hh]*) usage;exit 0;;

v|-v|verbose|[-]*verbose) VERBOSE=1; QUIET='';
VERB=-v;L_VERB=--verbose;A_VERB=-verbose
;;
D|-D|debug|[-]*debug) DEBUG=1
err=/dev/console;out=/dev/console #;output=$out $err
;;
s|-s|silent|[-]*silent) SILENT=1
err=/dev/console;out=/dev/null
;;
q|-q|quiet|[-]*quiet) QUIET=1
err=/dev/null;out=/dev/null #;output=$out $err
;;
*) BB_REBOOT="$BB_REBOOT $param";;

esac
done

#[ "$DISPLAY" ] && exit

#if [ -n "`ps | grep 'X :' | grep -v 'grep'`" ]; then
if [ "`pidof X`" ]; then
exec wmreboot $PARAMETERS
exit
fi

RETval=''
SHUT_HOW='rebooting' /etc/rc.d/rc.shutdown $PARAMETERS || RETval=$?
if [ "$RETval" ];then
case $RETval in
199) echo;return 0 2>$ERR || exit 0;;
*)
echo -e "\n\e[1;31m""ERROR: < $RETval > canceling rc.shutdown""\e[0;39m"
return $RETval 2>$ERR || exit $RETval
;;
esac
fi

#bash-3.2# busybox reboot --help
#BusyBox v1.18.3 (2011-05-01 19:45:13 CEST) multi-call binary.
#
#Usage: reboot [-d DELAY] [-n] [-f]
#
#Reboot the system
#
#Options:
#	-d SEC	Delay interval
#	-n	Do not sync
#	-f	Force (don't go through init)
#
#bash-3.2#
BB_REBOOT="$BB_REBOOT -f"
KERNEL_MAJOR=`uname -r |cut -f1 -d.`
KERNEL_THREE=`uname -r |cut -f3 -d. |grep -o -e '^[0-9]*'`
if [ "$KERNEL_MAJOR" -eq 2 -a "$KERNEL_THREE" -lt 37 ] ; then
BB_REBOOT="${BB_REBOOT// \-f/}"
fi
echo "Executing /bin/busybox reboot '$BB_REBOOT'"
exec /bin/busybox reboot $BB_REBOOT
