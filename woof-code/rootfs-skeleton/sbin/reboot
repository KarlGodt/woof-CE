#!/bin/bash

Version='1.1 KRG'

ERR=/dev/null;OUT=$ERR;VERB='';L_VERB='';A_VERB='';QUIET='-q'; ##+++2012-03-10
[ "$DEBUG" ] && { ERR=/dev/stderr;OUT=/dev/stdout;VERB=-v;L_VERB=--verbose;A_VERB=-verbose;QUIET=''; }

usage(){
MSG="
$0 [help[|force|debug|verbose]|BB PARAMETERS]
Version $Version .
Puppy reboot script to run
/etc/rc.d/rc.shutdown and finally
/bin/busybox reboot .
Simple PARAMETERS
verbose,debug,force are passed to rc.shutdown,
any other PARAMETERS get passed to busybox reboot .
`busybox reboot --help 2>&1`
"
if [ "$2" ];then
MSG="$MSG

$2
"
fi
echo "$MSG"
[ "$DISPLAY" ] && xmessage -bg black -fg yellow "$MSG"
exit $1
}

#grep $QUIET -E 'help|usage' <<<$@ && usage 0 ##+++2012-03-10

for p in $@;do
[ "$DEBUG" ] && echo $p
case $p in
help|usage)
/etc/rc.d/rc.shutdown $p
usage 0;;
force|debug|verbose) RC="$RC $p" ;;
*) RBOOT="$RBOOT $p" ;;
esac;done

#if [ "`ps | grep -w 'X' | grep -v 'grep'`" ]; then
if [ "`pidof X`" ]; then ##+++2012-03-10
echo "Using '`which wm${0##*/}`' '$@'..."
exec wmreboot "$@"
fi

SHUT_HOW='rebooting' /etc/rc.d/rc.shutdown "$RC"
RV="$?"
[ "$RV" = '199' ] && exit 0
[ "$RV" != '0' ] && exit 1

KERNEL=`uname -r`
if [ "${KERNEL:0:1}" = 3 ] ; then
RBOOT="$RBOOT -f -n"
elif [ "${KERNEL:0:1}" = 2 -a "${KERNEL:2:1}" = 6 -a "`echo "${KERNEL:4:2}" | sed 's|[^[:digit:]]||'`" -gt 34 ] ; then
RBOOT="$RBOOT -f -n"
fi
echo -e '\033[0;34m'"Executing busybox reboot $RBOOT"'\033[0;39m'
exec /bin/busybox reboot $RBOOT
