#!/bin/ash
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_reboot"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/sbin/reboot"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP='1'; TWO_VERSION='1'; TWO_VERBOSE='1'; TWO_DEBUG='1'; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#

#ERR=/dev/null;OUT=$ERR;VERB='';L_VERB='';A_VERB='';QUIET='-q'; ##+++2012-03-10
#[ "$DEBUG" ] && { ERR=/dev/stderr;OUT=/dev/stdout;VERB=-v;L_VERB=--verbose;A_VERB=-verbose;QUIET=''; }

usage(){ echo "help for $0:
When runs , checks if X not running .
If X is running executing `which wmreboot` .
wmreboot kills X and wm and
$0 runs /etc/rc.d/rc.shutdown
and finally executes /bin/busybox reboot .

Options:

busybox reboot options:
`busybox reboot --help 2>&1`
"

/etc/rc.d/rc.shutdown --help ; }

PARAMETERS="$@"
#PARAMETERS=`echo "$PARAMETERS" | tr '[[:upper:]]' '[[:lower:]]'`
for param in $PARAMETERS; do
echo $param >$OUT
case $param in
#h|-h|help|-help|--help) usage;exit 0;;
[Hh]|-[Hh]|[-]*[Hh]*|[Hh]*) usage;exit 0;;

v|-v|verbose|[-]*verbose) VERBOSE=1; QUIET='';
VERB=-v;L_VERB=--verbose;A_VERB=-verbose
;;
D|-D|debug|[-]*debug) DEBUG=1
ERR=/dev/console;OUT=/dev/console #;output=$out $err
;;
s|-s|silent|[-]*silent) SILENT=1
ERR=/dev/console;OUT=/dev/null
;;
q|-q|quiet|[-]*quiet) QUIET=1
ERR=/dev/null;OUT=/dev/null #;output=$out $err
;;
*) BB_REBOOT="$BB_REBOOT $param";;

esac
done

#[ "$DISPLAY" ] && exit

#if [ -n "`ps | grep 'X :' | grep -v 'grep'`" ]; then
if [ "`pidof X`" ]; then
exec wmreboot $PARAMETERS
exit
fi

retVAL=''
SHUT_HOW='rebooting' /etc/rc.d/rc.shutdown $PARAMETERS || retVAL=$?
if [ "$retVAL" ];then
case $retVAL in
199) echo;return 0 2>$ERR || exit 0;;
*)
echo -e "\n\e[1;31m""ERROR: < $retVAL > canceling rc.shutdown""\e[0;39m"
return $retVAL 2>$ERR || exit $retVAL
;;
esac
fi

#BusyBox v1.18.3 (2011-05-01 19:45:13 CEST) multi-call binary.
#
#Usage: reboot [-d DELAY] [-n] [-f]
#
#Reboot the system
#
#Options:
#   -d SEC  Delay interval
#   -n  Do not sync
#   -f  Force (don't go through init)
#

BB_REBOOT="$BB_REBOOT -f"
KERNEL_MAJOR=`uname -r |cut -f1 -d.`
KERNEL_THREE=`uname -r |cut -f3 -d. |grep -o -e '^[0-9]*'`
if [ "$KERNEL_MAJOR" -eq 2 -a "$KERNEL_THREE" -lt 37 ] ; then
BB_REBOOT="${BB_REBOOT// \-f/}"
fi
echo -e "\\033[1;33m
Executing /bin/busybox reboot '$BB_REBOOT'
:\\033[0;39m"
exec /bin/busybox reboot $BB_REBOOT
