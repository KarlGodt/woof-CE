#!/bin/ash
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_probedisk2"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/sbin/probedisk2"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
#small mods by BK 16 june 2007
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v3.97 31jan2008 BK: refinement for detecting kernels with /dev/hd* drives.
#v4.01 10may2008 BK: bugfix for detecting if usb drive.
#v4.01 10may2008 BK: new 2nd-param categories. named 'probedisk2'.
#v4.01 21may2008 BK: zip and ls120 now categorized as 'floppy'.
#v4.02 9jun08 BK: correct detection of usb floppy.
#v403 fixed excessive spaces in description field.
#v406 support for old kernel, /proc/ide, /dev/hd*.


########################################################################
#
# CHANGES by Karl Reimer Godt
# 01.0 : ATA+SATADRIVES var new ( still to observe )
# 02.0 : fallback if info in files contain nothing
#
# /dev/hda8:
# LABEL="MacPup431_O2"
# UUID="6d9a8e91-c301-4ff8-9875-97ec708cbee8"
# TYPE="ext3"
# DISTRO_NAME='Puppy'
# DISTRO_VERSION=431
# DISTRO_BINARY_COMPAT='puppy'
# DISTRO_FILE_PREFIX='pup'
# DISTRO_COMPAT_VERSION='4'
# PUPMODE=2
# KERNVER=2.6.37.4-KRG-i486-StagingDrivers-2
# PUP_HOME='/'
# SATADRIVES='·'
# USBDRIVES='·sda·'
# Linux·puppypc·2.6.37.4-KRG-i486-StagingDrivers-2·#4·SMP·Thu·Mar·17·06:05:58·GMT-8·2011·i686·GNU/Linux
# Xserver=/usr/X11R7/bin/Xorg
# $LANG=de_DE@euro
# today=Fr·28.·Okt·09:04:43·GMT-1·2011
#
# TODO1 : $HOME for spot ~FIXED
#
#
#
########################################################################


. /etc/rc.d/PUPSTATE
#ATADRIVES is all ide/sata drives (not usb) (which all have /dev/sd notation).
#if old kernel supporting /dev/hd* then using SATADRIVES variable...

###<KRG+2011-10-28>
INTERNAL_SD_DRIVES1="$SATADRIVES
$ATADRIVES"                       ##+++2011-10-28
INTERNAL_SD_DRIVES=`echo "$INTERNAL_SD_DRIVES1" | sort -u | sort -d`  ##+++2011-10-28
#[ "$ATADRIVES" != "" ] && INTERNAL_SD_DRIVES="$ATADRIVES"  ##+-+2011-10-28
###</KRG+2011-10-28>

###+-+2012-01-22 Changed /root to $HOME
home="$HOME"
[ "$home" = '/' ] && home='/root'
STATE_DIR="$home/Choices/Puppy"
#stateDIR="$HOME/Choices/Puppy"
#drive_iconDIR="$stateDIR"/.pup_event
#mkdir -p "$drive_iconDIR"

if [ -f "$STATE_DIR"/usb-drive-log-probedisk ];then #force /proc upate mechanism
 for oneUSBDRV in `cat "$STATE_DIR"/usb-drive-log-probedisk`
 do
  #disktype /dev/$ONEUSBDRV > /dev/null 2>&1
  #dd if=/dev/$oneUSBDRV of=/dev/null bs=512 count=1 >/dev/null 2>&1 #v4.01 faster.
  (true </dev/$oneUSBDRV) >$OUT 2>$ERR
 done
fi

#mounted drives/partitions...
#MNTDDEVS=`mount | cut -f 1 -d ' ' | cut -f 3 -d '/' | grep -E '^hd|^sd|^scd|^sr|^mmc' | tr '\n' ' '`
#MNTDDEVS=`mount | cut -f 2 -d '"' | cut -f 3 -d '/' | grep -E '^hd|^sd|^scd|^sr|^mmc|^fd'`
MNTDDEVS=`grep -o '^/dev/[^ ]\+' /proc/mounts | grep -oE 'hd.*|sd.*|scd.*|sr.*|mmc.*|fd.*'`

#crap, right now, /sys/block does not show my hdb cd/dvd drive, but it is in
#/proc/ide. pathetic kernel! oh well...
if [ ! -e /proc/ide ];then #v3.97
 ALLDRVS=`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^hd|^fd'`
else
 ALLDRVS="`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd'`
`ls -1 /proc/ide | grep '^hd'`"
fi
#note: after further testing, the 2.6.21.5 kernel exhibits inconsistent behaviour for hd devices, best to avoid.

for oneDRV in $ALLDRVS
do
  unset MEDIA dINFO VENDOR MODEL
  #MEDIA=;INFO=;VENDOR=;MODEL=;
  case $oneDRV in
   hd*) # ide device, look in /proc/ide for info
     #MEDIA=`cat /proc/ide/$oneDRV/media`
     test -f /proc/ide/$oneDRV/media && read MEDIA </proc/ide/$oneDRV/media
     [ "$MEDIA" = "disk" ]  && MEDIA="drive"
     [ "$MEDIA" = "cdrom" ] && MEDIA="optical"
     [ "$MEDIA" = "" ] && MEDIA='noInfo@procIde'  ##+++2011-10-28
     #INFO=`cat /proc/ide/$oneDRV/model`
     test -f /proc/ide/$oneDRV/model && read dINFO </proc/ide/$oneDRV/model
     [ "$dINFO" ] || dINFO='noInfo@procIde'
   ;;
   sd*) # scsi devices, look in /sys/block (all appear as Direct-Access)
     MEDIA="drive"
     #VENDOR=`cat /sys/block/$oneDRV/device/vendor | tr -s ' '`
     test -f /sys/block/$oneDRV/device/vendor && read VENDOR </sys/block/$oneDRV/device/vendor
     [ "$VENDOR" ] || VENDOR='noInfo@sysBlock'  ##+++2011-10-28
     #MODEL=`cat /sys/block/$oneDRV/device/model | tr -s ' '`
     test -f /sys/block/$oneDRV/device/model  && read MODEL  </sys/block/$oneDRV/device/model
     [ "$MODEL" ]  || MODEL='noInfo@sysBlock'   ##+++2011-10-28
     dINFO="$VENDOR $MODEL"
     DRVNAMES="$DRVNAMES `echo -n "$oneDRV" | cut -b 1-3` "

     #log if usb drive (not a sata drive)... v4.01...
     if [ "`echo "$INTERNAL_SD_DRIVES" | grep "$oneDRV"`" = "" ];then
      MEDIA="usbdrv" #v4.01
      echo "$oneDRV" >> "$STATE_DIR"/usb-drive-log-probedisk
      sort -u "$STATE_DIR"/usb-drive-log-probedisk > /tmp/usb-drive-log-probedisk-tmp
      cp -f /tmp/usb-drive-log-probedisk-tmp "$STATE_DIR"/usb-drive-log-probedisk
      #find out if a usb floppy drive...
      if [ -e /sys/block/${oneDRV}/size ];then
       [ "`cat /sys/block/${oneDRV}/size`" = "2880" ] && MEDIA="floppy"
      fi
      #if the floppy diskette not inserted, try this fallback test...
      #some examples: Vendor: NEC Model: USB UF000x Rev: 1.50, Sony USB Floppy Drive, rev 1.10/5.01,
      # MITUMI USB FDD, VenDor: TEAC Model: FD-05PUB, Vendor: COMPAQ Model: USB EXT FLOPPY
      if [ -e /sys/block/${oneDRV}/device/model ];then
       [ "`grep -E ' FDD| UF000x|Floppy|USB\-FDU|^FD\-|FLOPPY' /sys/block/${oneDRV}/device/model`" != "" ] && MEDIA="floppy"
      fi
     else
      #find out if it is a removable internal drive (zip, ls120, etc)...
      if [ -e /sys/block/${oneDRV}/removable ];then
       [ "`cat /sys/block/${oneDRV}/removable`" = "1" ] && MEDIA="floppy"
      fi
     fi

   ;;
   scd*|sr*) #  scsi cdroms
     MEDIA="optical"
     #VENDOR=`cat /sys/block/$oneDRV/device/vendor | tr -s ' '`
     test -f /sys/block/$oneDRV/device/vendor && read VENDOR </sys/block/$oneDRV/device/vendor
     #MODEL=`cat /sys/block/$oneDRV/device/model | tr -s ' '`
     test -f /sys/block/$oneDRV/device/model  && read MODEL  </sys/block/$oneDRV/device/model
     [ "$VENDOR" ] || VENDOR='noInfo@sysBlock'   ##+++2011-10-28
     [ "$MODEL" ]  ||  MODEL='noInfo@sysBlock'   ##+++2011-10-28
     #dINFO="${VENDOR% *} ${MODEL#* }"
     dINFO="$VENDOR $MODEL"
   ;;
   mmc*) #/dev/mmcblk0
     MEDIA="card"
     #NAME=`cat /sys/block/$oneDRV/device/name`
     test -f /sys/block/$oneDRV/device/name && read NAME </sys/block/$oneDRV/device/name
     [ "$NAME" ] || NAME='noInfo@sysBlock'   ##+++2011-10-28
     #INFO="MMC/SD: `cat /sys/block/$oneDRV/device/name`"
     #INFO="MMC/SD: ${NAME#* }"
     dINFO="MMC/SD: $NAME"
   ;;
   fd*)
     MEDIA='floppy'
     VENDOR='Legacy'
     MODEL='3"5 inch'
     #dINFO="${VENDOR% *} ${MODEL#* }"
     dINFO="$VENDOR $MODEL"
   ;;
   *)
     continue
   ;;
  esac
  echo "/dev/$oneDRV|$MEDIA|$dINFO"

done

#find out if a mounted device has been unplugged...
#for hotplug drives, remove it and it will disappear from /sys/block, however
#still shows up in 'mount' if hasn't been unmounted.
for oneMNTD in $MNTDDEVS
do
 case $oneMNTD in
  hd*|sd*|sr*|fd*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-3`"
   ;;
  scd*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-4`"
   ;;
  mmc*)
   MNTDDRV="`echo -n "$oneMNTD" | cut -b 1-7`"
   ;;
 esac
 #prints to system log and to stderr...
 #echo "$MNTDDRV"
 [ "`echo "$ALLDRVS" | grep -w "$MNTDDRV"`" ] || logger -s "PROBEDISK WARNING: unplugged $oneMNTD still known mounted."
done
#echo "$ALLDRVS"
###END###
