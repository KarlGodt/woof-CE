#!/bin/ash


BB=
FIND=/bin/find

#
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
#small mods by BK 16 june 2007
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v3.97 31jan2008 BK: refinement for detecting kernels with /dev/hd* drives.
#v4.01 10may2008 BK: bugfix for detecting if usb drive.
#v4.01 10may2008 BK: new 2nd-param categories. named 'probedisk2'.
#v4.01 21may2008 BK: zip and ls120 now categorized as 'floppy'.
#v4.02 9jun08 BK: correct detection of usb floppy.
#v403 fixed excessive spaces in description field.
#v406 support for old kernel, /proc/ide, /dev/hd*.


###KRG Fr 31. Aug 23:34:58 GMT+1 2012

trap "exit 1" HUP INT QUIT KILL TERM

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = "2" ] && set -x

Version='1.1' ##added partitions
Version='1.2' ##added function_size, moved code

usage(){
USAGE_MSG="
$0 [ PARAMETERS ]
-l|--long : Print more info on disks
-V|--version : showing version information
-H|--help : show this usage information

*******  *******  *******  *******  *******  *******  *******  *******  *******
$2
"
echo "$USAGE_MSG"
exit $1
}

#[ "`echo "$1" | grep -wiE "help|\-H"`" ] && usage 0
#[ "`echo "$1" | grep -wiE "version|\-V"`" ] && { echo "$0 -version $Version";exit 0; }
while [ $# != 0 ]
do
case $1 in
-l|-*long) LONG=1;;
-H|*help) usage 0;;
-V|*version) echo "$0 -version $Version"; exit 0;;
*) echo "Skipping unhandled '$1' parameter. See -H for help.";;
esac
shift
done

###KRG Fr 31. Aug 23:34:58 GMT+1 2012


###KRG Mon Jul  8 22:35:19 GMT+1 2013

function_size(){
  if [ -f /sys/block/$ONEDRV/size ] ; then
  read blocks_512 </sys/block/$ONEDRV/size
  blocks_1024=$(($blocks_512/2))
  blocks_1000=$(($blocks_512 * 512 / 1000 ))
   if [ "$blocks_1024" -gt $((1024*1024)) ] ; then
   #GB
   SIZE_I=$(( $blocks_1024 / 1024 / 1024 ))
   SIZE_K=$(( $blocks_1000 / 1000 / 1000 ))
   SIZES="${SIZE_K}/${SIZE_I} G"
   elif [ "$blocks_1024" -gt 1024 ] ; then
   SIZE_I=$(( $blocks_1024 / 1024 ))
   SIZE_K=$(( $blocks_1000 / 1000 ))
   SIZES="${SIZE_K}/${SIZE_I} M"
   else
   SIZE_I=$blocks_1024
   SIZE_K=$blocks_1000
   SIZES="${SIZE_K}/${SIZE_I} K"
   fi
  else
  SIZES='not available'
  fi
}

function_partitions(){
  PARTITIONS=`ls -1v /sys/class/block/$ONEDRV |grep -o -e '[[:digit:]]*' |sort -n |tr '\n' ' '`
}

###KRGMon Jul  8 22:35:19 GMT+1 2013

. /etc/rc.d/PUPSTATE
#ATADRIVES is all ide/sata drives (not usb) (which all have /dev/sd notation).
#if old kernel supporting /dev/hd* then using SATADRIVES variable...
INTERNAL_SD_DRIVES="$SATADRIVES"
[ "$ATADRIVES" ] && INTERNAL_SD_DRIVES="$ATADRIVES"
[ "$DEBUG" ] && echo "DBG: intSDdrv=$INTERNAL_SD_DRIVES , usb=$USB_SATAD , ATA=$SATADRIVES , SATA=$ATADRIVES" >&2

#mounted drives/partitions...
MNTDDEVS=`cut -f 1 -d ' ' /proc/mounts | cut -f 3 -d '/' | grep -E '^hd|^sd|^scd|^sr|^mmc|^fd'`

#crap, right now, /sys/block does not show my hdb cd/dvd drive, but it is in
#/proc/ide. pathetic kernel! oh well...
if [ ! -e /proc/ide ];then #v3.97
 ALLDRVS=`ls -1v /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd'`
else
 ALLDRVS=`ls -1v /sys/block | grep -E '^scd|^sd|^mmc|^sr|^fd' | tr '\n' ' '``ls -1v /proc/ide | grep '^hd' | tr '\n' ' '`
fi
#note: after further testing, the 2.6.21.5 kernel exhibits inconsistent behaviour for hd devices, best to avoid IDE .

[ "$DEBUG" ] && echo "$0:MAINLOOP START" >&2
for ONEDRV in $ALLDRVS
do
  case $ONEDRV in
   hd*) # ide device, look in /proc/ide for info
     read MEDIA </proc/ide/$ONEDRV/media
     [ "$MEDIA" = "disk" ] && MEDIA="drive"
     [ "$MEDIA" = "cdrom" ] && MEDIA="optical"
     read INFO </proc/ide/$ONEDRV/model
   ;;
   sd*) # scsi devices, look in /sys/block (all appear as Direct-Access)
     MEDIA="drive"
     read VENDOR </sys/block/$ONEDRV/device/vendor
     read MODEL </sys/block/$ONEDRV/device/model
     INFO="${VENDOR} ${MODEL}"
     DRVNAMES="$DRVNAMES `echo -n "$ONEDRV" | cut -b 1-3` "

      [ "$DEBUG" ] && echo if 1 >&2
      [ "$DEBUG" ] && date +%M:%S:%N  >&2
      if [ "`$BB $FIND /sys/devices -type d -name $ONEDRV | grep 'usb' | grep 'block'`" ]; then
      [ "$DEBUG" ] && date +%M:%S:%N  >&2
      MEDIA="usbdrv" #v4.01

      #find out if a usb floppy drive...
      [ "$DEBUG" ] && echo if 2 >&2
      if [ -e /sys/block/${ONEDRV}/size ]; then
       [ "`cat /sys/block/${ONEDRV}/size`" = "2880" ] && MEDIA="floppy"
      fi
      [ "$DEBUG" ] && echo if 3 >&2
      if [ -e /sys/block/${ONEDRV}/device/model ];then
       [ "`grep -E ' FDD| UF000x|Floppy|USB\-FDU|^FD\-|FLOPPY' /sys/block/${ONEDRV}/device/model`" != "" ] && MEDIA="floppy"
      fi

     else
      #find out if it is a removable internal drive (zip, ls120, etc)...
      [ "$DEBUG" ] && date +%M:%S:%N  >&2
      [ "$DEBUG" ] && echo if 4 >&2
      if [ -e /sys/block/${ONEDRV}/removable ];then
       [ "`cat /sys/block/${ONEDRV}/removable`" = "1" ] && MEDIA="floppy"
      fi
     fi

   ;;
   scd*|sr*) #  scsi cdroms
     MEDIA="optical"
     read VENDOR </sys/block/$ONEDRV/device/vendor
     read MODEL </sys/block/$ONEDRV/device/model
     INFO="${VENDOR} ${MODEL}"
   ;;
   mmc*) #/dev/mmcblk0
     MEDIA="card"
     INFO="MMC/SD: `cat /sys/block/$ONEDRV/device/name`"
   ;;
    fd*)
     MEDIA='floppy'
     INFO='Generic 1440KB'
   ;;
   *)
     continue
   ;;
  esac

  INFO=`echo "$INFO" | sed '/^$/d'`
  [ "$INFO" ] || INFO="SorryDevWontTell"
  [ "$LONG" ] && { function_size; function_partitions; }
  echo "/dev/$ONEDRV|$MEDIA|$INFO|$SIZES|$PARTITIONS"

done

#find out if a mounted device has been unplugged...
#for hotplug drives, remove it and it will disappear from /sys/block, however
#still shows up in 'mount' if hasn't been unmounted.
for ONEMNTD in $MNTDDEVS
do
 case $ONEMNTD in
  hd*|sd*|sr*)
   MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-3` "
   ;;
  scd*)
   MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-4` "
   ;;
  mmc*)
   MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-7` "
   ;;
 esac
 #prints to system log and to stderr...
 [ "`echo "$ALLDRVS" | grep "$MNTDDRVs"`" = "" ] && logger -s -p 2 "$0 WARNING: UNPLUGGED $ONEMNTD still considered mounted."
done

###END###
exit 0
