#!/bin/ash
##! /usr/sbin/gtkdialog3 -e
#BK nov 2007 gui frontend for dict.

  _TITLE_=Puppy_Dict
_COMMENT_="GTKdialog GUI for dict word dictionary lookup"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && . /etc/rc.d/f4puppy5

#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0 "$_COMMENT_"
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************

[ "`which dict`" ] || {
    xmessage -bg red "$(gettext 'Sorry, no "dict" found in PATH .
Please install "dict" binary.
Aborting.')"
 exit 1
}

tmpDIR=/tmp/pdict
mkdir -p "$tmpDIR"

VERB=-v
DEBUG=1

echo -n "" > "$tmpDIR"/pdict-results.txt

# Use local dicod server if it is running and no internet connection available
if ! [ "`ifconfig | grep -E '^wlan|^eth|^ppp'`" ]; then
 if _pidof $Q dicod; then
  hostP=-h
  hostURL=127.0.0.1
  portP=-p
  hostPORT=2628      #default 2628, see /etc/dicod.conf if changed
 fi
fi

DICTLIST=`dict $VERB $hostP $hostURL $portP $hostPORT --dbs`
_debug "DICTLIST='$DICTLIST'"

if ! [ "$DICTLIST" ]; then
 xmessage -bg red -title "${0##*/}" "WARNING: Could not receive any databases"
fi

COMBOCONTENT=`echo "$DICTLIST" | tr "'" "_" | grep '^ ' | grep -v '^ \-' | sed -e 's/^ //' | sed -e 's/^/<item>/' | sed -e 's/$/<\/item>/'`

if [ "$hostURL" = '127.0.0.1' ]; then
 _debug "hostURL='$hostURL' (127.0.0.1)"
else
 _debug "hostURL='$hostURL' (else)"
 COMBOCONTENT="<item>all        Search all databases</item>
 ${COMBOCONTENT}"
fi

true

# REM: MYCHOICE needs to be second variable and unquoted
#      since it contains several space and we need the first
#      argument of it.
#      If first argument unquoted all of the space delimited words of the descriptions
#       get passed to the
#        Usage: dict [options] [word]
#       [word] parameter and looked up additionally
#       which then leeds to a bunch of hits for each word in
#         The Free On-line Dictionary of Computing (26 July 2010)
#       additionally for example: 'The'
#         The \The\ ([th][=e], when emphatic or alone; [th][-e], obscure
#           before a vowel; [th]e, obscure before a consonant; 37),
#           definite article. [AS. [eth][=e], a later form for earlier
#           nom. sing. masc. s[=e], formed under the influence of the
#           oblique cases. See {That}, pron.]
#           A word placed before nouns to limit or individualize their
#           meaning.
#           [1913 Webster]
#      MYCHOICE double quoted would get passed completely to -d option
#       which would lead to error 'The is not a valid database, use -D for a list'
echo '#/bin/sh' > "$tmpDIR"/pdict-func1
echo "dict $VERB $hostP $hostURL $portP $hostPORT \\
 -d \$2 \"\$1\" >$tmpDIR/pdict-results.txt 2>&1

echo                          >>$tmpDIR/pdict.log
echo \"Lookup for    :\$1\"   >>$tmpDIR/pdict.log
echo \"dict database :\$2\"   >>$tmpDIR/pdict.log
cat $tmpDIR/pdict-results.txt >>$tmpDIR/pdict.log
"  >> "$tmpDIR"/pdict-func1
chmod $VERB 0755 "$tmpDIR"/pdict-func1


export PDICT_MAIN_DIALOG="
<window title=\"Pdict dictionary and thesaurus\" icon-name=\"gtk-info\">
 <vbox>
  <hbox>
   <text><label>enter a word:</label></text>
   <entry activates-default=\"true\">
    <variable>WORD</variable>
   </entry>
   <button has-default=\"true\">
    <input file stock=\"gtk-find\"></input>
    <label>dict</label>
    <action>$tmpDIR/pdict-func1 \"\$WORD\" \$MYCHOICE</action>
    <action>refresh:INFO</action>
   </button>
  </hbox>
  <text><label>Choose which online database (default is all):</label></text>
  <combobox>
   <variable>MYCHOICE</variable>
$COMBOCONTENT
  </combobox>
  <frame result:>
   <edit>
    <variable>INFO</variable>
    <input file>$tmpDIR/pdict-results.txt</input>
    <width>450</width>
    <height>300</height>
   </edit>
  </frame>
  <hbox>
   <button>
    <label>exit</label>
    <input file stock=\"gtk-quit\"></input>
    <action type=\"exit\">EXIT</action>
   </button>
  </hbox>
 </vbox>
</window>
"

__gtkrc__(){
## I don't know enough about themes to do this any better...
##note, normal gtkrc is now ~/.gtkrc
cp -f /etc/gtk-2.0/gtkrcMONOSPACED /etc/gtk-2.0/gtkrc
echo '#!/bin/sh
 sleep 2
 rm -f /etc/gtk-2.0/gtkrc
' > /tmp/delaygtkrc.sh
chmod 755 /tmp/delaygtkrc.sh
/tmp/delaygtkrc.sh &
}

DBG=-d
#RETSTRING=`gtkdialog3 --program=MAIN_DIALOG`
        gtkdialog3 $DBG --program=PDICT_MAIN_DIALOG

###END###
