#!/bin/bash
#(c) Copyright Barry Kauler 2006 www.puppylinux.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#BK Aug/Sept 2007: bugfixes for v2.20, 2.21
#BK Oct 2007: bugfix new version xrandr v3.02
#v3.99 BK apr 2008: workaround for dual monitors.
#v404 change to xwininfo, tidyup.


  _TITLE_=Puppy_fixPuppyPin
_VERSION_=1.0omega
_COMMENT_="Write x screen values to PuppyPin file according to screen resolution"

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || . /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST="PUPPYPIN"
ADD_PARAMETERS="PUPPYPIN : /path/to/PuppyPin
default '$HOME/Choices/ROX-Filer/PuppyPin'"
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

PUPPYPIN="$1"
[ "$PUPPYPIN" = "" ] && PUPPYPIN="$HOME/Choices/ROX-Filer/PuppyPin"
CONFFILEROX="$HOME/.config/rox.sourceforge.net/ROX-Filer/Options"

SCREEN_X=`xwininfo -root | grep -o '\-geometry.*x' | cut -f 2 -d ' ' | cut -f 1 -d 'x'`

if [ "$SCREEN_X" ];then

PIN_GRID_STEP=`sed -n '/<!--/,/-->/!p' "$CONFFILEROX" | grep -m1 "pinboard_grid_step" | sed -e "s/ *<[^>]*>//g"`
case $PIN_GRID_STEP in 2|16|32) :;;
*) PIN_GRID_STEP=32;;
esac
[ -z "$PIN_GRID_STEP" ]    && PIN_GRID_STEP=32 #2=fine 16=medium 32=coarse.
[ "$PIN_GRID_STEP" -le 0 ] && PIN_GRID_STEP=32 #precaution.

 cp $VERB -f "$PUPPYPIN" /tmp/${PUPPYPIN##*/}
 #backup
 cp $VERB -f "$PUPPYPIN" "$PUPPYPIN"OLD

 #all icons on right side of screen will be relocated to correct right side...
 NEWRIGHT_X_MAX=$((SCREEN_X - 32))
 NEWRIGHT_X_MAX=$(( (NEWRIGHT_X_MAX / PIN_GRID_STEP ) * PIN_GRID_STEP ))

 #find out current right side in PuppyPin...
 for oneAPP in Xlock Trash PupZip
 do
 echo oneAPP=$oneAPP

 #grep "/$oneAPP</icon>" "$PUPPYPIN"
 #grep "/$oneAPP\</icon\>" "$PUPPYPIN"
 #grep "/$oneAPP\</icon\>" "$PUPPYPIN" | grep -v '<!\-\-.*\-\->'
 #grep "/$oneAPP\</icon\>" "$PUPPYPIN" | grep -v '<!\-\-.*\-\->' | tail -n1
 #grep "/$oneAPP\</icon\>" "$PUPPYPIN" | grep -v '<!\-\-.*\-\->' | tail -n1 | cut -f 2 -d '"'

 RIGHT_X_MAX=`grep "/$oneAPP</icon>" "$PUPPYPIN" | grep -v '<!\-\-.*\-\->' | tail -n1 | cut -f 2 -d '"'`
 echo RIGHT_X_MAX=$RIGHT_X_MAX
 echo NEWRIGHT_X_MAX=$NEWRIGHT_X_MAX
 if [ "$RIGHT_X_MAX" ] ; then
 if [ "$RIGHT_X_MAX" != "$NEWRIGHT_X_MAX" ];then
  APATTERN="s/x=\"${RIGHT_X_MAX}\"/x=\"${NEWRIGHT_X_MAX}\"/"
  sed -i "$APATTERN" /tmp/${PUPPYPIN##*/}
  STATUS=$((STATUS+$?))
  #cat $PUPPYPIN | sed -e "$APATTERN" > /tmp/PuppyPin
  #sync
  #cp $VERB -f /tmp/PuppyPin $PUPPYPIN
 fi
 fi

 done
 echo STATUS=$STATUS
 test "$STATUS" = 0 && cp $VERB -f /tmp/${PUPPYPIN##*/} "$PUPPYPIN"

fi


###END###
