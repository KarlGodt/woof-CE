#!/bin/sh
#(c) copyright Barry Kauler aug 2009. Licence LGPL.



#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************


PREVTHEME=""
if [ -e $HOME/.icons/default ];then
 PREVTHEME=`readlink $HOME/.icons/default | rev | cut -f 1 -d '/' | rev`
fi

CURLIST=""
FIRSTITEM=""
LISTHEIGHT=30
mkdir -p /tmp/xcur2png
for oneITEM in `ls -1 $HOME/.icons | grep -v 'ROX'`
do

 #precaution that 'cursors' subdir exists...
 [ ! -d $HOME/.icons/${oneITEM}/cursors ] && continue

 if [ ! -f /usr/share/icons/${oneITEM}.png ];then
  cd $HOME/.icons/${oneITEM}/cursors
  xcur2png -d /tmp/xcur2png left_ptr
  mv -f /tmp/xcur2png/left_ptr_000.png /usr/share/icons/${oneITEM}.png
  rm -f /tmp/xcur2png/left_ptr_*.png
 fi

 if [ "$oneITEM" = "$PREVTHEME" ];then
  FIRSTITEM="<item icon=\"${oneITEM}\">${oneITEM} CURRENT THEME</item>"
 else
  CURLIST="${CURLIST}<item icon=\"${oneITEM}\">${oneITEM}</item>"
 fi
 LISTHEIGHT=`expr $LISTHEIGHT + 25`
done

[ $LISTHEIGHT -gt 550 ] && LISTHEIGHT=550
CURITEMS="  <tree>
  <label>Cursor theme</label>
    ${FIRSTITEM}
    <item icon=\"default_left_ptr\">ORIGINAL THEME</item>
    ${CURLIST}
    <variable>CHOOSECUR</variable>
    <height>${LISTHEIGHT}</height>
  </tree>"

if [ "$CURLIST" = "" ];then
 CURITEMS="<text use-markup=\"true\">
    <label>\"<b>You first need to install some cursor themes! For now, quit this program. Run the Puppy Package Manager and look in the 'Desktop' category</b>\"</label></text>"
fi

export MAIN_DIALOG="
<window title=\"Pcur: select a cursor theme\">
  <vbox>
    <text use-markup=\"true\">
      <label>\"<b>You must restart X to use the new theme</b>\"</label>
    </text>
    <text><label>Choose one you like, click 'OK', close down all applications, then choose 'Restart X server' in the 'Shutdown' menu...</label></text>


    ${CURITEMS}

    <hbox>
     <button ok></button>
     <button cancel></button>
    </hbox>
  </vbox>
</window>
"
RETVARS=`gtkdialog3 --program=MAIN_DIALOG`

[ "$CURLIST" = "" ] && exit
echo "$RETVARS"
eval "${RETVARS}"

[ "$EXIT" != "OK" ] && exit

[ "`echo "$CHOOSECUR" | grep 'CURRENT THEME'`" != "" ] && exit #already current.

if [ "$CHOOSECUR" = "ORIGINAL THEME" ];then
 rm -f $HOME/.icons/default
 exit
fi

ln -snf $CHOOSECUR $HOME/.icons/default
