#!/bin/ash
#(c) copyright Barry Kauler aug 2009. Licence LGPL.

. /etc/rc.d/f4puppy5
# BATCHMARKER01 - Marker for Line-Position to bulk insert code into.

echo "$0:$*"

[ -d "$CURSOR_THEME_DIR" ] && CURSOR_THEME_DIR="$CURSOR_THEME_DIR"
echo "CURSOR_THEME_DIR='$CURSOR_THEME_DIR'"

[ -d "$*" ] && CURSOR_THEME_DIR="$*"
echo "CURSOR_THEME_DIR='$CURSOR_THEME_DIR'"

[ -d "$CURSOR_THEME_DIR" ] || CURSOR_THEME_DIR="$HOME/.icons"

echo "CURSOR_THEME_DIR='$CURSOR_THEME_DIR'"

PREVTHEME=""
if [ -e "$CURSOR_THEME_DIR"/default ];then
 PREVTHEME="`readlink "$CURSOR_THEME_DIR"/default | rev | cut -f 1 -d '/' | rev`"
fi

CURLIST=""
FIRSTITEM=""
LISTHEIGHT=30
mkdir $VERB -p /tmp/xcur2png
for ONEITEM in `ls -1 "$CURSOR_THEME_DIR" | grep -v 'ROX'`
do

 #precaution that 'cursors' subdir exists...
 [ ! -d "$CURSOR_THEME_DIR"/${ONEITEM}/cursors ] && continue

 if [ ! -f /usr/share/icons/${ONEITEM}.png ];then
  cd "$CURSOR_THEME_DIR"/${ONEITEM}/cursors
  xcur2png -d /tmp/xcur2png left_ptr
  mv $VERB -f /tmp/xcur2png/left_ptr_000.png /usr/share/icons/${ONEITEM}.png
  rm -f /tmp/xcur2png/left_ptr_*.png
 fi

 if [ "$ONEITEM" = "$PREVTHEME" ];then
  FIRSTITEM="<item icon=\"${ONEITEM}\">${ONEITEM} CURRENT THEME</item>"
 else
  CURLIST="${CURLIST}<item icon=\"${ONEITEM}\">${ONEITEM}</item>"
 fi
 LISTHEIGHT=$((LISTHEIGHT + 25))
done

[ $LISTHEIGHT -gt 550 ] && LISTHEIGHT=550
CURITEMS="  <tree>
  <label>Cursor theme</label>
    ${FIRSTITEM}
    <item icon=\"default_left_ptr\">ORIGINAL THEME</item>
    ${CURLIST}
    <variable>CHOOSECUR</variable>
    <height>${LISTHEIGHT}</height>
  </tree>"

if [ "$CURLIST" = "" ];then
 CURITEMS="<text use-markup=\"true\">
    <label>\"<b>You first need to install some cursor themes! For now, quit this program. Run the Puppy Package Manager and look in the 'Desktop' category</b>\"</label></text>"
fi

export PCUR_MAIN_DIALOG="
<window title=\"Pcur: select a cursor theme\">
  <vbox>
    <text use-markup=\"true\">
      <label>\"<b>You must restart X to use the new theme</b>\"</label>
    </text>
    <text><label>Choose one you like, click 'OK', close down all applications, then choose 'Restart X server' in the 'Shutdown' menu...</label></text>


    ${CURITEMS}

    <hbox>
     <button ok></button>
     <button cancel></button>
    </hbox>
  </vbox>
</window>
"
RETVARS="`gtkdialog3  $DBG --program=PCUR_MAIN_DIALOG`"

[ "$CURLIST" ] || exit
echo "$RETVARS"
eval "${RETVARS}"

[ "$EXIT" != "OK" ] && exit

[ "`echo "$CHOOSECUR" | grep 'CURRENT THEME'`" ] && exit #already current.

if [ "$CHOOSECUR" = "ORIGINAL THEME" ];then
 rm -f "$CURSOR_THEME_DIR"/default
 exit
fi

if test -d "$CURSOR_THEME_DIR"/default; then
[ -L "$CURSOR_THEME_DIR"/default ] || rmdir $VERB "$CURSOR_THEME_DIR"/default
fi

ln $VERB -snf $CHOOSECUR "$CURSOR_THEME_DIR"/default

if test "$CURSOR_THEME_DIR" != "$HOME/.icons"; then

 mkdir $VERB -p "$HOME"/.icons
 if test -d "$HOME"/.icons/default; then
 [ -L "$HOME"/.icons/default ] || rmdir $VERB "$HOME"/.icons/default
 fi

ln $VERB -snf "$CURSOR_THEME_DIR"/default "$HOME/.icons"/default
fi
