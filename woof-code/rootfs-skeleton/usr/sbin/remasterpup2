#!/bin/sh
#simple script to remaster the puppy live-cd.
#(c) Copyright 2006 Barry Kauler, www.puppyos.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#BK 9 oct 2007: updated for puppy v3.01.
#RE 9 apr 2008: v3.99 copy active post-install scripts
#v4.02 /lib/modules/firmware.dep.<kern>,DOTconfig-K<kern> moved to /etc/modules. ...um no mods this script.
#v411 update what gets copied from /root and /etc.
#v412 /etc/DISTRO_SPECS, renamed pup_xxx.sfs, pup_save.2fs etc.
#w001 pup files renamed to woof-555.sfs, woofsave.2fs (or similar).
#w018 april 2009: Woof-related fixes, new standardised package database format.
#w460 zdrv has new name format, ex zu500269.sfs.
#w482 shinobar: exclude /lib/modules/${KERNELVER}/initrd.
#v423 bugfix.
#v431 bugfixes.


###KRG Fr 31. Aug 23:34:58 GMT+1 2012



trap "exit 1" HUP INT QUIT KILL TERM


OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = "2" ] && set -x


Version='1.1'


usage(){
USAGE_MSG="
$0 [ PARAMETERS ]

-V|--version : showing version information
-H|--help : show this usage information

*******  *******  *******  *******  *******  *******  *******  *******  *******
$2
"
exit $1
}

[ "`echo "$1" | grep -wE "\-help|\-H"`" ] && usage 0
[ "`echo "$1" | grep -wE "\-version|\-V"`" ] && { echo "$0 -version $Version";exit 0; }



###KRG Fr 31. Aug 23:34:58 GMT+1 2012

export LANG=C #faster, plus Xdialog happier.
KERNELVER=`uname -r`

#variables created at bootup by /initrd/usr/sbin/init...
. /etc/rc.d/PUPSTATE
[ "$PUP_LAYER" = "" ] && PUP_LAYER="/pup_ro2"
. /etc/DISTRO_SPECS
#PUPPYVERSION=`cat /etc/puppyversion`

PREFIX1CHAR=`echo -n "$DISTRO_FILE_PREFIX" | cut -c 1`
KERNEL3CHARS=`echo -n "$KERNELVER" | tr -d '.' | tr -d '\-' | tr -d '[a-z]' | rev | cut -c 1,2,3 | rev`
ZDRVSFS="z${PREFIX1CHAR}${DISTRO_VERSION}${KERNEL3CHARS}.sfs"

PPATTERN="/initrd${PUP_LAYER}"
if [ "`mount | grep "$PPATTERN"`" = "" ];then
 #no ${DISTRO_FILE_PREFIX}-xxx.sfs file mounted on pup_ro2, probably h.d. install...
 Xdialog --wrap --left --title "Puppy simple remaster CD: ERROR" --msgbox "This program requires a ${DISTRO_FILE_PREFIX}-$DISTRO_VERSION.sfs file mounted on /initrd${PUP_LAYER}.
Which is not the case here, probably because this is a full hard drive
installation? Whatever, boot Puppy from live-CD and then you will be able to
use this script.

Note, I have not tried it, but if you setup the situation of ${DISTRO_FILE_PREFIX}-$DISTRO_VERSION.sfs
mounted on directory /initrd${PUP_LAYER}, that will be acceptable for this program.
You will also need a current live-CD, as the program gets files off it.
Anyone want to try it?

Click 'Ok' button to quit..." 0 0
 exit
fi

SAVEPART="$PDEV1" #from PUPSTATE.
CDR="/dev/$SAVEPART"

#choose where to create isolinux-builds/ directory...
Xdialog --wrap --left --title "Puppy simple CD remaster" --msgbox "Welcome! This little program takes a snapshot of your current system and burns it to CD.

A Puppy live-CD has 4 main files: vmlinuz, isolinux.cfg, initrd.gz and ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs, where $DISTRO_VERSION is the current version number (without dots). Note, in some builds of Puppy there may also be a 5th file, ${ZDRVSFS}.

It is ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs that mainly interests us here: it has the entire Puppy filesystem, everything from '/' down. What this script does is rebuild this file ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs, with everything currently under '/' -- that is, all user-installed packages, all mounted .sfs extension files, everything, gets combined into one file, ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs and burnt to CD.
Note, if you have an 'underdog Linux' mounted, that too will get combined into the ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs file, so beware, it could get big!

Click OK button to continue (or close window to quit)..." 0 0

[ ! $? -eq 0 ] && exit

#calc size needed...
Xdialog --wrap --title "Puppy simple CD remaster" --msgbox "Calculating needed working space.\nPlease wait, this may take awhile..." 0 0 &
XPID=$!
SIZEOPT=0
SIZEBIN=`du -sk /bin | cut -f 1`
SIZESBIN=`du -sk /sbin | cut -f 1`
SIZELIB=`du -sk /lib | cut -f 1`
SIZEUSR=`du -sk /usr | cut -f 1`
[ -d /opt ] && SIZEOPT=`du -sk /opt | cut -f 1`
sync
kill $XPID
#SIZETOTALK=`expr $SIZEBIN + $SIZESBIN + $SIZELIB + $SIZEUSR + $SIZEOPT`
SIZETOTALK=`dc $SIZEBIN $SIZESBIN + $SIZELIB + $SIZEUSR + $SIZEOPT + p`
SIZETOTALM=`expr $SIZETOTALK \/ 1024`
echo "SIZETOTALM=$SIZETOTALM"
#estimate a compressed size...
SIZENEEDEDM=`expr $SIZETOTALM \/ 3`
SIZESLACKM=`expr $SIZENEEDEDM \/ 3` #guess
SIZENEEDEDM=`expr $SIZENEEDEDM + $SIZESLACKM`
SIZENEEDEDM=`expr $SIZENEEDEDM + 25` #space for vmlinuz, initrd.gz, zdrv, etc

#now choose working partition... v431 add ext4...
PARTSLIST=`probepart -m 2> /dev/null | grep '^/dev/' | grep --extended-regexp 'ext2|ext3|ext4|reiserfs|msdos|vfat|ntfs' | cut -f 1-3 -d '|'`

 echo -n "" > /tmp/schoices.txt
 echo "$PARTSLIST" |
 while read APART
 do
  [ "$APART" = "" ] && continue #v3.01 preaution
  MNTSTATUS='(currently mounted)'
  ATAG=`echo -n "$APART" | cut -f 1 -d '|' | cut -f 3 -d '/'`
  ASIZE=`echo -n "$APART" | cut -f 3 -d '|'`
  AFS=`echo -n "$APART" | cut -f 2 -d '|'`
  AFPATTERN="^/dev/$ATAG " #v3.01
  AFREE=`df -m | grep "$AFPATTERN" | tr -s " " | cut -f 4 -d " "`
  FLAG_RO='no' #v431
  if [ ! "$AFREE" ];then
   MNTSTATUS='(not mounted)'
   mkdir -p /mnt/$ATAG
   mount -t $AFS /dev/$ATAG /mnt/$ATAG > /dev/null 2>&1
   if [ $? -eq 0 ];then
    if [ "$ATAG" = "fd0" ];then
     FFREE=`df -k | grep "$AFPATTERN" | tr -s " " | cut -f 4 -d " "`
     AFREE=`dc $FFREE 1024 \/ p`
    else
     AFREE=`df -m | grep "$AFPATTERN" | tr -s " " | cut -f 4 -d " "`
    fi
    [ "`mount | grep "$AFPATTERN" | grep ' (rw'`" = "" ] && FLAG_RO='yes' #v431 make sure writable.
    umount /dev/$ATAG
   else #v431
    continue
   fi
  else
   [ "`mount | grep "$AFPATTERN" | grep ' (rw'`" = "" ] && FLAG_RO='yes' #v431 make sure writable.
  fi
  [ "$FLAG_RO" = "yes" ] && continue #v431
  [ "$AFS" ] && echo "${ATAG} \"Filesystem: $AFS  Size: ${ASIZE}M  Free: ${AFREE}M ${MNTSTATUS}\" \\" >> /tmp/schoices.txt #v3.01 added precaution.
 done
 SCHOICES=`cat /tmp/schoices.txt`

#add tmpfs ramdisk choice... ***v431 TODO: THIS SECTION MAY BE BROKEN***
SIZETMPFSM=`df -m | grep '^tmpfs' | grep '/initrd/pup_rw' | tr -s " " | cut -f 4 -d " "`
TMPFSMSG=''
if [ "$SIZETMPFSM" != "" ];then
 TOTALTMPFSM=`df -m | grep '^tmpfs' | grep '/initrd/pup_rw' | tr -s " " | cut -f 2 -d " "`
 if [ "$SCHOICES" = "" ];then #v3.01
  SCHOICES="ramdisk \"Filesystem: tmpfs  Size: ${TOTALTMPFSM}M  Free: ${SIZETMPFSM}M (currently mounted)\" \\"
 else
  SCHOICES="$SCHOICES
ramdisk \"Filesystem: tmpfs  Size: ${TOTALTMPFSM}M  Free: ${SIZETMPFSM}M (currently mounted)\" \\"
 fi
 TMPFSMSG='Note 2: you can use the tmpfs ramdisk, which is in RAM, if it has enough space.
'
fi

[ "$SCHOICES" = "" ] && exit #precaution.

 echo '#!/bin/sh' > /tmp/savedlg
 echo -n "Xdialog --wrap --stdout --left --title \"Puppy simple CD remaster\" --menubox \"A working area is required in which to create the new live-CD iso file.
Here are the available partitions. You must choose one that has at least ${SIZENEEDEDM}M free space on it. Also, if you choose to create an ISO file rather than burn direct to CD/DVD, then you will need an extra 100 - 200MB space (whatever the size of ISO file is going to be).

If the partition that you would like to use has less than ${SIZENEEDEDM}M free space on it, you will need to quit this script and delete some files.
Note 1: you can use a usb drive, but it needs to have been plugged in before
        running this script, so that it will get detected.
${TMPFSMSG}
Highlight desired choice then click OK button...\" 0 0 5 " >> /tmp/savedlg
 echo "$SCHOICES"  >> /tmp/savedlg
 echo ' > /tmp/tag.txt' >> /tmp/savedlg
 chmod 755 /tmp/savedlg

/tmp/savedlg
WKGPART=`cat /tmp/tag.txt`
echo "WKGPART=$WKGPART"
[ "$WKGPART" = "" ] && exit
#[ "$WKGPART" = "ramdisk" ] && WKGPART="tmpfs"

#copy files off live-cd.... w018 use probedisk2...
DRIVESFND=`probedisk2 2>&1`
#IDEDRVSFND=`test-eide 2>&1 | grep "cdrom"`
SELECTIONS=`echo "$DRIVESFND" | grep '^/dev/' | grep "|optical|" | cut -f 1,3 -d "|" | tr " " "_" | tr "|" " " | tr '$' "_"`
zSELECTIONS=`echo "$SELECTIONS" | tr '\n' ' '` #v431 bugfix.
#w018 does this work? change to eval... v423 bugfix...
XDLG="Xdialog --wrap --left --title \"Puppy simple CD remaster\" --stdout --menubox \"This remaster program needs to read some files off the current live-CD.
So, you need to choose a CD/DVD drive, and it must also be a burner drive (unless you choose only to create a .iso file and defer burning to another time) so that the files created by this program can be burnt to a new CD/DVD.
Choose the CD/DVD drive...\" 0 48 4 $zSELECTIONS 2> /dev/null"
BURNERDRV=`eval "$XDLG"` #w018 v423
[ $? -ne 0 ] && exit
[ "$BURNERDRV" = "" ] && exit
BURNERDRV=`echo -n "$BURNERDRV" | cut -f 3 -d '/'`
echo "BURNERDRV=$BURNERDRV" #TEST

CDPATTERN="/dev/$BURNERDRV "
CDMNTPT=`mount | grep "$CDPATTERN" | tr -s " " | cut -f 3 -d " "`
if [ "$CDMNTPT" != "" ];then
 if [ ! -f $CDMNTPT/initrd.gz ];then
  fuser -k -m /dev/$BURNERDRV
  sync
  umount /dev/$BURNERDRV 2> /dev/null
  if [ $? -ne 0 ];then
   Xdialog --title "ERROR" --msgbox "Mounted CD, get rid of it before running this program!" 0 0
   exit
  fi
  CDMNTPT=""
 fi
fi

if [ "$CDMNTPT" = "" ];then
 while [ 1 ];do
 Xdialog --wrap --title "Puppy simple CD remaster" --msgbox "Please insert the current Puppy live-CD into drive $BURNERDRV.
Then click OK..." 0 0
 #now mount it...
 CDMNTPT="/mnt/$BURNERDRV"
 mkdir -p /mnt/$BURNERDRV
 mount -t iso9660 /dev/$BURNERDRV /mnt/$BURNERDRV
 [ $? -eq 0 ] && break
 done
fi

#now get the files off it...
#firstly need working place to write to...
[ "$WKGPART" = "ramdisk" ] && WKGMNTPT="/"
WPATTERN="/dev/$WKGPART "
[ "$WKGMNTPT" = "" ] && WKGMNTPT=`mount | grep "$WPATTERN" | tr -s " " | cut -f 3 -d " "`
#[ "$WKGMNTPT" = "/initrd/pup_rw" ] && WKGMNTPT="/"
if [ "$WKGMNTPT" = "" ];then
 PPATTERN="^$WKGPART "
 WKGFS=`echo "$SCHOICES" | grep "$PPATTERN" | cut -f 2 -d ':' | cut -f 2 -d " "`
 [ "$WKGFS" = "msdos" ] && WKGFS="vfat"
 mkdir -p /mnt/$WKGPART
 mount -t $WKGFS /dev/$WKGPART /mnt/$WKGPART
 [ $? -ne 0 ] && exit #precaution.
 WKGMNTPT="/mnt/$WKGPART"
fi
[ "$WKGMNTPT" = "/" ] && WKGMNTPT=""

Xdialog --wrap --title "Puppy simple CD remaster" --msgbox "Copying files from CD to $WKGMNTPT/puppylivecdbuild/, please wait..." 0 0 &
XPID=$!
rm -rf $WKGMNTPT/puppylivecdbuild #precaution
mkdir $WKGMNTPT/puppylivecdbuild
#now copy the files...
   sync
   cp $CDMNTPT/isolinux.bin $WKGMNTPT/puppylivecdbuild/
   sync
   cp $CDMNTPT/isolinux.cfg $WKGMNTPT/puppylivecdbuild/
   sync
   cp $CDMNTPT/boot.msg $WKGMNTPT/puppylivecdbuild/ 2> /dev/null
   sync
   cp $CDMNTPT/help.msg $WKGMNTPT/puppylivecdbuild/ 2> /dev/null #v431
   sync
   cp $CDMNTPT/goofy.16 $WKGMNTPT/puppylivecdbuild/ 2> /dev/null
   sync
   cp $CDMNTPT/logo.16 $WKGMNTPT/puppylivecdbuild/ 2> /dev/null #v431
   sync
   cp $CDMNTPT/vmlinuz $WKGMNTPT/puppylivecdbuild/
   sync
   cp $CDMNTPT/initrd.gz $WKGMNTPT/puppylivecdbuild/
   sync
   #v2.12...
   [ -f $CDMNTPT/${ZDRVSFS} ] && cp -af $CDMNTPT/${ZDRVSFS} $WKGMNTPT/puppylivecdbuild/
   sync

umount /dev/$BURNERDRV 2> /dev/null

kill $XPID
Xdialog --left --title "Puppy simple CD remaster" --msgbox "Creating the ${DISTRO_FILE_PREFIX}-$DISTRO_VERSION.sfs file in $WKGMNTPT/puppylivecdbuild/.
This can take quite a long time, so please wait.... and wait...
Note, no need to click the OK button, as this window will disappear
when ${DISTRO_FILE_PREFIX}-$DISTRO_VERSION.sfs is finally created.
Please wait..." 0 0 &
XPID=$!

#create new ${DISTRO_FILE_PREFIX}-xxx.sfs file...
DIRHOME=""
[ -d /home ] && DIRHOME="/home"
[ -d /sys ] && DIRSYS="/sys"
[ -d /lost+found ] && DIRLOST="/lost+found"
rm -f ${WKGMNTPT}/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}*.sfs 2> /dev/null
sync
#note, /${DISTRO_FILE_PREFIX}-$DISTRO_VERSION.sfs is not normally there, i relocated it to a separate tmpfs,
#however have not yet done that for multisession-cd/dvd (PUPMODE=77).
#note, /home could be in underdog linux...
#w482 shinobar: exclude /lib/modules/${KERNELVER}/initrd...
INITRDMODS=""
[ -d /lib/modules/${KERNELVER}/initrd ] && INITRDMODS="/lib/modules/${KERNELVER}/initrd" #v431
mksquashfs / $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -e /etc /proc /initrd /var /tmp /archive /mnt /root /puppylivecdbuild $DIRHOME $DIRSYS $DIRLOST /${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs ${INITRDMODS}
sync

#add pristine folders (out of current ${DISTRO_FILE_PREFIX}_xxx.sfs)...
mksquashfs /initrd${PUP_LAYER}/proc $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync
mksquashfs /initrd${PUP_LAYER}/tmp $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync
mksquashfs /initrd${PUP_LAYER}/mnt $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync

kill $XPID

#######START WORKING ON /root#######
rm -rf /tmp/root 2> /dev/null
#do some work on /root before add it to the squashfs...
cp -a /initrd${PUP_LAYER}/root /tmp/root #pristine /root
#copy all of my-applications/
cp -af /root/my-applications/* /tmp/root/my-applications/
#some dotpups get installed here...
cp -af /root/my-roxapps /tmp/root/ 2>$ERR
#window manager config files...
cp -af /root/.jwmrc /tmp/root/
cp -af /root/.jwmrc-tray /tmp/root/ #v411
cp -af /root/.fvwm95rc /tmp/root/
cp -af /root/.icewm/menu /tmp/root/.icewm/
#rox desktop settings...
cp -af /root/Choices/ROX-Filer/PuppyPin /tmp/root/Choices/ROX-Filer/
cp -af /root/Choices/ROX-Filer/globicons /tmp/root/Choices/ROX-Filer/
#v411 tidy up, remove desktop drive icons...
grep -v '/root/.pup_event/drive_' /tmp/root/Choices/ROX-Filer/PuppyPin > /tmp/remaster-PuppyPin
mv -f /tmp/remaster-PuppyPin /tmp/root/Choices/ROX-Filer/PuppyPin
#this may have been modified for a different w.m...
cp -af /root/.xinitrc /tmp/root/
#also this...
[ -f /root/.xset.sh ] && cp -af /root/.xset.sh /tmp/root/

#v411 gtk theme may have been changed...
cp -af /root/.gtkrc-2.0 /tmp/root/

#v411 jwm theme may have changed...
cp -af /root/.jwm/jwm_colors /tmp/root/.jwm/
cp -af /root/.jwm/jwmrc-personal /tmp/root/.jwm/
cp -af /root/.jwm/jwmrc-personal2 /tmp/root/.jwm/
cp -af /root/.jwm/jwmrc-theme /tmp/root/.jwm/

#v411 pmount preferences...
cp -af /root/.pmountauto /tmp/root/
cp -af /root/.pmountengine /tmp/root/
cp -af /root/.pmountquit /tmp/root/
cp -af /root/.pmountsingle /tmp/root/

#TODO think need to do this for /var also...

#.packages/ .files, copy any files installed to /root...
echo -n "" > /tmp/allpkgs.files
for ONEPKG in `ls -1 /root/.packages/*.files 2>/dev/null | tr "\n" " "`
do
 for ONEFILE in `cat $ONEPKG | grep '^/root/' | tr "\n" " "`
 do
  if [ -d $ONEFILE ];then #w018
   mkdir -p /tmp$ONEFILE
  fi
  if [ -f $ONEFILE ];then #w018
   DIRNAME=`dirname $ONEFILE`
   mkdir -p /tmp$DIRNAME
   cp -a -f $ONEFILE /tmp$DIRNAME/
  fi
 done
done

#w018...
#modify /root/.packages/ files, as all installed packages are now part of the new cd...
cp -a -f /root/.packages /tmp/root/
touch /root/.packages/user-installed-packages
cat /root/.packages/user-installed-packages >> /tmp/root/.packages/woof-installed-packages
sort -u /tmp/root/.packages/woof-installed-packages > /tmp/woof-installed-packages-tmp #v431
mv -f /tmp/woof-installed-packages-tmp /tmp/root/.packages/woof-installed-packages
echo -n "" > /tmp/root/.packages/user-installed-packages #v431


Xdialog --left --title "Puppy simple remaster CD" --msgbox "This program has created folder /tmp/root, which has everything that is now
going to be added as /root in the ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs file.
This is mostly 'pristine', as obviously you do not want all your cache files,
temp files, email files, and other working/temporary files to be burnt onto
the CD. However, if you are familiar with the workings of Puppy, you might
like to take a look at /tmp/root right now, and possibly add anything that
you want from /root (or remove something!)
(if you think that this program has missed out something important that
 should be burnt into /root on the CD, please let me know -- Barry Kauler)

After examining /tmp/root,
click 'Ok' to add /root in ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs file..." 0 0
sync
mksquashfs /tmp/root $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync
rm -rf /tmp/root
#######END WORKING ON /root#######

#######START WORKING ON /etc#######
rm -rf /tmp/etc 2> /dev/null
#do some work on /etc before add it to the .sfs...
cp -a /initrd${PUP_LAYER}/etc /tmp/etc #pristine /etc.
#maybe this has been modified...
cp -af /etc/ld.so.conf /tmp/etc/
#firmware tarballs may install these scripts...
cp -af /etc/init.d/* /tmp/etc/init.d/   #3.99

#.packages/ .files, copy any files installed to /etc...
echo -n "" > /tmp/allpkgs.files
for ONEPKG in `ls -1 /root/.packages/*.files 2>/dev/null | tr "\n" " "`
do
 for ONEFILE in `cat $ONEPKG | grep '^/etc/' | tr "\n" " "`
 do
  if [ -d $ONEFILE ];then #w018
   mkdir -p /tmp$ONEFILE
  fi
  if [ -f $ONEFILE ];then #w018
   DIRNAME=`dirname $ONEFILE`
   mkdir -p /tmp$DIRNAME
   cp -a -f $ONEFILE /tmp$DIRNAME/
  fi
 done
done
sync

cp -af /etc/eventmanager /tmp/etc/ #v411

#what about settings for a particular pc?...
MSG1="Hardware customisation was not chosen."
Xdialog --left --title "Puppy simple remaster CD" --yesno "Have created the /etc directory for the new ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs file.
It is in a 'pristine' state, but you can choose to customise it.
Do you want to add customisations for your hardware? Examples are
mouse, keyboard, video. But, if you answer 'Yes' here, the live-CD
will be preconfigured for your PC only. Therefore, it is best to
answer 'No' if you want to boot the new live-CD on different PCs.

Click 'Yes' button to customise /etc...
Click 'No' button not to customise (recommended)..." 0 0
if [ $? -eq 0 ];then
 cp -af /etc/codepage /tmp/etc/
 cp -af /etc/fontmap /tmp/etc/
 cp -af /etc/keyboardtype /tmp/etc/
 cp -af /etc/keymap /tmp/etc/
 cp -af /etc/mousebuttons /tmp/etc/
 cp -af /etc/mousedevice /tmp/etc/
 cp -af /etc/videomode /tmp/etc/
 cp -af /etc/eth0mode /tmp/etc/
 cp -af /etc/eth1mode /tmp/etc/
 cp -af /etc/resolv.conf /tmp/etc/
 rm -f /tmp/etc/localtime #a symlink
 cp -af /etc/localtime /tmp/etc/
 cp -af /etc/TZ /tmp/etc/
 cp -af /etc/cdburnerdevice /tmp/etc/
 cp -af /etc/dvddevice /tmp/etc/
 cp -af /etc/modemdevice /tmp/etc/
 cp -af /etc/securetelnetrc /tmp/etc/
 cp -af /etc/modules.conf /tmp/etc/
 cp -af /etc/modprobe.conf /tmp/etc/
 cp -af /etc/rdesktoprc /tmp/etc/
 cp -af /etc/windowmanager /tmp/etc/
 cp -af /etc/xextraoptions /tmp/etc/
 cp -af /etc/X11/xorg.conf /tmp/etc/X11
 cp -af /etc/network-wizard /tmp/etc/
 MSG1="These files were customised in /etc:
codepage fontmap keyboardtype keymap mousebuttons mousedevice videomode
eth0mode eth1mode resolv.conf localtime TZ cdburnerdevice dvddevice modemdevice
securetelnetrc modprobe.conf rdesktoprc windowmanager xextraoptions X11/xorg.conf
and directory network-wizard."
fi

#some files to always copy...
#cp -af /etc/Puppybackgroundcolor /tmp/etc/
cp -af /etc/Puppybackgroundpicture /tmp/etc/
#TODO: other gtk and jwm customisations.

Xdialog --left --title "Puppy simple remaster CD" --msgbox "$MSG1

If you know what you are doing, you can now modify any files in /tmp/etc
folder. This is just about to be added to /etc in the .sfs file.
Do anything you want before clicking 'Ok'.
(If this program has missed something important, let me know -- Barry Kauler)

Click 'Ok' to add /etc in ${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs file..." 0 0

sync
mksquashfs /tmp/etc $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync
rm -rf /tmp/etc
#######END WORKING ON /etc#######

#######START WORKING ON /var#######
rm -rf /tmp/var 2> /dev/null
cp -a /initrd${PUP_LAYER}/var /tmp/var #pristine var

#.packages/ .files, copy any files installed to /var...
echo -n "" > /tmp/allpkgs.files
for ONEPKG in `ls -1 /root/.packages/*.files 2>/dev/null | tr "\n" " "`
do
 for ONEFILE in `cat $ONEPKG | grep '^/var/' | tr "\n" " "`
 do
  if [ -d $ONEFILE ];then #w018
   mkdir -p /tmp$ONEFILE
  fi
  if [ -f $ONEFILE ];then #w018
   DIRNAME=`dirname $ONEFILE`
   mkdir -p /tmp$DIRNAME
   cp -a -f $ONEFILE /tmp$DIRNAME/
  fi
 done
done
sync

sync
mksquashfs /tmp/var $WKGMNTPT/puppylivecdbuild/${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.sfs -keep-as-directory
sync
rm -rf /tmp/var
#######END WORKING ON /var#######


#edit isolinux.cfg...
ISOLINUXCFG=`cat $WKGMNTPT/puppylivecdbuild/isolinux.cfg`
#small tweaks, like acpi=on, ide=nodma...
Xdialog --wrap --left --title "Puppy simple remaster CD" --yesno "Almost ready to burn the CD!
All the files that will be burnt to CD are in $WKGMNTPT/puppylivecdbuild/.

The thing that you may want to do is edit isolinux.cfg. It has this:
$ISOLINUXCFG

'pmedia' parameter is a hint to Puppy what media you are booting Puppy from.
'pmedia=cd' means any CD/DVD drive. Other options are:
 usbflash usbhd usbcd ataflash atahd atacd atazip scsihd scsicd
 (where 'ata' means either IDE or SATA interface, i.e. an internal drive)

'pkeys' is the default keyboard layout. Example: 'pkeys=us'  Choices are:
 be br cf de dk es fi fr gr hu it jp no pl ru se uk us
If you need more choices, the Keyboard Wizard has more, after bootup.

You may also add any kernel parameters. Some PCs require 'acpi=off' to boot properly.

(If answer 'Yes', an editor will appear, must exit
 editor before this program will continue)
Click 'Yes' button to edit isolinux.cfg..." 0 0
if [ $? -eq 0 ];then
 #leafpad $WKGMNTPT/puppylivecdbuild/isolinux.cfg
 #gtk-shell -t "$WKGMNTPT/puppylivecdbuild/isolinux.cfg" -ef "$WKGMNTPT/puppylivecdbuild/isolinux.cfg"
 #sync
 defaulttexteditor $WKGMNTPT/puppylivecdbuild/isolinux.cfg
fi
sync

Xdialog --left --title "Puppy simple remaster CD" --msgbox "Almost ready to burn the CD!
All the files that will be burnt to CD are in $WKGMNTPT/puppylivecdbuild/.

If you want to add any more files, say extra SFS files, or to edit or modify the
files in any way, do it now. Note, if you add an extra SFS file, say 'devx_555.sfs'
then it will be available for use when you boot the new live-CD.

If you want to make any changes, use ROX-Filer to open $WKGMNTPT/puppylivecdbuild/
and do so now, before clicking the OK button." 0 0
sync

#build new iso file, or direct burn to cd...
#to save space, burn direct from $WKGMNTPT/puppylivecdbuild/ to cd...
Xdialog --wrap --left --title "Puppy simple remaster CD" --yesno "All the files that will be burnt to CD/DVD are in $WKGMNTPT/puppylivecdbuild/.

As the working partition may have limited space (for example, you are using a USB pen drive), these files are burnt direct to CD/DVD, rather than create an intermediary iso file. If you do need an iso file, you can copy it from the CD afterward (dd if=/dev/$BURNERDRV of=puppy.iso seek=0 bs=32k).

However, if you just want to create an iso file now and not burn to CD/DVD, click the 'No' button.

Click 'No' button (or close-box on window) to quit program at this point (leaving  $WKGMNTPT/puppylivecdbuild/ files in existence), and further option to create an iso file...
Click 'Yes' button to burn to CD/DVD..." 0 0

if [ ! $? -eq 0 ];then
 Xdialog --wrap --left --title "Puppy simple remaster CD" --yesno "Click 'Yes' button to create a 'custom-puppy-${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.iso' in ${WKGMNTPT}/ (assuming that there is 100MB-200MB free space)...
Click 'No' button (or close-box on window) to quit program at this point (leaving  ${WKGMNTPT}/puppylivecdbuild/ files in existence)..." 0 0
 if [ $? -eq 0 ];then
  #cd $WKGMNTPT
  rxvt -bg orange -title "Puppy simple remaster CD" -e mkisofs -D -R -o $WKGMNTPT/custom-puppy-${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.iso -b isolinux.bin -c boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table $WKGMNTPT/puppylivecdbuild/
 fi
 sync
 Xdialog --wrap --left --title "Puppy simple remaster CD" --msgbox "$WKGMNTPT/custom-puppy-${DISTRO_FILE_PREFIX}-${DISTRO_VERSION}.iso created.
$WKGMNTPT/puppylivecdbuild/ files left in existence.
Click 'Ok' button to quit..." 0 0
 exit
fi

if [ "`echo "$BURNERDRV" | grep 'hd'`" != "" ];then
 DEVDEV="ATAPI:/dev/$BURNERDRV"
else
 DEVDEV="/dev/$BURNERDRV"
fi

#now for the actual burn...
CDCHOICE="`Xdialog --wrap --left --stdout --title \"Puppy simple remaster CD\" --menubox \"Please choose the media to burn to.
The burner drive is /dev/$BURNERDRV, and obviously it must be able to burn a DVD if you want to burn a DVD!

Note, you can later use the 'dd' program to create an iso file:
 # dd if=/dev/$BURNERDRV of=puppy.iso seek=0 bs=32k

PLEASE INSERT THE NEW CD OR DVD RIGHT NOW, THEN CHOOSE FROM MENU...\" 0 0 4 CD-R \"New blank recordable CD\" DVD-R \"New blank DVD-R (not +R, -RW, +RW)\"`"

echo '#!/bin/sh' > /tmp/new2cd.sh
if [ "`echo "$CDCHOICE" | grep 'DVD'`" = "" ];then
 #burn to CD...
 echo "mkisofs -D -R -quiet -b isolinux.bin -c boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table $WKGMNTPT/puppylivecdbuild/ | cdrecord -multi -tao -pad -data -v speed=4 gracetime=2 dev=$DEVDEV  -" >> /tmp/new2cd.sh
else
 echo "growisofs -speed=4 -Z /dev/$BURNERDRV -R -D -quiet -b isolinux.bin -c boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table $WKGMNTPT/puppylivecdbuild/" >> /tmp/new2cd.sh
fi
echo 'echo -n "Finished. Press ENTER key to continue: "' >> /tmp/new2cd.sh
echo 'read nippi'  >> /tmp/new2cd.sh
chmod 755 /tmp/new2cd.sh
rxvt -bg orange -title "Puppy simple remaster CD" -e /tmp/new2cd.sh

sync
rm -rf /puppylivecdbuild
rm -rf $WKGMNTPT/puppylivecdbuild
sync
umount /dev/$WKGPART

eject /dev/$BURNERDRV

Xdialog --wrap --left --title "Puppy simple remaster CD" --msgbox "You should now have a new custom Puppy live-CD!

WARNING:
There is a tricky situation here, as all the installed packages (plus anything else that you may have installed, such as loaded .sfs extension files, have all been burnt to CD/DVD).
But, they are still installed in the current ${DISTRO_FILE_PREFIX}save.2fs, the Puppy persistent storage file (where all your stuff gets saved, so it is there next time Puppy is booted). All those files are duplicated, but will that do any harm if you boot the new CD? ...should be okay, but I recommend that you uninstall as much as possible right now, before booting the new CD. Note, do not uninstall them after booting the new CD as that will also 'delete' the packages burnt onto the CD.

Or, easiest and cleanest option, boot Puppy with 'pfix=ram' boot parameter then at shutdown create a brand new '${DISTRO_FILE_PREFIX}save' file. In fact, this is the wisest thing to do regardless, as you don't even know if the custom CD is going to work properly -- so it is best to bootup in ram only to find out!" 0 0


####THE END######
