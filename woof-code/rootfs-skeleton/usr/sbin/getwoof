#!/bin/sh
#120801 download Woof.
# This code is clumsy, had to checkout, then set some parameters in repo, then erase and checkout again.
# One optional parameter, 'update'.

  _TITLE_=pup_get_woof
_COMMENT_="CLI to download or update woof from http://bkhome.org/fossil/woof2"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST="update"
ADD_PARAMETERS="update :update 'woofx.fossil'"
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="Script to download woof from  http://bkhome.org/fossil/woof2.
Current directory must be in a Linux filesystem.
The Woof repository will be downloaded as file 'woofx.fossil' and
checked-out into directory 'woofx'.
Option passed parameter 'update' will update 'woofx.fossil' from the
online Woof repository and update files in 'woofx' directory."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
    for i in `seq 1 1 $DO_SHIFT`; do shift; done; }
_trap
}

if [ $1 ];then
 case $1 in
  *update)
   [ ! -d woofx ] && exit 2
   cd woofx
   fossil status >$OUT
   [ $? -ne 0 ] && fossil open ../woofx.fossil
   fossil update
   [ $? -ne 0 ] && exit 3
  ;;
  *help)
   echo "Current directory must be in a Linux filesystem."
   echo "The Woof repository will be downloaded as file 'woofx.fossil' and"
   echo "checked-out into directory 'woofx'."
   echo "Option passed parameter 'update' will update 'woofx.fossil' from the
online Woof repository and update files in 'woofx' directory."
  ;;
 esac
 exit 0
fi

if [ -d woofx ];then
 cd woofx
 fossil close --force 2>$ERR
 cd ..
 rm -rf woofx
fi
rm -f woofx.fossil   2>$ERR
rm -f Woof2-*.tar.gz 2>$ERR
rm -rf Woof2-*       2>$ERR
sync

fossil clone --admin-user MrSmith http://bkhome.org/fossil/woof2.cgi woofx.fossil
sync

mkdir -p woofx

cd woofx
fossil open ../woofx.fossil
fossil setting allow-symlinks yes
fossil setting editor defaulttexteditor
fossil setting web-browser defaultbrowser
fossil setting dont-push yes #prevent pushing to online repo.
fossil setting autosync no
sync
fossil close
if [ ! -f merge2out ];then
 echo "There has been an error downloading the Woof repository, aborting."
 exit 1
fi
cd ..

rm -rf woofx/*
sync
cd woofx
fossil open ../woofx.fossil
sync
echo "Success."
exit 0
