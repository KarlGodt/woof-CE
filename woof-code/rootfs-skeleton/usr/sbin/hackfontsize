#!/bin/sh
#(c) Copyright Barry Kauler March 2013, bkhome.org.
#License GPL3 2013 (see /usr/share/doc/legal).
# Hack to fix font sizes. Puppy has moved from 78 to 96 dpi.
# Can be called from a running puppy, standalone, from ppm, or from woof.
# Called from 3builddistro (woof), or /usr/local/petget/hacks-postinstall.sh.
#130326 first release.
#130329 changed stat --format=%Y to stat -c %Y, so busybox applet will work.

  _TITLE_="pup_hack_fontsize.sh"
_COMMENT_="CLI to fix fonsize entry in vorious configuration files"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST="GTKRCS=/path/to/file"
ADD_PARAMETERS="GTKRCS=/path/to/file: PPM only."
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="Parse /root/.Xresources for Xft.dpi entry
and modify windowmanager and GTK configuration files.
Used normal, by woof, or PPM .
PPM adds PARAMETER GTKRCS=/path/to/file ."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
    for i in `seq 1 1 $DO_SHIFT`; do shift; done; }
_trap
}

GTKRCS=""
JWMTHEMES=""
ROXPREFIX=""
RUNNINGIN="standalone"
[ -d ../rootfs-skeleton ] && [ -d rootfs-complete ] && RUNNINGIN="woof"
[ $1 ] && RUNNINGIN="single" #maybe from ppm when install a package.
case $RUNNINGIN in
 standalone) #execute in a running puppy, no passed param.
  GTKRCS="`ls /usr/share/themes/*/gtk-2.0/gtkrc | grep -v ' '`"
  XRESFILE="/root/.Xresources"
  JWMTHEMES="`ls /root/.jwm/themes/*-jwmrc`
/root/.jwm/jwmrc-theme"
  ROXPREFIX="/"
 ;;
 woof)
  #can be run in Woof, called from 3builddistro...
  GTKRCS="`ls rootfs-complete/usr/share/themes/*/gtk-2.0/gtkrc | grep -v ' '`"
  XRESFILE="rootfs-complete/root/.Xresources"
  JWMTHEMES="`ls rootfs-complete/root/.jwm/themes/*-jwmrc`
rootfs-complete/root/.jwm/jwmrc-theme"
  ROXPREFIX="rootfs-complete/"
 ;;
 single) #called from ppm.
  eval "$@" #ex: GTKRCS=/usr/share/themes/Citrus/gtk-2.0/gtkrc
  XRESFILE="/root/.Xresources"
 ;;
esac
JWMPREFIX="$ROXPREFIX"

XFTDPI=`grep '^Xft.dpi:' ${XRESFILE} | tr '\t' ' ' | tr -s ' ' | cut -f 2 -d ' '`
if [ $XFTDPI -ge 96 ];then

 if [ "$GTKRCS" ];then
  #fix gtk2 themes...
  for aGTKRC in $GTKRCS
  do
   echo -n "" > /tmp/agtkthemefixed
   MODIFYSECS=`stat -c %Y $aGTKRC` #130329
   #only hack old themes...
   if [ $MODIFYSECS -lt 1364287598 ];then #2013, March 26, 4.47pm
    echo "Fixing: ${aGTKRC}"
    cat ${aGTKRC} |
    while read aLINE
    do
     aLINEx="$(echo -n "$aLINE" | sed -e 's%Sans 11%Sans 9%' -e 's%Sans 12%Sans 10%' -e 's%Sans 13%Sans 11%' -e 's%Sans 14%Sans 12%')"
     echo "$aLINEx" >> /tmp/agtkthemefixed
    done
    sync
    cp -f /tmp/agtkthemefixed ${aGTKRC}
   fi
  done
 fi

 #fix jwm themes...
 if [ "$JWMTHEMES" ];then
  for aJWMTHEME in $JWMTHEMES
  do
   echo -n "" > /tmp/ajwmthemefixed
   MODIFYSECS=`stat -c %Y ${aJWMTHEME}` #130329
   if [ $MODIFYSECS -lt 1364287598 ];then #2013, March 26, 4.47pm
    echo "Fixing: ${aJWMTHEME}"
    cat $aJWMTHEME |
    while read aLINE
    do
     aLINEx="$(echo -n "$aLINE" | sed -e 's%Sans-11%Sans-9%' -e 's%Sans-12%Sans-10%' -e 's%Sans-13%Sans-11%' -e 's%Sans-14%Sans-12%' -e 's%Sans-15%Sans-13%' -e 's%Sans-16%Sans-14%')"
     echo "$aLINEx" >> /tmp/ajwmthemefixed
    done
    sync
    cp -f /tmp/ajwmthemefixed $aJWMTHEME
   fi
  done
 fi

 if [ "$JWMPREFIX" ];then
  if [ -f ${JWMPREFIX}etc/xdg/templates/_root_.jwmrc ];then
   echo -n "" > /tmp/jwmrctemplatefixed
   MODIFYSECS=`stat -c %Y ${JWMPREFIX}etc/xdg/templates/_root_.jwmrc`
   if [ $MODIFYSECS -lt 1364287598 ];then #2013, March 26, 4.47pm
    echo "Fixing: ${JWMPREFIX}etc/xdg/templates/_root_.jwmrc"
    cat ${JWMPREFIX}etc/xdg/templates/_root_.jwmrc |
    while read aLINE
    do
     aLINEx="$(echo -n "$aLINE" | sed -e 's%Sans-11%Sans-9%' -e 's%Sans-12%Sans-10%' -e 's%Sans-13%Sans-11%' -e 's%Sans-14%Sans-12%' -e 's%Sans-15%Sans-13%' -e 's%Sans-16%Sans-14%')"
     echo "$aLINEx" >> /tmp/jwmrctemplatefixed
    done
    sync
    cp -f /tmp/jwmrctemplatefixed ${JWMPREFIX}etc/xdg/templates/_root_.jwmrc
    if [ "$RUNNINGIN" = "standalone" ];then
     fixmenus
     #jwm -restart
    fi
   fi
  fi
 fi

 #fix rox-filer...
 if [ "$ROXPREFIX" ];then
  echo -n "" > /tmp/aroxthemefixed
  if [ -f ${ROXPREFIX}root/.config/rox.sourceforge.net/ROX-Filer/Options ];then
   MODIFYSECS=`stat -c %Y ${ROXPREFIX}root/.config/rox.sourceforge.net/ROX-Filer/Options`
   if [ $MODIFYSECS -lt 1364287598 ];then #2013, March 26, 4.47pm
    echo "Fixing: ${ROXPREFIX}root/.config/rox.sourceforge.net/ROX-Filer/Options"
    cat ${ROXPREFIX}root/.config/rox.sourceforge.net/ROX-Filer/Options |
    while read aLINE
    do
     aLINEx="$(echo -n "$aLINE" | sed -e 's%Sans 11%Sans 9%' -e 's%Sans 12%Sans 10%' -e 's%Sans 13%Sans 11%' -e 's%Sans 14%Sans 12%')"
     echo "$aLINEx" >> /tmp/aroxthemefixed
    done
    sync
    cp -f /tmp/aroxthemefixed ${ROXPREFIX}root/.config/rox.sourceforge.net/ROX-Filer/Options
   fi
  fi
 fi

 if [ "$RUNNINGIN" = "standalone" ];then
  echo "Please restart X to see changes."
 fi

fi

###END###
