#!/bin/sh
#BK called from udev rule in /etc/udev/rules.d/52-usb_modem_puppy.rules
#120109 usb_modeswitch 1.2.1: my optus 3g modem, not creating /dev/gsmmodem. call usb_modeswitch_status to do all the work.

  _TITLE_=usb_modem_special_status
_VERSION_=1.0omega
_COMMENT_="Wrapper for usb_modeswitch_status"

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST="PARAM1"
ADD_PARAMETERS="PARAM1 : 3g , else do nothing"
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="UDEV helper script for 3G modems.
Just calls usb_modeswitch_status ."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

#some variables passed in:
#ACTION=add
#DEVLINKS=/dev/gsmmodem
#DEVNAME=/dev/ttyUSB0
#DEVPATH=/devices/pci0000:00/0000:00:1d.7/usb1/1-2/1-2:1.0/ttyUSB0/tty/ttyUSB0
#MAJOR=188
#MINOR=0
#SEQNUM=3815
#SUBSYSTEM=tty

#if [ "$DEVLINKS" = "/dev/gsmmodem" ];then
##if [ -e /dev/gsmmodem ];then
# killall yaf-splash
# DISPLAY=":0" yaf-splash -placement center -close never -bg green -fontsize large -timeout 5 -text "USB Modem ready for use" &
#else
# if pidof yaf-splash ;then exit ;fi
# DISPLAY=":0" yaf-splash -placement center -close never -bg yellow -fontsize large -timeout 30 -text "USB Modem inserted, please wait, configuring..." &
#fi

PARAM1=""
[ $1 ] && PARAM1="$1"

if [ "$PARAM1" = "3g" ];then #120109 3g: see 52-usb_modem_puppy.rules
 #just go to normal status script...
 echo "Mode switching was successful" > /var/log/usb_modeswitch_special_status #read by usb_modeswitch_status
 #do not use 'exec' as udev calls this script multiple times and it must complete. but,
 #usb_modeswitch_status has a lock region that prevents near-simultaneous multiple instances, but need
 #to also do a running-check here first...
 [ "`/bin/pidof usb_modeswitch_status`" = "" ] && /usr/sbin/usb_modeswitch_status &
fi
# Very End of this file 'usr/sbin/usb_modem_special_status' #
###END###
