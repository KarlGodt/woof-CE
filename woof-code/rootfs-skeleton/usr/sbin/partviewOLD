#!/bin/sh
#Barry Kauler 2009. A first go, not very efficient generating gif images.
#v431 clarf: bugfix, old kernel without libata drivers.


  _TITLE_=Partition_Viewer
_COMMENT_="Show Partitions and Sizes"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

DISKLIST="`probedisk2`"
PARTSLIST="`probepart -k 2> /dev/null | grep '^/dev/' | grep -E 'iso9660|ext2|ext3|ext4|reiserfs|msdos|vfat|ntfs|minix' | cut -f 1-3 -d '|'`"

PARTINFO="<hbox><text><label>Free</label></text><pixmap><input file>/tmp/partview_top.gif</input></pixmap></hbox>"

if [ ! -f /tmp/partview_top.gif ];then
 ppmrough -width 100 -height 16 -var 1 -bg red -fg grey80 -left 0 | ppmlabel -background transparent -color red -size 10 -y 13 -x 0 -text "Used" -background transparent -color red -size 10 -y 13 -x 1 -text "Used" | ppmtogif > /tmp/partview_top.gif
fi

xmessage -center -bg orange -buttons "" "Please wait, processing..." &
XPID=$!

for aPART in $PARTSLIST
do
 MNTSTATUS='(currently mounted)'
 aTAG="`echo -n "$aPART" | cut -f 1 -d '|' | cut -f 3 -d '/'`"
 aSIZE=`echo -n "$aPART" | cut -f 3 -d '|'`
 if [ -e /proc/ide ];then #v431 old kernel without libata drivers.
  aTIPE=`echo -n "$aPART" | cut -f 2 -d '|'`
  case $aTIPE in
   iso*)
    aSIZE=4300000
    [ "`dvd+rw-mediainfo /dev/${aTAG} 2>&1 | grep 'non-DVD'`" != "" ] && aSIZE=700000
   ;;
  esac
 else
  case $aTAG in
   sr*)
    aSIZE=4300000
    [ "`dvd+rw-mediainfo /dev/${aTAG} 2>&1 | grep 'non-DVD'`" != "" ] && aSIZE=700000
   ;;
  esac
 fi
 aFS="`echo -n "$aPART" | cut -f 2 -d '|'`"
 aFPATTERN="^/dev/$aTAG "
 aUSED=`df -k | grep "$aFPATTERN" | tr -s " " | cut -f 3 -d " "`
 if [ ! "$AUSED" ];then
  MNTSTATUS='(not mounted)'
  mkdir -p /mnt/$aTAG
  mount -t $aFS /dev/$aTAG /mnt/$aTAG >$OUT 2>$ERR
  if [ $? -eq 0 ];then
   aUSED=`df -k | grep "$aFPATTERN" | tr -s " " | cut -f 3 -d " "`
   umount /dev/$aTAG
  else
   continue
  fi
 fi
 #[ "$aFS" ] && echo "${aTAG} \"Filesystem: $aFS  Size: ${aSIZE}M  Free: ${aFREE}M ${MNTSTATUS}\" \\" >> /tmp/schoices.txt #v3.01 added precaution.
 aFREE=`expr $aSIZE - $aUSED`
 naUSED=`expr 100 \* $aUSED \/ $aSIZE` #normalise.
 #process size...
 if [ $aFREE -gt 1048576 ];then #1024*1024
  oneSIZE="`dc $aFREE 1048576 \/ p`"
  oneSIZE="`printf "%.1f" $oneSIZE`G"
 else
  if [ $aFREE -gt 99 ];then
   oneSIZE="`expr $aFREE \/ 1024`M"
  else
   oneSIZE="`dc $aFREE 1024 \/ p`"
   oneSIZE="`printf "%.1f" $aFREE`M"
  fi
 fi
 if [ ! -f /tmp/partview_used_${aTAG} ];then
  echo "$oneSIZE" > /tmp/partview_used_${aTAG}_old
  echo "$oneSIZE" > /tmp/partview_used_${aTAG}
 else
  cp -f /tmp/partview_used_${aTAG} /tmp/partview_used_${aTAG}_old
  echo "$oneSIZE" > /tmp/partview_used_${aTAG}
 fi
 pvDIFFER="`diff -q /tmp/partview_used_${aTAG} /tmp/partview_used_${aTAG}_old`"
 if [ "$pvDIFFER" != "" -o ! -f /tmp/partview_${aTAG}.gif ];then #saves time.
  #generate bar graph...
  ppmrough -width 100 -height 14 -var 1 -bg red -fg grey80 -left ${naUSED} | ppmtogif > /tmp/partview_${aTAG}.gif
 fi
 #add to gui...
 PARTINFO="${PARTINFO}
<hbox><text><label>${aTAG} ${oneSIZE}</label></text><pixmap><input file>/tmp/partview_${aTAG}.gif</input></pixmap></hbox>"
 #echo "aTAG=$aTAG aSIZE=$aSIZE aFREE=$aFREE"
done

kill $XPID

export MAIN_DIALOG="<window title=\"Partview\" icon-name=\"gtk-harddisk\">
 <vbox>
  ${PARTINFO}
 </vbox>
</window>"


gtkdialog3 --program=MAIN_DIALOG
# Very End of this file 'usr/sbin/partviewOLD' #
###END###
