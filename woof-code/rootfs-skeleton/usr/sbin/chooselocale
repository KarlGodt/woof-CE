#!/bin/ash
#
# New header by Karl Reimer Godt, September 2014

  _TITLE_="Puppy_chooselocale"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/sbin/chooselocale"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5
INFO=1; #DEBUG=1;DEBUGX=1

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"

[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}
# End new header
#
#(c) Copyright 2009 Barry Kauler
#2009 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#w001 initial creation.
#w004 checkbox for utf8. w019 fixup.
#w470 $1=composeonly option, when call from 3builddistro.
#w473 disable en_US.utf8 generation, hangs PC if low RAM (64MB system).
#w478 bugfix, dialog_table was incorrect.
#v431 updated LANGUAGEDESCR variable.


LANG=C #Xdialog seems to need this.
export LANG

#DEBUG=1
_debug "\$*='$*' \$1=$1"
PARAM1=""
[ "$1" ] && PARAM1="$1"
_debugx "PARAM1='$PARAM1'"

. /etc/DISTRO_SPECS

CURRLANG=`grep '^LANG=' /etc/profile | cut -f 2 -d '='`
[ "$CURRLANG" ] && _info "Have current CURRLANG='$CURRLANG' in /etc/profile" || _warn "CURRLANG not found in /etc/profile"
UTF8=''
[ "`echo -n "$CURRLANG" | grep 'utf8'`" != "" ] && UTF8='.utf8'
BASELANG=`basename $CURRLANG .utf8`
[ "$BASELANG" ] && _info "Have BASELANG='$BASELANG'" || _warn "BASELANG not defined"

CURRENTWM=`cat /etc/windowmanager`

XSTATUS="CLI"
[ -z $DISPLAY ] || XSTATUS="X"
#[ "$1" = cli ]  && XSTATUS="CLI"
case "$*" in
*cli*|*CLI*) XSTATUS=CLI;;
esac
PARAM1=$XSTATUS

_debug "XSTATUS='$XSTATUS' PARAM1='$PARAM1'"

tmpDIR=/tmp/chooselocale
mkdir -p "$tmpDIR"

if [ "$PARAM1" != "composeonly" ];then #w470 w473
 [ ! -d /usr/lib/locale/en_US ] && localedef -f ISO-8859-1 -i en_US --no-archive en_US >$OUT
 #[ ! -d /usr/lib/locale/en_US.utf8 ] && localedef -f UTF-8 -i en_US --no-archive en_US.utf8 >/dev/null
fi

#v431 fix es:Mexican change to es:Spanish (Spain)...
LANGUAGEDESCR='aa:Afar ab:Abkhazian af:Africaans am:Amharic an:Aragonese ar:Arabic az:Azeri be:Belarusian bn:Bengali bs:Bosnian bg:Bulgarian br:Breton ca:Catalan cs:Czech cy:Welsh da:Danish de:German dv:Divehi dz:Dzongkha el:Greek en:English eo:Esperanto es:Spanish et:Estonian eu:Basque fa:Persian fo:Faeroese fi:Finnish fr:French ga:Irish gd:Scots_Gaelic gl:Galician gv:Manx_Gaelic gu:Gujarati he:Hebrew hi:Hindi hr:Croatian hu:Hungarian hy:Armenian is:Icelandic id:Indonesian iw:Hebrew it:Italian ja:Japanese ka:Georgian kl:Greenlandic kn:Kannada kk:Kazakh km:Khmer kok:Konkani ko:Korean ku:Kurdish kw:Cornish ky:Kyrgyz lg:Luganda lo:Lao lt:Lithuanian lv:Latvian mg:Malagasy ms:Malay ml:Malayalam mt:Maltese mi:Maori mk:Macedonian mn:Mongolian mr:Marathi ne:Nepali nl:Dutch nb:Norgwegian nn:Norwegian_Nynorsk no:Norwegian_Bokm oc:Occitan om:Oromo or:Oriya pa:Pashto pt:Brazilian pl:Polish pt:Portuguese pa:Punjabi quz:Quechua ro:Romania rs:Serbian ru:Russian rw:Kinyarwanda smn:Sami smj:Sami se:Sami sa:Sanskrit sma:Sami sms:Sami sq:Albanian sr:Srpski sl:Slovenian sw:Swahili sv:Swedish syr:Syriac ta:Tamil th:Thai tl:Tagalog tt:Tatar te:Telugu tr:Turkish uk:Ukrainian ur:Urdu uz:Uzbek vi:Vietnamese wa:Walloon xh:Xhosa yi:Yiddish zh:Chinese zu:Zulu'

REGIONDESCR='AA:ArabicCountries AE:UAE AL:Yugoslavia AR:Argentina AT:Austria AU:Australia BE:Belgium BG:Bularia BH:Bahrain BN:Brunei BO:Bolvia BR:Brazil BZ:Belize CA:Canada CH:Switzerland CL:Chile CN:PeoplesRepublicChina CO:Columbia CR:CostaRica CY:Cyprus CZ:CzechRepublic DE:Germany DK:Denmark DO:DominicanRepublic EC:Ecuador EE:Estonia ES:Spain DO:Dominican DZ:Algeria EC:Ecuador EG:Egypt FI:Finland FR:France GB:GreatBritain GR:Greece GT:Guatemalia HK:HongKong HN:Honduras HR:Croatia HU:Hungary ID:Indonesia IE:Ireland IL:Israel IN:India IQ:Iraq IS:Iceland IT:Italy JM:Jamaica JO:Jordan JP:Japan KR:Korea KW:Kuwait KZ:Kazakhstan LB:Lebanon LI:Liechtenstein LU:Luxembourg LY:Libya MA:Morocco MC:Monaco MK:Macedonia MO:Macau MY:Malaysia MX:Mexico NI:Nicaragua NL:Netherlands NO:Norway NZ:NewZealand OM:Oman PA:Panama PE:Peru PH:Philippines PL:Poland PR:PuertoRico PT:Portugal PY:Paraguay QA:Qatar RO:Romania RU:Russia SA:SaudiArabia SE:Sweden SG:Singapore SK:Slovakia SY:Syria TH:Thailand TN:Tunisia TR:Turkey TW:Taiwan ZA:SouthAfrica TT:Trinidad US:USA PE:Peru SV:ElSalvador MX:Mexico NI:Nicaragua UY:Uruguay VE:Venezuela YE:Yemen YU:Yugoslavia ZA:SouthAfrica'


_create_dialog_tables(){  #BEGIN

 CHOICES=""; ON=""; OFF=""; XPID=""

if [ "$XSTATUS" != "X" ];then
 echo -n -e " \\033[1;35mplease wait...\\033[0;39m" #purple text.
else
  xmessage -bg orange -fg black -center -buttons "" "Please wait, processing..." &
  XPID=$!
fi

  ON="on"
  OFF="off"

 oldIFS="$IFS"
 IFS=$'\n'
 for oneLOCALE in `ls -1 /usr/share/i18n/locales | grep -v -E 'i18n|iso|translit|POSIX'`
 do
  _debug "oneLOCALE='$oneLOCALE'"

  STATUS="off"
  [ "$oneLOCALE" = "$BASELANG" ] && STATUS="on"
  _debugx "STATUS='$STATUS'"

  LANGUAGE=`echo -n "$oneLOCALE" | cut -f 1 -d '_'`
  REGION=`echo -n "$oneLOCALE" | cut -f 2 -d '_' | cut -f 1 -d '.' | cut -f 1 -d '@'`

  lPATTERN="^${LANGUAGE}:"
  LANGUAGE=`echo "$LANGUAGEDESCR" | tr ' ' '\n' | grep "$lPATTERN" | head -n 1 | cut -f 2 -d ':'`

  rPATTERN="^${REGION}:"
  REGION=`echo "$REGIONDESCR" | tr ' ' '\n' | grep "$rPATTERN" | head -n 1 | cut -f 2 -d ':'`

  [ "$LANGUAGE" != "" ] && [ "$REGION" != "" ] && LANGUAGE="${LANGUAGE}, "
  DESCR="${LANGUAGE}${REGION}"

  if [ "$STATUS" = "on" ];then

   xFIRSTLINE="$oneLOCALE \"${DESCR}\" ${ON}"
   cliFIRSTLINE="$oneLOCALE \"${DESCR}\""

  else

   xCHOICES="${xCHOICES} $oneLOCALE \"${DESCR}\" ${OFF}"
   cliCHOICES="${cliCHOICES} $oneLOCALE \"${DESCR}\""

  fi

 done
 IFS="$oldIFS"

 xCHOICES="${xFIRSTLINE} ${xCHOICES}"
 cliCHOICES="${cliFIRSTLINE} ${cliCHOICES}"

 [ "$VERBOSE" ] && echo -n "${xCHOICES}" >           "$tmpDIR"/dialog_table_${XSTATUS}

 if test "$PARAM1" = "composeonly"; then
  mv $VERB /usr/share/i18n/dialog_table_x /usr/share/i18n/dialog_table.Xdlg-`date +%Y-%m%d-%H-%M` 2>$ERR
    echo -n "$xCHOICES"                  >/usr/share/i18n/dialog_table.Xdlg

mv $VERB /usr/share/i18n/dialog_table_cli /usr/share/i18n/dialog_table.dlg-`date +%Y-%m%d-%H-%M` 2>$ERR
    echo -n "$cliCHOICES"                >/usr/share/i18n/dialog_table.dlg

 elif test "$PARAM1" = X; then
       mv $VERB /usr/share/i18n/dialog_table.Xdlg /usr/share/i18n/dialog_table.Xdlg-`date +%Y-%m%d-%H-%M` 2>$ERR
                         echo -n "${xCHOICES}"   >/usr/share/i18n/dialog_table.Xdlg #w478

 elif test "$PARAM1" = CLI; then
        mv $VERB /usr/share/i18n/dialog_table.dlg /usr/share/i18n/dialog_table.dlg-`date +%Y-%m%d-%H-%M` 2>$ERR
                       echo -n "${cliCHOICES}"   >/usr/share/i18n/dialog_table.dlg #w478

 else
       false
 fi

 [ "$XPID" != "" ] && kill $XPID || echo
}  ###_create_dialog_tables(){  #END
_create_dialog_tables


case $PARAM1 in
*composeonly)
 exit
;;
esac

CHECKUTF8='off'
[ "$UTF8" != "" ] && CHECKUTF8='on'

case $XSTATUS in
x|X)
 xCHOICES=`tr '\n' ' ' </usr/share/i18n/dialog_table.Xdlg` || CHOICES="\"SOME ERROR OCCURED\" \"SOME ERROR OCCURED\" ${ON}"
 echo "#!/bin/sh
Xdialog --left --stdout --wrap --title \"Country setup\" --check \"UTF-8 encoding (apps faster without)\" ${CHECKUTF8} --radiolist \"The locale setting provides money, date and font localization for your country. The current choice is ${BASELANG}. Make a choice to suit your country...\" 0 46 0 $xCHOICES >$tmpDIR/chooselocale-choice
exit \$?" > "$tmpDIR"/xdialog-chooselocale
;;
#else
cli|CLI)
 cliCHOICES=`tr '\n' ' ' </usr/share/i18n/dialog_table.dlg` || CHOICES="\"SOME ERROR OCCURED\" \"SOME ERROR OCCURED\""
 echo "#!/bin/sh
dialog --stdout --aspect 10 --title \"Country setup\" --menu \"The locale setting provides money, date and font localization for your country. The current choice is ${BASELANG}. Make a choice to suit your country...\" 0 0 0 ${cliCHOICES} >$tmpDIR/chooselocale-choice 2>$tmpDIR/chooselocale-choice.err
exit \$?" > "$tmpDIR"/xdialog-chooselocale
;;
esac

chmod $VERB 0774 "$tmpDIR"/xdialog-chooselocale
"$tmpDIR"/xdialog-chooselocale
[ $? -ne 0 ] && exit

LANGCHOICE=`cat "$tmpDIR"/chooselocale-choice | head -n 1`
UTF8CHOICE=`cat "$tmpDIR"/chooselocale-choice | tail -n 1`
UTF8=''

if [ "$UTF8CHOICE" = "checked" ];then
 UTF8='.utf8'
 #if the user has chosen something like nl_BE@euro, need to chop...
 LANGCHOICE=`echo -n "$LANGCHOICE" | cut -f 1 -d '@'`
fi

if [ "$LANGCHOICE" != "" -a "${LANGCHOICE}${UTF8}" != "$CURRLANG" ];then
 # creates locale files in /usr/lib/locale...
 #CURRLANG=`grep '^LANG=' /etc/profile | cut -f 2 -d '='`
 OLDLANG="LANG=$CURRLANG"
 NEWLANG="LANG=${LANGCHOICE}"
 [ "$UTF8" != "" ] && NEWLANG="LANG=${LANGCHOICE}"'.utf8'

 if [ "`locale -a | grep "${LANGCHOICE}${UTF8}"`" = "" ];then
  if [ "$UTF8" = "" ];then

   lcPATTERN='^'"${LANGCHOICE}"' '
   CHARMAP=`grep "$lcPATTERN" /usr/share/i18n/SUPPORTED | head -n 1 | cut -f 2 -d ' '`

   if [ "$CHARMAP" != "" ];then #make sure have it...
    cPATTERN="$CHARMAP"'\.gz'
    [ "`ls -1 /usr/share/i18n/charmaps | grep "$cPATTERN"`" = "" ] && CHARMAP=""
   fi

   if [ "$CHARMAP" != "" ];then

    localedef -f $CHARMAP -i $LANGCHOICE --no-archive ${LANGCHOICE} >$OUT
    NEWLANG="LANG=${LANGCHOICE}"

   else

    #no match, i think forced to use utf8...
    localedef -f UTF-8 -i $LANGCHOICE --no-archive ${LANGCHOICE}.utf8 >$OUT
    NEWLANG="LANG=${LANGCHOICE}.utf8"
    UTF8='.utf8'
   fi #[ "$CHARMAP" != "" ]

  else

   #lcPATTERN='^'"${LANGCHOICE}"'[. ]'
   #CHARMAP=`grep "$lcPATTERN" /usr/share/i18n/SUPPORTED | grep 'UTF\-8' | head -n 1 | cut -f 2 -d ' '`
   #[ "$CHARMAP" = "" ] && CHARMAP="UTF-8"
   localedef -f UTF-8 -i $LANGCHOICE --no-archive ${LANGCHOICE}.utf8 >$OUT
   NEWLANG="LANG=${LANGCHOICE}.utf8"

  fi #[ "$UTF8" = "" ]
 fi  #[ "`locale -a | grep "${LANGCHOICE}${UTF8}"`" = "" ]


 if [ "$OLDLANG" != "$NEWLANG" ];then
  langPATTERN="s/${OLDLANG}/${NEWLANG}/"
  sed -e "$langPATTERN" /etc/profile > "$tmpDIR"/profile; STATUS=$((STATUS+$?))
  [ $STATUS = 0 ] && {
  cp $VERB -f "$tmpDIR"/profile /etc/profile;             STATUS=$((STATUS+$?))
  [ $STATUS = 0 ] && _info "Have changed LANG entry in /etc/profile from '$OLDLANG' to '$NEWLANG'" || _warn "Attempt to copy $tmpDIR/profile to /etc/ failed."
  } || _warn "Attempt to sed '$langPATTERN' from /etc/profile to $tmpDIR/profile failed."
 fi

 [ "$VERBOSE" -o "$STATUS" != 0 ] || rm -f /etc/profile

case $XSTATUS in
*x*|*X*)

 if [ "$STATUS" = 0 ]; then
   Xdialog --left --wrap --title "Country setup" --ok-label "Restart X now" --cancel-label "Finished"  --yesno \
   "Ok, the change has been made and will take effect at next boot. However, if you click the 'Restart X now' button \
   X will exit then restart and the new locale will immediately take effect -- however make sure that all other applications \
   are closed first as restarting X will rudely kill them! Otherwise, just click 'Finished' for the new locale to take effect at next boot.\
   \n\nTechnical details:\nLocale files have been generated in /usr/lib/locale (if not already) \
   and LANG variable set to ${LANGCHOICE}${UTF8} in /etc/profile." 0 100
    if [ $? -eq 0 ];then
     rm -rf /tmp/.X0-lock
     _sync
     exec restartwm $CURRENTWM
    fi

 else

    extraMSG="Please contact system administrator."

     if [ "`whoami`" = "root" ]; then
     defaulttexteditor /etc/profile
     rox -x /etc -d /etc
     rox -x "$tmpDIR" -d "$tmpDIR"
     extraMSG="Have opened /etc and $tmpDIR in rox window and /etc/profile in defaulttexteditor"
     sleep 1
    fi

    xmessage -bg red "SOMETHING WENT WRONG

$extraMSG" &

 fi #[ "$STATUS" = 0 ]
;;
esac

fi #[ "$LANGCHOICE" != "" -a "${LANGCHOICE}${UTF8}" != "$CURRLANG" ]

exit $STATUS

###END###
