#!/bin/ash
#(c) Copyright 2009 Barry Kauler
#2009 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#w001 initial creation.
#w004 checkbox for utf8. w019 fixup.
#w470 $1=composeonly option, when call from 3builddistro.
#w473 disable en_US.utf8 generation, hangs PC if low RAM (64MB system).
#w478 bugfix, dialog_table was incorrect.


test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP='1'; TWO_VERSION=''; TWO_VERBOSE='1'; TWO_DEBUG='1'; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="(X)dialog to select locale for login, apps and terminals."
_parse_basic_parameters "$@"
if [ "$DO_SHIFT" ]; then
 if [ ! "${DO_SHIFT//[[:digit:]]/}" ]; then
  for oneSHIFT in `seq 1 1 $DO_SHIFT`
  do
  shift
  done
 fi
fi

_trap
}

usage(){
    MSG="
    $0 [-options|cli|composeonly]
    Script to give a menu to select the desired language environment.
    While X is running uses 'Xdialog', otherwise 'dialog' .
    Depends on '`which localedef`'
    to set them, also on '`which locale`' .
    Files get created in '/usr/lib/locale'
    from src files in '/usr/share/i18n/locales'.

    Finally writes LANG to '/etc/profile' .

    Options :
    -d) debug with 'set -x' .

    -f) override some original code ie
#if the user has chosen something like nl_BE@euro, need to chop...
LANGCHOICE=\"\`echo -n \"\$LANGCHOICE\" | cut -f 1 -d '@'\`\"

    -v) verbose .
    -l) logsave to '/tmp/chooselocale.log .
    -h) help to show this usage message .
    "
    #FONT='-*-*-*-*-*-*-*-*-*-*-*-*-*-*'
    BG=green;[ "$1" = '0' ] || BG='red'
    if [ "$DISPLAY" ];then
    xmessage -title "CHOOSELOCALE HELP" -bg $BG "$MSG"
    #yaf-splash -timeout 30 -bg $BG -font $FONT -text "$MSG"
    fi
    echo "$MSG"
    exit $1
}
case "$1" in *help|-h) usage 0;; esac

CLI_P="$@";CMDL_P="$@"
OUT='/dev/null';ERR=$OUT;Q=-q;QUIET=--quiet

while getopts dvlh opt_;do
case $opt_ in
d) DEBUG='on';  set -x; shift;;
v) VERBOSE=1;VERB='-v';L_VERB='--verbose';A_VERB='-verbose';
   Q=''; QUIET='';
   OUT=/dev/sdtout;ERR=/dev/stderr ; shift;;
f) OVER_RIDE=1; shift;;
l) CLI_P=`echo "$@" | tr ' ' '\n' |grep '^\-' |grep 'l' |tr -d 'l'|tr '\n' ' '|sed 's/- //g'`
   exec logsave -a /tmp/chooselocale.log "$0" $CLI_P;;
h) usage 0; shift;;
*) usage 1; shift;;
esac;done
while [ "$2" ];do shift;done

LANG=C #Xdialog seems to need this.
export LANG

PARAM1=""
[ $1 ] && PARAM1="$1"
_debug "PARAM1='$PARAM1'"

. /etc/DISTRO_SPECS

CURRLANG=`grep '^LANG=' /etc/profile | cut -f 2 -d '='`
_debug "CURRLANG='$CURRLANG'"

UTF8=''
[ "`echo -n "$CURRLANG" | grep 'utf8'`" != "" ] && UTF8='.utf8'

BASELANG=`basename $CURRLANG .utf8`
_debug "BASELANG='$BASELANG'"
_debugx "`basename $CURRLANG`"
_debugx "`basename .utf8`"
_debugx "`basename $CURRLANG .utf8`"
_debugx "`basename "$CURRLANG .utf8"`"
_debugx "`basename ${CURRLANG} ${UTF8}`"
_debug "`basename "${CURRLANG}${UTF8}"`"

#exit

read CURRENTWM </etc/windowmanager

XSTATUS="cli"
[ -z $DISPLAY ] || XSTATUS="x"
[ $1 ] && XSTATUS="cli"
_debug "XSTATUS='$XSTATUS'"

if [ "$XSTATUS" != "x" ];then
 echo -n -e " \\033[1;35mBuilding locale database, please wait...\\033[0;39m" #purple text.
fi

if [ "$PARAM1" != "composeonly" ];then #w470 w473
 [ ! -d /usr/lib/locale/en_US ] && localedef $VERB -f ISO-8859-1 -i en_US --no-archive en_US >$OUT
 #[ ! -d /usr/lib/locale/en_US.utf8 ] && localedef -f UTF-8 -i en_US --no-archive en_US.utf8 >$OUT
fi

LANGUAGEDESCR='aa:Afar ab:Abkhazian af:Africaans sq:Albanian ar:Arabic hy:Armenian az:Azeri eu:Basque be:Belarusian bn:Bengali bs:Bosnian pt:Brazilian bg:Bulgarian ca:Catalan zh:Chinese hr:Croatian el:Cypriotic cs:Czech da:Danish dv:Divehi nl:Dutch en:English et:Estonian fo:Faeroese fa:Farsi fi:Finnish fr:French mk:Fyrom gl:Galician de:German el:Greek gu:Gujarati he:Hebrew hi:Hindi hu:Hungarian is:Icelandic id:Indonesian ga:Irish it:Italian ja:Japanese kn:Kannada kk:Kazakh kok:Konkani ko:Korean ky:Kyrgyz lv:Latvian ms:Malay ml:Malayalam mt:Maltese mi:Maori mr:Marathi es:Mexican mn:Mongolian nb:Norgwegian nn:Norwegian pa:Pashto fa:Persian pl:Polish pt:Portuguese pa:Punjabi quz:Quechua ro:Romania ru:Russian smn:Sami smj:Sami se:Sami sms:Sami sma:Sami sa:Sanskrit rs:Serbian sr:Srpski sl:Slovenian es:Spanish sw:Swahili sv:Swedish syr:Syriac ta:Tamil tt:Tatar te:Telugu tr:Turkish uk:Ukrainian ur:Urdu uz:Uzbek vi:Vietnamese wa:Walloon cy:Welsh xh:Xhosa zu:Zulu'
REGIONDESCR='AA:ArabicCountries AE:UAE AL:Yugoslavia AR:Argentina AT:Austria AU:Australia BE:Belgium BG:Bularia BH:Bahrain BN:Brunei BO:Bolvia BR:Brazil BZ:Belize CA:Canada CH:Switzerland CL:Chile CN:PeoplesRepublicChina CO:Columbia CR:CostaRica CY:Cyprus CZ:CzechRepublic DE:Germany DK:Denmark DO:DominicanRepublic EC:Ecuador EE:Estonia ES:Spain DO:Dominican DZ:Algeria EC:Ecuador EG:Egypt FI:Finland FR:France GB:GreatBritain GR:Greece GT:Guatemalia HK:HongKong HN:Honduras HR:Croatia HU:Hungary ID:Indonesia IE:Ireland IL:Israel IN:India IQ:Iraq IS:Iceland IT:Italy JM:Jamaica JO:Jordan JP:Japan KR:Korea KW:Kuwait KZ:Kazakhstan LB:Lebanon LI:Liechtenstein LU:Luxembourg LY:Libya MA:Morocco MC:Monaco MK:Macedonia MO:Macau MY:Malasia MX:Mexico NI:Nicaragua NL:Netherlands NO:Norway NZ:NewZealand OM:Oman PA:Panama PE:Peru PH:Philippines PL:Poland PR:PuertoRico PT:Portugal PY:Paraguay QA:Qatar RO:Romania RU:Russia SA:SaudiArabia SE:Sweden SG:Singapore SK:Slovakia SY:Syria TH:Thailand TN:Tunisia TR:Turkey TW:Taiwan ZA:SouthAfrica TT:Trinidad US:USA PE:Peru SV:ElSalvador MX:Mexico NI:Nicaragua UY:Uruguay VE:Venezuela YE:Yemen YU:Yugoslavia ZA:SouthAfrica'

#if [ ! -f /usr/share/i18n/dialog_table ];then
if [ "$PARAM1" = "composeonly" -o "$XSTATUS" = "x" -o ! -s /usr/share/i18n/dialog_table_${XSTATUS} -o ! -f /usr/share/i18n/dialog_table_${XSTATUS} -o ! "`grep '[[:alnum:]]' /usr/share/i18n/dialog_table_${XSTATUS}`" ];then #w478
 CHOICES=""; ON=""; OFF=""; xPID=""
 if [ "$XSTATUS" = "x" ];then
  ON="on"
  OFF="off"
  xmessage -title "CHOOSELOCALE" -bg orange -fg black -center -buttons "" "Please wait, processing..." &
  xPID=$!
 fi

 ls -1 /usr/share/i18n/locales | grep $Q -v -E 'i18n|iso|translit|POSIX' || { _err "SOMETHING WRONG"; kill $xPID; exit 1; }

 for oneLOCALE in `ls -1 /usr/share/i18n/locales | grep -v -E 'i18n|iso|translit|POSIX'`
 do
 _debugx "'$oneLOCALE' "
  STATUS="off"
  [ "$oneLOCALE" = "$BASELANG" ] && STATUS="on"
  _debugx "$STATUS"

   LOC=${oneLOCALE//[.@]*/}

  #LANGUAGE=`echo -n "$oneLOCALE" | cut -f 1 -d '_'`
  #LANGUAGE=`echo -n "$oneLOCALE" | awk -F'[_@.]' '{print $1}'`
  #LANGUAGE="${oneLOCALE%%_*}"

  # LANGUAGE="${LANGUAGE:0:2}"
  #be_BY@latin
  #ber_DZ

   LANGUAGE=${LOC%%_*}

  #  REGION=`echo -n "$oneLOCALE" | cut -f 2 -d '_' | cut -f 1 -d '.' | cut -f 1 -d '@'`
  #  REGION=`echo -n "$oneLOCALE" | awk -F'[_@.]' '{print $2}'`
  #  REGION="${oneLOCALE:3:2}"
  #  REGION=`echo ${oneLOCALE#*_}

     REGION=${LOC##*_}

  lPATTERN="^${LANGUAGE}:"
  LANGUAGE=`echo "$LANGUAGEDESCR" | tr ' ' '\n' | grep "$lPATTERN" | head -n 1 | cut -f 2 -d ':'`
  rPATTERN="^${REGION}:"
  REGION=`echo "$REGIONDESCR" | tr ' ' '\n' | grep "$rPATTERN" | head -n 1 | cut -f 2 -d ':'`
  [ "$LANGUAGE" != "" ] && { [ "$REGION" != "" ] && LANGUAGE="${LANGUAGE}, "; }
  DESCR="${LANGUAGE}${REGION}"
  #[ "$DESCR" != "" ] && DESCR="(${DESCR})"

  if [ "$STATUS" = "on" ];then
   FIRSTLINE="$oneLOCALE \"${DESCR}\" ${ON}"
   _debug "FIRSTLINE='$FIRSTLINE'";echo
  else
   CHOICES="$CHOICES $oneLOCALE \"${DESCR}\" ${OFF}"
  fi
 done
 CHOICES="${FIRSTLINE} ${CHOICES}"
 echo -n "$CHOICES" > /usr/share/i18n/dialog_table_${XSTATUS} #w478
 [ "$xPID" != "" ] && kill $xPID
else
  _info "NOT composeonly or NOT x or usable file"
 CHOICES=`cat /usr/share/i18n/dialog_table_${XSTATUS}` #w478
fi

if [ "$PARAM1" = "composeonly" ];then #w470
 exit
fi

#if [ "$XSTATUS" != "x" ];then
#echo -e "\\033[1;32m"" OK.""\\033[0;39m"
#fi

CHECKUTF8='off'
[ "$UTF8" != "" ] && CHECKUTF8='on'

_debugx " \\033[1;35mTesting CHOICES variable, please wait...\\033[0;39m" #purple text.
## REM: shell substitution takes a few seconds ..
#test "${CHOICES// /}" || _warn "Could not process locale choices from dialog_table_${XSTATUS}"
## REM: So using echo | grep
test "`echo "$CHOICES" | grep [[:alnum:]]`" || _warn "Could not process locale choices from dialog_table_${XSTATUS}"
_debugx "\\033[1;32m"" OK.""\\033[0;39m"
_debugx "CHOICES='$CHOICES'"


if [ "$XSTATUS" = "x" ];then
 _debug " \\033[1;35mBuilding Xdialog GUI, please wait...\\033[0;39m" #purple text.
 echo "#!/bin/sh
Xdialog --left --stdout --wrap --title \"Country setup\" --check \"UTF-8 encoding (apps faster without)\" ${CHECKUTF8} --radiolist \"The locale setting provides money, date and font localization for your country. The current choice is ${BASELANG}. Make a choice to suit your country...\" 30 50 40 $CHOICES >/tmp/chooselocale-choice
exit \$?" > /tmp/xdialog-chooselocale
else
 echo -n -e " \\033[1;35mBuilding dialog GUI, please wait...\\033[0;39m" #purple text.
 echo "#!/bin/sh
dialog --aspect 10 --title \"Country setup\" --menu \"The locale setting provides money, date and font localization for your country. The current choice is ${BASELANG}. Make a choice to suit your country...\" 0 0 0 ${CHOICES} 2>/tmp/chooselocale-choice
exit \$?" > /tmp/xdialog-chooselocale
fi
chmod $VERB 0777 /tmp/xdialog-chooselocale
[ "$VERBOSE" -o "$DEBUG" ] && { read -p "Press ENTER to continue" CONT_KEY; echo; }
_debug "\\033[1;32m"" OK.""\\033[0;39m"
/tmp/xdialog-chooselocale
[ $? -ne 0 ] && exit 49

LANGCHOICE=`cat /tmp/chooselocale-choice | head -n 1`
UTF8CHOICE=`cat /tmp/chooselocale-choice | tail -n 1`
UTF8=''

if [ "$UTF8CHOICE" = "checked" ];then
 UTF8='.utf8'
 #if the user has chosen something like nl_BE@euro, need to chop...
 [ "$OVER_RIDE" ] || LANGCHOICE=`echo -n "$LANGCHOICE" | cut -f 1 -d '@'`
fi
_debug "LANGCHOICE='$LANGCHOICE'"
RETVAL=0
if [ "$LANGCHOICE" != "" -a "${LANGCHOICE}${UTF8}" != "$CURRLANG" ];then

 # creates locale files in /usr/lib/locale...
 #CURRLANG=`grep '^LANG=' /etc/profile | cut -f 2 -d '='`
 OLDLANG="LANG=$CURRLANG"
 NEWLANG="LANG=${LANGCHOICE}"
 [ "$UTF8" != "" ] && NEWLANG="LANG=${LANGCHOICE}"'.utf8'

 if [ "`locale -a | grep -x "${LANGCHOICE}${UTF8}"`" = "" ];then
  if [ "$UTF8" = "" ];then
   lcPATTERN='^'"${LANGCHOICE}"' '
   CHARMAP=`grep "$lcPATTERN" /usr/share/i18n/SUPPORTED | head -n 1 | cut -f 2 -d ' '`
   if [ "$CHARMAP" != "" ];then #make sure have it...
    cPATTERN="$CHARMAP"'\.gz'
    [ "`ls -1 /usr/share/i18n/charmaps | grep "$cPATTERN"`" = "" ] && CHARMAP=""
   fi
   if [ "$CHARMAP" != "" ];then
    localedef $VERB -c -f $CHARMAP -i $LANGCHOICE --no-archive ${LANGCHOICE} > $OUT
    RETVAL=$?
    NEWLANG="LANG=${LANGCHOICE}"
   else
    #no match, i think forced to use utf8...
    localedef $VERB -c -f UTF-8 -i $LANGCHOICE --no-archive ${LANGCHOICE}.utf8 >$OUT
    RETVAL=$?
    NEWLANG="LANG=${LANGCHOICE}.utf8"
    UTF8='.utf8'
   fi
  else
   #lcPATTERN='^'"${LANGCHOICE}"'[. ]'
   #CHARMAP=`grep "$lcPATTERN" /usr/share/i18n/SUPPORTED | grep 'UTF\-8' | head -n 1 | cut -f 2 -d ' '`
   #[ "$CHARMAP" = "" ] && CHARMAP="UTF-8"
   localedef $VERB -c -f UTF-8 -i $LANGCHOICE --no-archive ${LANGCHOICE}.utf8 >$OUT
   RETVAL=$?
   NEWLANG="LANG=${LANGCHOICE}.utf8"
  fi
 fi

_debug "RETVAL='$RETVAL'"

if [ "$RETVAL" = "0" ] ; then #+++returnvalue of localedef

 if [ "$OLDLANG" != "$NEWLANG" ];then
  langPATTERN="s/${OLDLANG}/${NEWLANG}/"
  sed -e "$langPATTERN" /etc/profile > /tmp/profile
  [ "$?"  = 0 ] && { cp $VERB -f /tmp/profile /etc/profile || true; } || {
      xmessage -title "CHOSELOCALE" -bg red 'SOMETHING WENT WRONG
      while altering /etc/profile ...
      Please check out /tmp/profile ..?'
     exit 10
    }
  fi

 [ "$XSTATUS" != "x" ] && exit $RETVAL

 Xdialog --left --wrap --title "Country setup" --ok-label "Restart X now" --cancel-label "Finished"  --yesno "Ok, the change has been made and will take effect at next boot. However, if you click the 'Restart X now' button X will exit then restart and the new locale will immediately take effect -- however make sure that all other applications are closed first as restarting X will rudely kill them! Otherwise, just click 'Finished' for the new locale to take effect at next boot.\n\nTechnical details:\nLocale files have been generated in /usr/lib/locale (if not already) and LANG variable set to ${LANGCHOICE}${UTF8} in /etc/profile." 0 100

 if [ $? -eq 0 ];then
  rm -rf /tmp/.X0-lock
  pidof sync >$OUT || sync
  exec restartwm $CURRENTWM
 fi

else #+++returnvalue of localedef
if [ "$XSTATUS" != 'x' ] ; then
echo -e "\n\n\n\e[0;31m""The `which localedef` bianary returned '$RETVAL' .
Defaulted to en_US ."
else
xmessage -title "CHOOSELOCALE" -bg red "The `which localedef` bianary returned '$RETVAL' .
Defaulted to en_US ."
fi
fi #endif returnvalue of localedef

fi

###END###
