#!/bin/sh
#(c) Copyright Barry Kauler 2007 www.puppylinux.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#utility to select the timezone.
#Note, as Puppy will mostly be on PCs coexisting with Windows,
#hardware clock (CMOS) is set to local time (see /etc/rc.d/rc.local0)
#BK oct2007: updated for 3.02
#w019 april 2009: cli mode so can run from /etc/rc.d/rc.update

#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************

########################################################################
#
# CHANGES by Karl Reimer Godt
# 01.0 : commented both GMT+- parts ,
#        AND DEFTAG='Etc/GMT+8' CZONE=+8 ,
#        apparently only needed for buggy
#        libs ie [e]glibc
#        and bins like tzselect,hwclock
#
#        doing the steps manually worked somehow to get the right GMT[+-] ,
#
#          had one X blackout after ln -s /path/to /etc/localtime
#          after hwclock --hctosys --localtime
#
#        the settings are difficult to observe somehow
#
#         today the correct time is shown after C+A+BS to prompt and xwin
#         after the X blackout , probably due to Xorg or kernel drivers
#          # elspci -l
#01:00.0 030000 10DE:0182 <nvidiafb>
#00:1f.5 040100 8086:2445 <Intel ICH>
#00:1f.4 0C0300 8086:2444 <uhci_hcd>
#00:1f.3 0C0500 8086:2443 <i801_smbus>
#00:1f.2 0C0300 8086:2442 <uhci_hcd>
#00:1f.1 010180 8086:244B <PIIX_IDE>
#00:1f.0 060100 8086:2440 <>
#00:1e.0 060400 8086:244E <>
#00:01.0 060400 8086:1A31 <>
#00:00.0 060000 8086:1A30 <>
#          # lsmod | grep -E 'agp|vga|fb|i2c|nouveau|drm|gpu'
#nvidiafb               34408  1
#vgastate                5562  1 nvidiafb
#i2c_algo_bit            5327  1 nvidiafb
#fb_ddc                  1075  1 nvidiafb
#i2c_i801                6862  0
#i2c_core               18195  4 nvidiafb,i2c_algo_bit,fb_ddc,i2c_i801
#intel_agp               8801  0
#intel_gtt              11719  1 intel_agp
#agpgart                23588  2 intel_agp,intel_gtt
#
#         in jwm and date="Fr 28. Okt 13:28:19 GMT+1 2011"
#         uname -r=2.6.37.4-KRG-i486-StagingDrivers-2
#          lsmod | grep rtc
#           rtc_cmos                8361  0
#           rtc_core               12478  1 rtc_cmos
#           rtc_lib                 1749  1 rtc_core
#
#
#
# /dev/hda8:
# LABEL="MacPup431_O2"
# UUID="6d9a8e91-c301-4ff8-9875-97ec708cbee8"
# TYPE="ext3"
# DISTRO_NAME='Puppy'
# DISTRO_VERSION=431
# DISTRO_BINARY_COMPAT='puppy'
# DISTRO_FILE_PREFIX='pup'
# DISTRO_COMPAT_VERSION='4'
# PUPMODE=2
# KERNVER=2.6.37.4-KRG-i486-StagingDrivers-2
# PUP_HOME='/'
# SATADRIVES='·'
# USBDRIVES='·sda·'
# Linux·puppypc·2.6.37.4-KRG-i486-StagingDrivers-2·#4·SMP·Thu·Mar·17·06:05:58·GMT-8·2011·i686·GNU/Linux
# Xserver=/usr/X11R7/bin/Xorg
# $LANG=de_DE@euro
# today=Fr·28.·Okt·13:05:00·GMT+1·2011
#
#
#
#
#
########################################################################

export LANG=C

XSTATUS="no"
[ -z $DISPLAY ] || XSTATUS="yes"
[ $1 ] && XSTATUS="no"

if [ -e /etc/localtime ];then
 CZONE=`readlink /etc/localtime`
 [ "$CZONE" = "" ] && rm -f /etc/localtime
fi

if [ -e /etc/localtime ];then
 CZONE=`readlink /etc/localtime`
 DEFTAG=`readlink /etc/localtime | sed -e 's%/usr/share/zoneinfo/%%'`
else
 CZONE='/usr/share/zoneinfo/Etc/GMT+8' #these have opposite sign.
 DEFTAG='Etc/GMT+8'
fi

DEFTAG=`echo -n "$DEFTAG" | sed -e 's%Etc/%%'`

ZONEINFO=`find /usr/share/zoneinfo -type f | grep -v '\.tab$' | sed -e 's%/usr/share/zoneinfo/%%' | sed -e 's%Etc/%%' | tr ' ' '_' | sort | tr '\n' ' '`

ZONECHOICES=""
for oneZONE in $ZONEINFO
do
 oneDESCR="."
 [ "$oneZONE" = "GMT" ] && continue
 [ "$oneZONE" = "GMT-0" ] && continue
 case $oneZONE in
  GMT+0)     oneDESCR='(London, Dublin, Edinburgh, Lisbon, Reykjavik, Casablanca)';;
  GMT-1)     oneDESCR='(Azores, Cape Verdes)';;
  GMT+1)     oneDESCR='(Paris, Berlin, Amsterdam, Brussels, Madrid, Stockholm Oslo)';;
  GMT-2)     oneDESCR='(mid-Atlantic)';;
  GMT+2)     oneDESCR='(Athens, Helsinki, Istanbul, Jerusalem, Harare)';;
  GMT-3)     oneDESCR='(Brasilia, Buenos Aires, Georgetown)';;
  GMT+3)     oneDESCR='(Kuwait, Nairobi, Riyadh, Moscow)';;
  GMT-4)     oneDESCR='(Caracas, La Paz, Canada)';;
  GMT+4)     oneDESCR='(Abu Dhabi, Muscat, Tblisi, Volgograd, Kabul)';;
  GMT-5)     oneDESCR='(Bogota, Lima, New York)';;
  GMT+5)     oneDESCR='(Islamabad, Karachi)';;
  GMT+5:30)  oneDESCR='(India)';;
  GMT-6)     oneDESCR='(Mexico City, Saskatchewan)';;
  GMT+6)     oneDESCR='(Almaty, Dhaka)';;
  GMT+6:30)  oneDESCR='(Cocos Islands)';;
  GMT-7)     oneDESCR='(Alberta, Montana, Arizona)';;
  GMT+7)     oneDESCR='(Bangkok, Jakarta)';;
  GMT-8)     oneDESCR='(Los Angeles)';;
  GMT+8)     oneDESCR='(Perth, Singapore, Hongkong)';;
  GMT-9)     oneDESCR='(Alaska)';;
  GMT+9)     oneDESCR='(Tokyo)';;
  GMT+9:30)  oneDESCR='(Darwin, Adelaide)';;
  GMT-10)    oneDESCR='(Alaska, Hawaii)';;
  GMT+10)    oneDESCR='(Guam)';;
  GMT+10:30) oneDESCR='(Lord Howe Island)';;
  GMT-11)    oneDESCR='(Samoa)';;
  GMT+11)    oneDESCR='(Magadan, Soloman Is.)';;
  GMT-12)    oneDESCR='(Eniwetok)';;
  GMT+12)    oneDESCR='(Wellington, Fiji, Marshall Islands)';;
  GMT+13)    oneDESCR='(Rawaki Islands)';;
  GMT+14)    oneDESCR='(Line Islands)';;
 esac
 ZONECHOICES="${ZONECHOICES}${oneZONE} \"${oneDESCR}\" "
done

if [ "$XSTATUS" = "yes" ];then
 ZONEDLG="Xdialog --stdout --title \"Puppy timezone selector\" --default-item $DEFTAG --menubox \"Please choose your timezone.\\nIf a city/region/country in your timezone is not listed, choose a GMT<number>\" 0 0 0 $ZONECHOICES"
 eval $ZONEDLG >/tmp/zoneretval
else
 ZONEDLG="dialog --aspect 10 --title \"Puppy timezone selector\" --default-item $DEFTAG --menu \"Please choose your timezone. If a city/region/country in your timezone is not listed, choose a GMT<number>\" 0 0 0 ${ZONECHOICES}"
 eval $ZONEDLG 2>/tmp/zoneretval
fi

[ $? -ne 0 ] && exit

ZONERETVAL=`cat /tmp/zoneretval`

#validity check...
[ "`echo "$ZONEINFO" | grep "$ZONERETVAL"`" = "" ] && exit

[ "`echo "$ZONERETVAL" | grep 'GMT'`" != "" ] && ZONERETVAL="Etc/$ZONERETVAL"

rm -f /etc/localtime
ln -s /usr/share/zoneinfo/$ZONERETVAL /etc/localtime

rm -f /etc/TZ #don't think need this anymore. also removed from /etc/profile.
#.../etc/profile now reads /etc/localtime and exports TZ variable.

#need to set Linux system time/date, from hardware clock...
test -c /dev/rtc0 || {
test -c /dev/rtc/rtc0 && ln -sf rtc/rtc0 /dev/rtc0
}
hwclock --hctosys --localtime || hwclock --hctosys --localtime --directisa --debug
#...--hctosys reads cmos clock to system, referencing /usr/share/zoneinfo/localtime
#...--localtime means that cmos clock is set to local-time.

###END###
