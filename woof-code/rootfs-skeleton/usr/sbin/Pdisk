#!/bin/sh
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#v3.97 BK bugfix.

  _TITLE_=Puppy_Disk_Setup
_COMMENT_="xmessage GUIs to select drive and cfdisk or fdisk"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && . /etc/rc.d/f4puppy5

#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0 "$_COMMENT_"
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************

if [ "`which fdisk`" -a "`which cfdisk`" ]; then
 BUTMANAGE="fdisk:20,cfdisk:21"
elif [ "`which fdisk`" ]; then
 BUTMANAGE="fdisk:20"
else
 BUTMANAGE="Exit:10"
fi

ALLINFO=`probedisk 2>/dev/null | grep -v "cdrom|" | grep -v "/scd"`
ALLPARTS=`echo "$ALLINFO" | cut -f 1 -d "|" | cut -f 3 -d "/"`
ALLMNTD=`df | grep "/dev/" | cut -f 1 -d " " | grep -v "loop" | tr "\n" " "`

butval=20
BUTPARTS=""
for EACHPART in $ALLPARTS
do
BUTPARTS="${BUTPARTS}$EACHPART:$butval,"
butval=`expr $butval + 1`
done
BUTPARTS="${BUTPARTS}EXIT:10"

xmessage -bg "#8080ff" -center -name "Pdisk" -title "Pdisk drive partition manager" -buttons $BUTPARTS "Welcome, this program enables you to run either fdisk, or, if it is
installed, cfdisk. These are utility applications to examine and
modify disk drive partitions. This includes creating and erasing
partitions, so is not for the faint-of-heart!

Here are the disk drives that Puppy knows about:
$ALLINFO

If any drive is wrong or missing, exit this program and run the
\"Mount/unmount drives\" program, that you will find in the \"File
Managers\" menu. That tool will enable you to probe the hardware.

These partitions are curently mounted:
$ALLMNTD
...you can view these but NOT change them.

To continue this program, click a drive button..."

RETVAL=$?
if [ $RETVAL -lt 11 ];then
 exit
fi

EDITPART=`echo "$BUTPARTS" | tr "," "\n" | grep "$RETVAL" | cut -f 1 -d ":"`

xmessage -bg "#80C080" -center -name "Pdisk" -title "Pdisk drive partition manager" -buttons $BUTMANAGE,EXIT:10 "Chose the partition manager program that you want to use..."

RETVAL=$?
if [ $RETVAL -lt 11 ];then
 exit
fi

if [ $RETVAL -eq 21 ];then
 rxvt -bg "#C080ff" -e cfdisk /dev/$EDITPART
else
 rxvt -bg "#C080ff" -e fdisk /dev/$EDITPART
fi
