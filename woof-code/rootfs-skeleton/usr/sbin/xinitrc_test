#!/bin/sh
#Barry Kauler 2009
#Called from Xorg Wizard, via xinit, testing a video mode.

__old_header__(){
###KRG Fr 31. Aug 23:34:58 GMT+1 2012

trap "exit 1" HUP INT QUIT KILL TERM

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = "2" ] && set -x

Version='1.1'

usage(){
USAGE_MSG="
$0 [ PARAMETERS ]

-V|--version : showing version information
-H|--help : show this usage information

*******  *******  *******  *******  *******  *******  *******  *******  *******
$2
"
exit $1
}

[ "`echo "$1" | grep -wE "\-help|\-H"`" ] && usage 0
[ "`echo "$1" | grep -wE "\-version|\-V"`" ] && { echo "$0 -version $Version";exit 0; }

###KRG Fr 31. Aug 23:34:58 GMT+1 2012
}

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="test script for Xorg to be run from xorgwizard ."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

#set -- `xvidtune -show` #'-display :0' not needed.

my_first_func(){
#would need als adjustments to printf :
#/usr/sbin/xinitrc_test: line 39: printf: 68.60: invalid number
#/usr/sbin/xinitrc_test: line 40: printf: 85.0: invalid number

Q=`dc 1.1 1.1 \* p`
if [ "$?" -ne 0 ] ; then
set -- `xvidtune -show | tr '.' ','`
else
set -- `xvidtune -show`
fi
} #my_first_func


LANG=C
LC_NUMERIC=C
LC_ALL=C
set -- `xvidtune -show`

echo >>/tmp/xorgwizard/xinitrc.log
echo "$*" >>/tmp/xorgwizard/xinitrc.log

CLOCKHZ=`dc $2 1000000 \* p`
if [ "$CLOCKHZ" != "0" ];then
 XTEST=$3
 YTEST=$7
 VRTEST=`dc $CLOCKHZ $6 \/ ${10} \/ p`
 HSTEST=`dc $CLOCKHZ $6 \/ 1000 \/ p`

echo "VRTEST='$VRTEST'" >>/tmp/xorgwizard/xinitrc.log
echo "HSTEST='$HSTEST'" >>/tmp/xorgwizard/xinitrc.log

else

 #some video chips do not work with xvidtune.
 XRANDRINFO=`xrandr -q | grep '\*' | tr -s ' ' | grep '^ [0-9]' | head -n 1`
 echo "XRANDRINFO='$XRANDRINFO'" >>/tmp/xorgwizard/xinitrc.log
 XTEST=`echo -n "$XRANDRINFO" | cut -f 2 -d ' ' | cut -f 1 -d 'x'`
 YTEST=`echo -n "$XRANDRINFO" | cut -f 2 -d ' ' | cut -f 2 -d 'x'`
 VRTEST=`echo -n "$XRANDRINFO" | cut -f 3 -d ' ' | cut -f 1 -d '*'`

 #xrandr does not always return the vertical frequency...
 if [ ! "$VRTEST" ];then
  if [ "$MONCHOICES" = "" ];then
   VRTEST=60 #last resort, but not correct.
  else
   VRTEST=`echo "$MONCHOICES" | grep -m1 "${XTEST}x${YTEST}" | cut -f 2 -d '@'`
   [ ! "$VRTEST" ] && VRTEST=60 #desparate last resort.
  fi
 fi

 # so we calc horiz freq theoretically...
 HSTEST=`gtf $XTEST $YTEST $VRTEST | head -n 2 | tail -n 1 | cut -f 1 -d ';' | cut -f 2 -d ':' | cut -f 2 -d ' '`

 echo "VRTEST='$VRTEST'" >>/tmp/xorgwizard/xinitrc.log
 echo "HSTEST='$HSTEST'" >>/tmp/xorgwizard/xinitrc.log

fi


#round off to two decimal places...
HSTEST=`printf "%.2f" $HSTEST`
VRTEST=`printf "%.2f" $VRTEST`

echo "VRTEST='$VRTEST'" >>/tmp/xorgwizard/xinitrc.log
echo "HSTEST='$HSTEST'" >>/tmp/xorgwizard/xinitrc.log

echo "XTEST=$XTEST
YTEST=$YTEST
VRTEST=$VRTEST
HSTEST=$HSTEST" > /tmp/xorgwizard/xorgwizard_initrc_test_results #read by xorgwizard.


#gpicview /usr/share/doc/puppylogo96.png &
#viewnior /usr/share/doc/puppylogo96.png &
#pngtopnm /usr/share/doc/puppylogo96.png >/usr/share/doc/puppylogo96.pnm #needs >
pngtopnm /usr/share/doc/puppylogo96.png >/tmp/puppylogo96.pnm
#pnmtops /usr/share/doc/puppylogo96.pnm >/usr/share/doc/puppylogo96.ps #needs >
pnmtops /tmp/puppylogo96.pnm >/tmp/puppylogo96.ps
#ps2pdf /usr/share/doc/puppylogo96.ps /usr/share/doc/puppylogo96.pdf
ps2pdf /tmp/puppylogo96.ps /tmp/puppylogo96.pdf
#pdftoppm /usr/share/doc/puppylogo96.pdf >/usr/share/doc/puppylogo96.ppm #needs >
pdftoppm /tmp/puppylogo96.pdf >/tmp/puppylogo96.ppm
#ppmquant 14 /usr/share/doc/puppylogo96.ppm >/usr/share/doc/puppylogo96d14.ppm #needs >
ppmquant 14 /tmp/puppylogo96.ppm >/tmp/puppylogo96d14.ppm
#ppmtogif /usr/share/doc/puppylogo96d14.ppm >/usr/share/doc/puppylogo96d14.gif #needs >
ppmtogif /tmp/puppylogo96d14.ppm >/tmp/puppylogo96d14.gif
gifsicle --crop 530,717+720x540 /tmp/puppylogo96d14.gif >/tmp/puppylogo640.gif
gifX=640;gifY=480;gifX=$XTEST;gifY=$YTEST
gifsicle --resize ${gifX}x${gifY} /tmp/puppylogo640.gif >/tmp/puppylogo.gif
gifview /tmp/puppylogo.gif &
sleep 2s
rm -f /tmp/puppylogo*

xmessage -font "8x16" -center -timeout 20 -buttons "OK:10" -default OK "
Puppy Xorg Video Wizard: testing X


If you can see this, then X is working!

Current resolution:         ${XTEST}x${YTEST} pixels
Horizontal sync frequency:  $HSTEST KHz
Vertical refresh frequency: $VRTEST Hz (times per second)

Please click the 'OK' button, or if your mouse isn't working,
just hit the ENTER key, or the combination CTRL-ALT-BACKSPACE.

If you don't do anything, this test will timeout in 20 seconds."

#rm -f /tmp/puppylogo*
#when xmessage terminates, xinit should kill Xorg.
###END###
