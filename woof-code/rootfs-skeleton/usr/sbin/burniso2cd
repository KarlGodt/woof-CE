#!/bin/sh
#(c) Copyright 2006, 2007 Barry Kauler.
#Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html). 2007 www.puppylinux.com
# Simple script to burn an iso file to cd, using cdrecord.
#7Sept2007: cdecord -scanbus bugfix, plus overall improvements.
#v3.02 2Nov2007 BK: bugfix. v3.94 24dec2007: no /dev/hd*
#w482 change -pad to padsize=300k, recommended by xorriso developer.
#w482 migrate to using xorriso.


test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="Xdialogs to burn ISO files to CD/DVD."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

CDRECORD=`which cdrecord`
if [ "`which xorriso`" ];then
 CDRECORD='xorrecord'
 export MKISOFS='xorrisofs' #growisofs reads this variable.
fi

[ "$CDRECORD" ] || exit 1

SELECTIONS=`probedisk | grep '|cdrom|' | grep '/dev/' | cut -f 1,3 -d '|' | tr " " '_' | tr -s '_'`
echo "SELECTIONS='$SELECTIONS'"
SELECTIONX=`echo "$SELECTIONS" | tr '|' " " | tr "\n" " "`
echo "SELECTIONX='$SELECTIONX'"

if [ ! "$SELECTIONX" ];then
 xmessage "Sorry, no CD/DVD drive detected"
 exit 0
fi

MEDIATYPE=`Xdialog --wmclass "mini-cd" --title "Burniso2cd" --stdout --menubox "Welcome to our little CD/DVD burner program!\nPlease choose whether you want to burn to a CD or DVD media.\nNote that DVDs are always burnt 'open' so can be used by Puppy\nas normal or multisession, whereas for CD you will be given\nthe choice further on whether to burn as closed or open." 0 0 5 CD "CD-R or CD-RW (must be blank)" DVD "DVD-R or DVD-RW (must be blank)"`
[ $? = 0 ] || exit 0

echo "MEDIATYPE='$MEDIATYPE'"

BURNERDRIVE=`Xdialog --wmclass "mini-cd" --title "Burniso2cd: Choose burner drive" --stdout --menubox "Choose the CD/DVD drive to burn to" 400x200 5 $SELECTIONX 2> /dev/null`
[ $? = 0 ] || exit 0
echo "BURNERDRIVE='$BURNERDRIVE'"
[ -f /etc/cdburnerdevice ] || echo -n "$BURNERDRIVE" | sed -e 's/\/dev\///g' > /etc/cdburnerdevice

ISOFILE=`Xdialog --wmclass "mini-cd" --backtitle "Please choose the iso file..." --title "Burniso2cd: Choose iso file" --stdout --no-buttons --fselect "*.iso" 0 0`
if [ $? != 0 ];then
 exit 0
fi

echo "ISOFILE='$ISOFILE'"
CDR="$BURNERDRIVE"
CDDESCR=`echo "$SELECTIONS" | grep "$CDR" | cut -f 2 -d '|'`
echo "CDDESCR='$CDDESCR'"

while [ "`mount | grep "$CDR"`" ];do
 xmessage -bg "#ff8080" -center -name "burniso2cd" -title "Burniso2cd: ERROR" "The $CDR CD/DVD drive, described as:
 $CDDESCR
is currently mounted.
Use MUT or Pmount to unmount it.

Please unmount CD drive, then click OK button..."
done

if [ "$MEDIATYPE" = 'CD' ];then

 Xdialog --wmclass "mini-cd" --title "Burniso2cd" --stdout --ok-label "NORMAL" --cancel-label "MULTI"  --yesno "You have selected iso file:
 $ISOFILE

Do you want to burn a multi-session CD?
A multi-session CD is one that is left \"open\" so that further
tracks may be burnt later. The iso file that you have selected
will be burnt now as the first track.
Note, this is an experimental option for the Puppy live-CD, to
allow burning of sessions back to CD, thus personal data is saved
to CD and a hard drive or usb stick is not required.

Please choose 'NORMAL' unless you have some special reason to burn
the CD multi-session (such as the iso is specifically for multisession).

Click 'NORMAL' button for normal burn...
Click 'MULTI' button for multi-session..." 0 0

 RETVAL=$?
else
 RETVAL=12
fi

case $RETVAL in
 0) #normal cd
  BURNMULTI="-dao" #v2.02 added -dao
  BURNMSG=""
  ;;
 1) #multi cd
  #BURNMULTI="-multi -tao -pad" #v2.02 added -tao -pad
  BURNMULTI="-multi -tao padsize=300k" #w482
  BURNMSG=""
  ;;
 12) #multi dvd
  BURNMULTI="yes"
  BURNMSG="(blank DVD-R. A DVD+/-RW will be fast-wiped if it has data)"
  ;;
 *)
  exit $RETVAL
  ;;
esac

RECHECK="yes"
BURNSPEED="10"

while [ 1 ];do #burn-again-loop

 IFS=':' read LABEL CAN_SET_SPEED <<EOI
$(cd-info $CDR | grep -i 'Can set drive speed')
EOI

 if [ "$CAN_SET_SPEED" = 'Yes' ] ; then
 BURNSPEED=`Xdialog --wmclass "mini-cd" --title "Burniso2cd: Burn $MEDIATYPE" --stdout --spinbox "Please insert blank $MEDIATYPE into $CDR
$BURNMSG
(which is described as: ${CDDESCR})

Then click 'OK' button..." 0 0 4 32 $BURNSPEED "Set burn speed"`

 [ $? = 0 ] || exit 0
 fi
 pidof sync || sync

 echo "BURNSPEED='$BURNSPEED'"

 echo '#!/bin/sh' >/tmp/burniso2cd
 if [ "$MEDIATYPE" = "CD" ];then
  DEVDEV="$CDR" #w482
  echo "
$CDRECORD $BURNMULTI -data -v speed=$BURNSPEED dev=$DEVDEV \"$ISOFILE\"" >>/tmp/burniso2cd
 else #dvd
 echo "
growisofs -speed=$BURNSPEED -Z $CDR=\"$ISOFILE\"" >>/tmp/burniso2cd
 fi
 echo 'RETVAL=$?
read -n1 -p "Press Enter " EK
echo "$RETVAL" >/tmp/burniso2cd.ok
exit $RETVAL
' >>/tmp/burniso2cd

 chmod +x /tmp/burniso2cd
 rxvt -name burniso2cd -bg orange -geometry 80x10 -e /tmp/burniso2cd
 read BURNOK </tmp/burniso2cd.ok
 pidof sync || sync
 [ "$BURNOK" = 0 ] && echo "...done." || echo "...failure..."

 #v2.10 kirk contributed this...
 # ******Verify burn******
 DEVNAME=`echo -n "$CDR" | grep '/dev' | cut -f 3 -d '/'`
 if [ "$DEVNAME" -a "$RECHECK" = "yes" ];then
  Xdialog --wmclass "mini-cd" --title "Burniso2cd: Finished" --stdout --yesno "Would you like to verify that the burn was successful?
This may take a while depending on the size of the iso file." 0 0
  if  [ "$?" = "0" ] ;then
   xmessage -bg "#80ff80" -center -name "burniso2cd" -title "Burniso2cd: Burn Verify" -buttons "OKAY:10" "Make sure the CD/DVD drive is closed,
then click OK"
   if [ "$( md5sum $ISOFILE | cut -f 1 -d " " )" = "$(dd if=$CDR | head -c `stat -c %s $ISOFILE` | md5sum | cut -f 1 -d " " )" ] ;then
    xmessage -bg "#80ff80" -center -name "burniso2cd" -title "Burniso2cd: Burn Verify" -buttons "OKAY:10" "The burn has been verified as good!"
   else
    xmessage -bg "#ffc0c0" -center -name "burniso2cd" -title "Burniso2cd: Burn Verify" -buttons "OKAY:10" "The burn was not verified. You should start over"
   fi
  else
   RECHECK="no" #do not check if doing repeat burns.
  fi
 fi

 Xdialog --wmclass "mini-cd" --title "Burniso2cd: Finished" --stdout --ok-label "FINISHED" --cancel-label "REPEAT" --yesno "If all went well, you have now burnt iso file
$ISOFILE
to a $MEDIATYPE!

If you want to burn the iso file to another $MEDIATYPE,
click 'REPEAT' button...

Otherwise, click 'FINISHED' to quit..." 0 0
 [ $? -ne 1 ] && break
done #burn-again-loop
eject $CDR
###END###
