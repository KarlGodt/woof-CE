#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_get_modem_alternate_device"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/sbin/get_modem_alternate_device"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=1
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in 1; do shift; done; }

_trap

}
# End new header
#
#Barry Kauler 2010 LGPL

usage(){
MSG="
$0 DEVICE
Puppy Linux shell script to get alternate modem device ?
Mainly for bluetooth ? Needs sdptool and rfcomm bianries
installed to work properly .
"
if [ "$2" ];then
MSG="$MSG

$2
"
fi
echo "$MSG"
[ "$DISPLAY" ] && xmessage -bg green1 "$MSG"
exit $1
}

case $1 in
-h|*help|*usage) usage 0;;
-V|*version)
. /etc/DISTRO_SPECS
usage 0 "Version $DISTRO_NAME $DISTRO_VERSION"
;;
esac

#Find another candidate for USB modem, for device in argument 1.
DEVM=$1
DEVMALT=""
if [ "`echo "$DEVM" | grep -E 'ttyACM[0-9]|ttyHS[0-9]|ttyUSB[0-9]|rfcomm[0-9]'`" != "" ];then
 DEVMLIST="`grep -l -s 'Interrupt'  /sys/class/tty/ttyACM?*/device/ep_??/type | cut -f 5 -d /` `grep -l -s 'Modem' /sys/class/tty/ttyHS?*/hsotype | cut -f 5 -d /` `grep -l -s 'Interrupt' /sys/class/tty/ttyUSB?*/device/ep_??/type | cut -f 5 -d /`"
 #v433 prepend any bluetooth modems to list...
 if which rfcomm >/dev/null && which sdptool >/dev/null;then
  DUNPATTERN="`sdptool search DUN | sed -n -e '/^Searching/h' -e '/^    Channel:/{H;x}' -e 's/Searching for DUN on //' -e 's/ ...\n    Channel://p'`"
  if [ "$DUNPATTERN" != "" ];then
   DUNRFCLIST="`rfcomm -a | grep ' connected' | sed -e 's/ channel//' | grep -F "$DUNPATTERN" | cut -f 1 -d :`"
   if [ "$DUNRFCLIST" != "" ];then
    DEVMLIST="$DUNRFCLIST $DEVMLIST"
   fi
  fi
#  echo "Modemtest/probe: DUNPATTERN: $DUNPATTERN  DUNRFCLIST: $DUNRFCLIST" >> /tmp/udevtrace-modem.log #debug
 fi #v433 end
 DEVMLIST="`echo "$DEVMLIST" | tr -s ' ' | tr ' ' '\n'`"
 SEDSCRIPT1="/${DEVM}/"'{n;p;q}'
 DEVMALT="`echo "$DEVMLIST" | sed -n "$SEDSCRIPT1"`"
 [ "$DEVMALT" = "" ] \
  && SEDSCRIPT2="/${DEVM}/"'!{p;q}' \
  && DEVMALT="`echo "$DEVMLIST" | sed -n "$SEDSCRIPT2"`"
fi
echo "$DEVMALT"
exit 0

###END###
