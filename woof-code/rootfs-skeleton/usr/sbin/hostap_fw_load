#!/bin/sh
# Example script for automatically loading firmware images when needed.
# This can be run, e.g. from /etc/pcmcia/wireless.
# Firmware images for the card
# TODO: could try to select correct firmware type automatically

  _TITLE_=load_hostap_firmware
_VERSION_=1.0omega
_COMMENT_="Load firmware automatically"

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST="IFNAME"
ADD_PARAMETERS="IFNAME : ie eth0"
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

PRI=/etc/pcmcia/PM010102.HEX
STA=/etc/pcmcia/RF010802.HEX
# BK path modified...
PRISM2_SREC=/usr/sbin/prism2_srec

set -e

if [ -z "$1" ]; then
    echo "usage: $0 <ifname>"
    exit 1
fi

IFNAME=$1
DIR=/proc/net/hostap/$IFNAME

if [ ! -d $DIR ]; then
    echo "Host AP driver data for device $IFNAME not found in procfs."
    exit 1
fi

if grep -q no_pri=1 $DIR/debug; then
    # no primary image - load primary in two steps, first without PDA and then
    # with full PDA plugging
    echo "Downloading primary firmware $PRI"
    $PRISM2_SREC -gs $IFNAME $PRI
    $PRISM2_SREC -gp $IFNAME $PRI
fi

if grep -q pri_only=1 $DIR/debug; then
    echo "Downloading secondary (station) firmware $STA"
    $PRISM2_SREC -rp $IFNAME $STA
fi

echo "Card is ready with both PRI and STA firmware images"
# Very End of this file 'usr/sbin/hostap_fw_load' #
###END###
