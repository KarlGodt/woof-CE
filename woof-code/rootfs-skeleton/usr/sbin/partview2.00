#!/bin/bash

  _TITLE_=Puppy_Partition_Viewer
_COMMENT_="GTKdialog GUI to show recognized partitions"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && . /etc/rc.d/f4puppy5

xmessage -center -bg orange -buttons "" "Please wait, processing. Don't mount or unmount any drives..." &
XPID=$!
echo "$0:START"

ERR=/dev/null

mkdir -p /mnt/data

tmpDir=/tmp/partview
pic_dir=$tmpDir/pic
mkdir -p $pic_dir
cd $tmpDir

DISK_FREE=`df -k`
echo "$0:DF done"
PARTS=`probepart3 -k 2> /dev/null | grep '^/dev/' | grep -vE "none|Extended|Ext'd|swap|not inserted|unknown|squashfs" | cut -f 1-3 -d '|'`
echo "$0:PROBEPART done"

PARTINFO="<hbox><text><label>Free</label></text><pixmap><input file>$tmpDir/partview_top.gif</input></pixmap></hbox>"
if [ ! -f $tmpDir/partview_top.gif ];then
 ppmrough -width 100 -height 16 -var 1 -bg red -fg grey80 -left 0 | ppmlabel -background transparent -color red -size 10 -y 13 -x 0 -text "Used" -background transparent -color red -size 10 -y 13 -x 1 -text "Used" | ppmtogif > $tmpDir/partview_top.gif
fi
echo "$0: DONE"

#xmessage -center -bg orange -buttons "" "Please wait, processing. Don't mount or unmount any drives..." &
#XPID=$!
#echo START

OLD_IFS="$IFS"
IFS='|'

time while read device fs size ; do
[ "$device" -a "$fs" -a "$size" ] || continue
echo -n "'$device' '$fs' '$size' "
MST='';echo "$DISK_FREE" | grep -q -w "$device" && MST=ON || MST=OFF;echo -n "'$MST' "

if [ "$MST" = OFF ]; then
 [ ! "${fs//[FfAaTt0-9]/}" ] && fs=vfat
 #mount_original -t $fs $device /mnt/data
 mount-FULL -t $fs -o ro $device /mnt/data
 [ $? = 0 ] || continue
 USEDK=`df -k /mnt/data | grep -m1 -w "$device" | awk '{print $3}'`
 #umount_original $device
 umount-FULL -dr $device
else
 USEDK=`echo "$DISK_FREE" |grep -m1 -w "$device" |awk '{print $3}'`
fi
echo -n "'$USEDK' "
FREEK=$((size - USEDK))
if [ $FREEK -gt 1048576 ];then #1024*1024
  LANG=C ONEFREE=`dc $FREEK 1048576 \/ p`
  ONEFREE="`printf "%.1f" $ONEFREE`G"
elif [ $FREEK -gt 2880 ];then
  LANG=C ONEFREE=`dc $FREEK 1024 \/ p`
  ONEFREE="`printf "%.1f" $ONEFREE`M"
else
  ONEFREE="`printf "%.1f" $FREEK`K"
fi
echo "'$ONEFREE'"

# echo "$ONEFREE" >$tmpDir/${device//\//_}.free
# diff -q $tmpDir/${device//\//_}.free $tmpDir/${device//\//_}.free.old 2>$ERR || {

ppmrough -width 100 -height 14 -var 1 -bg red -fg grey80 -left $(((100*USEDK)/size)) | ppmtogif > $pic_dir/partview_${device//\//_}.gif

# }
# echo "$ONEFREE" >$tmpDir/${device//\//_}.free.old

PARTINFO="${PARTINFO}
<hbox><text><label>${device##*/} ${ONEFREE}</label></text><pixmap><input file>$pic_dir/partview_${device//\//_}.gif</input></pixmap></hbox>"

done<<EOI
$(echo "$PARTS")
EOI

IFS="$OLD_IFS"
kill -9 $XPID 1>$OUT 2>$ERR
#/bin/kill `jobs -p` #1>/dev/null 2>$ERR
#kill `jobs -p`
echo "$0:END"
#IFS="$OLD_IFS"

export PARTVIEW_GTKDLG="<window title=\"Partview\" icon-name=\"gtk-harddisk\">
 <vbox>
  ${PARTINFO}
 </vbox>
</window>"

gtkdialog4 --program=PARTVIEW_GTKDLG


