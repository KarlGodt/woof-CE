#!/bin/sh
#Barry Kauler LGPL 2007

  _TITLE_=pup_generate_modem_init_string
_COMMENT_="CLI to generate 'Q0V1E1' 'Z' 'S0=0' '&C1' '&D2' 'S11=55' '+FCLASS=0' INIT"

MY_SELF="$0"

test -f /etc/rc.d/f4puppy5 && source /etc/rc.d/f4puppy5
#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0 "$_COMMENT_"
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************


#the idea is to probe modem and determine a suitable hayes command init string.

[ ! -e /dev/modem ] && { echo "NEEDED /dev/modem does not exist.";exit 1; }

modem_stats_func() {
 #modem-stats has a serious bug, if return string not 'OK' then it never terminates.
 local CNTLP=1
 rm $VERB -f /tmp/modemstatsret
 modem-stats $@ >/tmp/modemstatsret &
 MPID=$!
 while [ 1 ];do
  sleep 1
  [ "`grep '^[A-Z].*' /tmp/modemstatsret`" != "" ] && break
  [ $CNTLP -gt 5 ] && break
  CNTLP=`expr $CNTLP + 1`
 done
 #may need a bit more time to receive all returns from modem...
 [ "`grep -E '^OK|^ERROR' /tmp/modemstatsret`" = "" ] && sleep 1
 kill $MPID > /dev/null 2>&1
 cat /tmp/modemstatsret
}

[ "`modem_stats_func -c 'ATZ' /dev/modem | grep '^OK$'`" = "" ] && exit

ALLSTR=""
for oneSTEP in 'Q0V1E1' 'Z' 'S0=0' '&C1' '&D2' 'S11=55' '+FCLASS=0'
do
 if [ "`modem_stats_func -c "AT$oneSTEP" /dev/modem | grep '^OK$'`" = "" ];then
  modem_stats_func -c 'ATZ' /dev/modem #maybe wise to reset modem.
  continue
 fi
 [ "$oneSTEP" = "Z" ] && continue
 ALLSTR="$ALLSTR$oneSTEP"
done

#NO, the problem with country codes is there does not seem to be one standard.
#the codes differ, also Hayes command for querying the current code differs,
#also some modems are hardwired for a particular country and will not accept
#any country code.
##country code...
SETCOUNTRY=""
#if [ -f /etc/countryinfo ];then
# . /etc/countryinfo
# if [ "`modem_stats_func -c 'ATI7' /dev/modem | grep 'Country'`" != "" ];then
#  ATCODE="AT+GCI=${MODEM_COUNTRY_CODE}"
#  [ "`modem_stats_func -c "$ATCODE" /dev/modem | grep '^OK$'`" != "" ] && SETCOUNTRY="+GC1=${MODEM_COUNTRY_CODE}"
# fi
# modem_stats_func -c 'ATZ' /dev/modem #maybe wise to reset modem.
#fi

#But, some firmware scripts in /etc/init.d/ do write a country string to
#/etc/countryinfo...
if [ -f /etc/countryinfo ];then
 . /etc/countryinfo
 if [ "$MODEM_COUNTRY_STRING" ];then
  SETCOUNTRY=`echo -n "$MODEM_COUNTRY_STRING" | sed -e 's/^AT/ /'`
 fi
fi

echo -n "AT$ALLSTR$SETCOUNTRY" > /tmp/mymodeminitstring
cat /tmp/mymodeminitstring
###END###
