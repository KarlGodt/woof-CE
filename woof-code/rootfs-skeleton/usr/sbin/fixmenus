#!/bin/sh
#v2.14 Puppy now has XDG menus.
# this script builds the menus from template files.
# Any templates can be placed into /etc/xdg/templates, and the file must be
# named to show its final destination. For example, the template for JWM:
# _root_.jwmrc
# ...the '_' will be converted to a '/', so the generated JWM config file is:
# /root/.jwmrc
#5jan2008: fbpanel,lxpanel support developed by plinej.

__old_header__(){  #BEGIN
trap "exit 1" HUP INT QUIT KILL TERM

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = "2" ] && set -x

Version='1.1'

usage(){
USAGE_MSG="
$0 [ PARAMETERS ]

-V|--version : showing version information
-H|--help : show this usage information

*******  *******  *******  *******  *******  *******  *******  *******  *******
$2
"
exit $1
}

[ "`echo "$1" | grep -wE "\-help|\-H"`" ] && usage 0
[ "`echo "$1" | grep -wE "\-version|\-V"`" ] && { echo "$0 -version $Version";exit 0; }
}  ###__old_header__(){  #END

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="CLI script to rewrite Windowmanager configuration files."
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
}

TEMPLATES="`ls -1 /etc/xdg/templates | tr '\n' ' '`"

for oneTPL in $TEMPLATES
do
 [ "$oneTPL" = "README.txt" ] && continue
 oneDEST="`echo -n "$oneTPL" | sed -e 's/_/\//g'`"
 oneSRC="/etc/xdg/templates/$oneTPL"
 echo "Generating $oneDEST..."

 [ -f $oneDEST ] && mv -f $oneDEST ${oneDEST}-previous

 cat $oneSRC |
 while read oneLINE
 do
  EXECMENU="`echo -n "$oneLINE" | grep -o 'PUPPYMENU.*' | cut -f 2-5 -d ' '`"
  echo "$EXECMENU"
  if [ "$EXECMENU" = "" ];then
   echo "appending '$oneLINE' to $oneDEST"
   echo "$oneLINE" >> $oneDEST
  else
   echo "else ...?"
   ${EXECMENU} >> ${oneDEST}
  fi
 done

done

#w001 support for fbpanel, lxpanel, openbox, fluxbox, pekwm...
[ "`which tempicons`" ] && tempicons
#which tempicons
[ "`which fbpanel_menu_refresh`" ] && fbpanel_menu_refresh
#which fbpanel_menu_refresh
[ "`which lxpanel_menu_refresh`" ] && lxpanel_menu_refresh
#which lxpanel_menu_refresh
[ "`which jwm2fluxbox`" ] && jwm2fluxbox  ##current fluxbox_menu_refresh doesn't support menu icons while this does
#which jwm2fluxbox
[ "`which obmenu-refresh`" ] && obmenu-refresh
#which obmenu-refresh
[ "`which jwm2pekwm`" ] && jwm2pekwm
#which jwm2pekwm

###END###
