#!/bin/bash
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_ayttm_streamer_wrapper"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/bin/ayttm_streamer_wrapper"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#

make_rcfile()
{
	file=$1
	outdir=$2/webcam
	[ ! -e $outdir ] && mkdir $outdir
	cat >$file <<EOF
[ftp]
dir  = $outdir
file = webcam.jpeg
tmp  = uploading.jpeg
local = 1

[grab]
device = /dev/video0
text = "webcam %Y-%m-%d %H:%M:%S"
width = 320
height = 240
delay = 3
quality = 75
EOF

}

RCFILE=~/.webcamrc
[ "$1" = "-d" ] && AYTTM_DIR=$2 || AYTTM_DIR=~/.ayttm

[ ! -e $RCFILE ] && make_rcfile $RCFILE $AYTTM_DIR

if ! ps -u $UID | grep -q webcam >/dev/null; then
	/usr/bin/webcam &>/dev/null &
fi
ps -u $UID | grep -q webcam >/dev/null || exit -1

IMGDIR=$( sed -ne "/.*\<dir *= */{s///;p
}" $RCFILE )
if ! echo $IMGDIR | sed -e 's,^~/,,' | grep -q "^/" >/dev/null; then
	IMGDIR=$HOME/$IMGDIR
fi
IMGFILE=$( sed -ne "/.*\<file *= */{s///;p
}" $RCFILE )

cat $IMGDIR/$IMGFILE || exit -1

exit 0

#LOCK=$AYTTM_DIR/webcam_grab.lock
#[ -e $LOCK ] && exit 0
#touch $LOCK

#/usr/bin/streamer -q -f jpeg -o /dev/stdout OUTFILE 2>/dev/null
#rm -f $LOCK

#exit 0
