#!/bin/sh

#convert a .tar.gz file to .pet...
#passed param is file to be converted.
#this works for md5sum returning 8-bit characters!

########################################################################
#
# ADDS/CHANGES by Karl Godt :
#
# TOTAL TODO
#
# /dev/sda1:
# UUID="0C18A53918A52326"
# /dev/sda7:
# UUID="2dfe19a9-7a5c-48aa-9e81-3758c67b12f6"
# /dev/sda9:
# UUID="e29717d3-b775-4dc8-9643-42a862f2b34f"
# /dev/sda2:
# LABEL="2nd"
# UUID="a4f28ea3-eede-49f8-93ca-dbeefe8f72fa"
# /dev/sda10:
# UUID="193a7e6b-8626-493e-8b77-940211a8fc9d"
# /dev/sda6:
# LABEL="1stLogicalPartit"
# UUID="8efb5611-ffb4-41ca-b8ef-8e64769ce9ef"
# /dev/sda3:
# LABEL="3rd"
# UUID="f711a43e-c5dc-4f92-84dc-6824feeb690c"
# /dev/sda11:
# LABEL="store"
# UUID="51600f00-d3cc-4fba-ba77-c34b0c94502c"
# /dev/sda8:
# UUID="7b5cd9dd-54c7-4d03-af79-566588111fcb"
# /dev/sda5:
# LABEL="1stSWAP"
# DISTRO_VERSION=430·#481·#416·#218·#478······#####change·this·as·required#####
# DISTRO_BINARY_COMPAT="puppy"·#"ubuntu"·#"puppy"·#####change·this·as·required#####
# case·$DISTRO_BINARY_COMPAT·in
# ubuntu)
# DISTRO_NAME="Jaunty·Puppy"
# DISTRO_FILE_PREFIX="upup"
# DISTRO_COMPAT_VERSION="jaunty"
# ;;
# debian)
# DISTRO_NAME="Lenny·Puppy"
# DISTRO_FILE_PREFIX="dpup"
# DISTRO_COMPAT_VERSION="lenny"
# ;;
# slackware)
# DISTRO_NAME="Slack·Puppy"
# DISTRO_FILE_PREFIX="spup"
# DISTRO_COMPAT_VERSION="12.2"
# ;;
# arch)
# DISTRO_NAME="Arch·Puppy"
# DISTRO_FILE_PREFIX="apup"
# DISTRO_COMPAT_VERSION="200904"
# ;;
# t2)
# DISTRO_NAME="T2·Puppy"
# DISTRO_FILE_PREFIX="tpup"
# DISTRO_COMPAT_VERSION="puppy5"
# ;;
# puppy)·#built·entirely·from·Puppy·v2.x·or·v3.x·or·4.x·pet·pkgs.
# DISTRO_NAME="Puppy"
# DISTRO_FILE_PREFIX="pup"·#"ppa"·#"ppa4"·#"pup2"··#pup4··###CHANGE·AS·REQUIRED,·recommend·limit·four·characters###
# DISTRO_COMPAT_VERSION="4"·#"2"··#4·····###CHANGE·AS·REQUIRED,·recommend·single·digit·5,·4,·3,·or·2###
# ;;
# esac
# PUPMODE=2
# KERNVER=2.6.30.9-i586-dpup005-Celeron2G
# SATADRIVES='·sda'
# USB_SATAD=''
# PUP_HOME='/'
# PDEV1='sda2'
# Linux·puppypc·2.6.30.9-i586-dpup005-Celeron2G·#6·SMP·Sat·Jan·15·13:35:51·GMT-8·2011·i686·GNU/Linux
# Xserver=/usr/X11R7/bin/Xorg
# $LANG=de_DE@euro
# today=Sa·21.·Apr·19:35:49·GMT+1·2012
#
#
#
#
#
########################################################################

usage (){
    echo "
$0 [-g|-b|-l|-h|-s|-S|-X|-x|-Z|-z] TARFILE.tar.EXT
    -g) gzip (default) '`which gzip`'
    -b) bzip2          '`which bzip2`'
    -h) help: show this usage
    -l) lzop           '`which lzop`'
    -L) lzma           '`which lzma`'
    -s) squashfs3 gz   '`which mksquashfs3`'
    -S) squashfs4 gz   '`which mksquashfs4`'
    -X) squashfs4 xz   '`which mksquashfs4`'
    -x) xz             '`which xz`'
    -Z) compress       '`which compress`'
    -z) zip            '`which zip`'
    Script to create a .pet with the above compressions.
    Without option given,defaults to the old and proven gzip
    compression.
    -d) debug through 'set -x'
    -v) verbose output and options to binaries
    "
    exit $1
}

while getopts gbhlLsSXxZzdv opt;do
case $opt in
g) COMPRESS_BIN='gzip';OPT='-g';EXT='.gz';PET_EXT='.pet';;
b) COMPRESS_BIN='bzip2';OPT='-b';EXT='.bz2';PET_EXT='.b2pet';;
h) usage 0;;
l) COMPRESS_BIN='lzop';OPT='-l';EXT='.lzo';PET_EXT='.lopet';;
L) COMPRESS_BIN='lzma';OPT='-L';EXT='.lzma';PET_EXT='.lapet';;
s) COMPRESS_BIN='mksquashfs3';PET_EXT='.s3pet';;
S) COMPRESS_BIN='mksquashfs4';PET_EXT='.s4pet';;
X) COMPRESS_BIN='mksquashfs4';COMPRESS_OPT='xz';PET_EXT='.s4xpet';;
x) COMPRESS_BIN='xz';OPT='-x';EXT='.xz';PET_EXT='.xzpet';;
z) COMPRESS_BIN='zip';OPT='-z';EXT='.zip';PET_EXT='.zipet';;
Z) COMPRESS_BIN='compress';OPT='-Z';EXT='.Z';PET_EXT='.Zpet'
if [ ! "`which $COMPRESS_BIN`" ];then
COMPRESS_BIN='tar'
["`$COMPRESS_BIN --help |grep -w '\-Z'`" ] || COMPRESS_BIN='';fi
;;
d) set -x;;
v) VERBOSE='-v';LONG_VERBOSE='--verbose';OUTPUT='&2';;
*) usage 1;;
esac;done

while [ "$2" ];do shift;done #leave only the last argument

if [ ! "$COMPRESS_BIN" ];then
#automatic detection
AEXT="${1##*\.}";echo "AEXT='$AEXT'"
case $AEXT in
gz|tgz|tar) COMPRESS_BIN='gzip'; OPT='-g';EXT='.gz'; PET_EXT='.pet';;
bz2)        COMPRESS_BIN='bzip2';OPT='-b';EXT='.bz2';PET_EXT='.b2pet';;

lzo|tzo|lzop)           COMPRESS_BIN='lzop';OPT='-l';EXT='.lzo'; PET_EXT='.lopet';;
lzx|lza|lzm|lzma|lzma2) COMPRESS_BIN='lzma';OPT='-L';EXT='.lzma';PET_EXT='.lapet';;
lzw)        COMPRESS_BIN=compress-4.2;; ##like .Z (?)
lha|lza)    COMPRESS_BIN=lha;;
lz|lzp|lzip)COMPRESS_BIN=lzip;;

xz)  COMPRESS_BIN='xz';      OPT='-x';EXT='.xz'; PET_EXT='.xzpet';;
z|Z) COMPRESS_BIN='compress';OPT='-Z';EXT='.Z';  PET_EXT='.Zpet'
zip) COMPRESS_BIN='zip';     OPT='-z';EXT='.zip';PET_EXT='.zipet'
if [ ! "`which $COMPRESS_BIN`" ];then
COMPRESS_BIN='tar'
[ "`$COMPRESS_BIN --help |grep -w '\-Z'`" ] || COMPRESS_BIN='';fi
;;
esac
fi

[ "$COMPRESS_BIN" ] || { COMPRESS_BIN='gzip';EXT='.gz';PET_EXT='.pet'; }
[ "`which $COMPRESS_BIN`" ] || { echo "'$COMPRESS_BIN' apparenty not installed (in the PATH)";exit 1; }
[ -e "$1" ] || { echo "'$1' seems not to exist";exit 1; }
[ -f "$1" ] || { echo "'$1' not a regular file ?";exit 1; }
[ -s "$1" ] || { echo "'$1' appears to be empty ?";exit 1; }
sync
TARBALL=$1
chmod +w $TARBALL #make it writable.

#only accept .tgz or .tar.gz files...
#EXT=''
case $COMPRESS_BIN in
gzip)
[ "`echo -n "$TARBALL" | grep '\\.tar\\.gz$'`" ] && TEXT='.tar.gz'
[ "`echo -n "$TARBALL" | grep '\\.tgz$'`" ] && TEXT='.tgz'
[ "`echo -n "$TARBALL" | grep '\\.tar$'`" ] && TEXT='.tar'
[ "$TEXT" ] || usage 1
;;
bzip2)
[ ! "`echo -n "$TARBALL" | grep '\\.tar\\.bz2$'`" = "" ] && TEXT='.tar.bz2'
[ "$TEXT" ] || usage 1
;;
lzop)
[ "`echo -n "$TARBALL" | grep '\\.tar\\.lzo$'`" ] && TEXT='.tar.lzo'
[ "`echo -n "$TARBALL" | grep '\\.tzo$'`"] && TEXT='.tzo'
[ "$TEXT" ] || usage 1
;;
lzma)
[ "`echo -n "$TARBALL" | grep '\\.tar\\.lzma$'`" ] && TEXT='.tar.lzma'
[ "$TEXT" ] || usage 1
;;
mksquashfs3)
[ "`echo -n "$TARBALL" | grep '\\.tar\\.gz$'`" ] && TEXT='.tar.gz'
[ "$TEXT" ] || usage 1
;;
mksquashfs4)
 case $COMPRESS_OPT in
  xz)
   [ "`echo -n "$TARBALL" | grep '\\.tar\\.gz$'`" ] && TEXT='.tar.gz'
   [ "$TEXT" ] || usage 1;;
  ""|*)
   [ "`echo -n "$TARBALL" | grep '\\.tar\\.gz$'`" ] && TEXT='.tar.gz'
   [ "$TEXT" ] || usage 1;;
 esac
;;
xz)
[ "`echo -n "$TARBALL" | grep '\\.tar\\.xz$'`" ] && TEXT='.tar.xz'
[ "$TEXT" ] || usage 1
;;
esac



#split TARBALL path/filename into components...
BASEPKG="`basename $TARBALL $TEXT`"
DIRPKG="`dirname $TARBALL`"
[ "$DIRPKG" = "/" ] && DIRPKG=""

#perhaps makes following code easier if do this...
if [ "$TEXT" = ".tgz" ];then
 mv -f $TARBALL $DIRPKG/${BASEPKG}.tar.gz
 TARBALL="$DIRPKG/${BASEPKG}.tar.gz"
 TEXT='.tar.gz'
fi
if [ "$TEXT" = ".tzo" ];then
 mv -f $TARBALL $DIRPKG/${BASEPKG}.tar.lzo
 TARBALL="$DIRPKG/${BASEPKG}.tar.lzo"
 TEXT='.tar.lzo'
fi
if [ "$TEXT" = ".tar" ];then
 $COMPRESS_BIN $TARBALL
 TARBALL="$DIRPKG/${BASEPKG}.tar${EXT}"
 TEXT=".tar${EXT}"
fi
echo "TARBALL='$TARBALL' TEXT='$TEXT' EXT='$EXT' PET_EXT='$PET_EXT'"
#if tarball expands direct to '/' want to wrap around it (slackware pkg)...
if [ "`tar --list -f $TARBALL | head -n 1`" = "./" ];then
 [ -d $DIRPKG/$BASEPKG ] && rm -rf $DIRPKG/$BASEPKG #a bit radical
 #[ -d $DIRPKG/$BASEPKG ] && exit 1
 mkdir $DIRPKG/$BASEPKG
 mv $DIRPKG/${BASEPKG}${TEXT} $DIRPKG/$BASEPKG/
 #can put other files in here if want...

 tar --remove-files -c -f $DIRPKG/${BASEPKG}.tar $DIRPKG/$BASEPKG/
 $COMPRESS_BIN $DIRPKG/${BASEPKG}.tar
 rmdir $DIRPKG/$BASEPKG
fi

FULLSIZE="`stat --format=%s ${TARBALL}`"
MD5SUM="`md5sum $TARBALL | cut -f 1 -d ' '`"
echo -n "$MD5SUM" >> $TARBALL
sync
#NEWNAME="`echo -n "${TARBALL}" | sed -e 's/\\.tar\\.gz$/\\.pet/g'`"
#mv -f $TARBALL $NEWNAME
mv -f $TARBALL $DIRPKG/${BASEPKG}${PET_EXT}
sync

###END###
