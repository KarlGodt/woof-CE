#!/bin/sh
#Barry Kauler (c) Copyight 2007,2009 www.puppylinux.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#This script will create a PET package.
#Just create a directory with the name of the package, for example 'abiword-0.5.6'
#and put what you want in it.
#It should have abiword-0.5.6/usr/share/applications/abiword.desktop if the
#application requires a menu entry, but if there isn't one this script will ask
#some simple questions and create one.
#This script will also create abiword-0.5.6/pet.specs, which has
#some information useful to the Puppy Package Manager.
#w476, w478 fixes to work with petspec.
#w482 if preexisting pet.specs, read fields from it.
#set -x
Version='1.1-getopts Puppy-Linux-431 KRG'



#************
#KRG


OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x


Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }


trap "exit" HUP INT QUIT ABRT KILL TERM


#KRG
#************


usage (){
	MSG="
	$0 [-f|-g|-b|-l|-h|-s|-S|-X|-x] DIRECTORY/
	-g) gzip (default) '`which gzip`'
	-b) bzip2          '`which bzip2`'
	-h) help: show this usage
	-f) force : answer all questions with yes
	    don't show pkgdb pet.specs entry in editor .
	-l) lzop           '`which lzop`'
	-L) lzma           '`which lzma`'
	-s) squashfs3 gz   '`which mksquashfs3`'
	-S) squashfs4 gz   '`which mksquashfs4`'
	-X) squashfs4 xz   '`which mksquashfs4`'
	-x) xz             '`which xz`'
	Script to create a .pet with the above compressions.
	Without option given,defaults to the old and proven gzip
	compression.
	-d) debug through 'set -x'
	-v) verbose output and options to binaries
	-V) Print version information
	"
	[ "$2" ] && MSG="$MSG
	$2"
	echo "$MSG"
	exit $1
}

[[ "$1" =~ 'help' ]] && usage 0
#echo "$1"
#[[ "$1" =~ "vers" ]] && { echo "$0 : $Version";exit 0; }
[ "`echo "$1" | grep -i 'version'`" ] && { echo "$0 : $Version";exit 0; }

OUT='/dev/null';ERR='/dev/null'
while getopts fgbhlLsSXxdvV opt;do
case $opt in
g) COMPRESS_BIN='gzip';OPT='-g';EXT='.gz';PET_EXT='.pet';;
b) COMPRESS_BIN='bzip2';OPT='-b';EXT='.bz2';PET_EXT='.b2pet';;
h) usage 0;;
f) FORCE=1;TOUT='-t 1';;
l) COMPRESS_BIN='lzop';OPT='-l';EXT='.lzo';PET_EXT='.lopet';;
L) COMPRESS_BIN='lzma';OPT='-L';EXT='.lzma';PET_EXT='.lapet';;
s) COMPRESS_BIN='mksquashfs3';OPT='-s';EXT='.sfs3';PET_EXT='.s3pet';;
S) COMPRESS_BIN='mksquashfs4';OPT='-S';EXT='.sfs4';PET_EXT='.s4pet';;
X) COMPRESS_BIN='mksquashfs4';OPT='-X';EXT='.sfs4x';COMPRESS_OPT='xz';PET_EXT='.s4xpet';;
x) COMPRESS_BIN='xz';OPT='-x';EXT='.xz';PET_EXT='.xzpet';;
d) set -x;DEBUG=1;;
v) ME_VERB=1;VERBOSE='-v';LONG_VERBOSE='--verbose';OUTPUT=/dev/stderr;OUT=/dev/stdout;ERR=/dev/stderr;;
V) echo "$0 : $Version";exit 0;;
*) usage 1;;
esac;done

[ "$COMPRESS_BIN" ] || { COMPRESS_BIN='gzip';EXT='.gz';PET_EXT='.pet'; }
[ "`which $COMPRESS_BIN`" ] || { echo "'$COMPRESS_BIN' apparenty not installed (in the PATH)";exit 1; }

#[ "$2" ] && shift
#for i in `seq 2 1 $#`;do shift;done
while [ "$2" ];do shift;done #leave only the last argument
if [ ! $1 ];then
 echo "It is required to invoke this script like this:
# dir2pet abiword-0.5.6
where abiword-0.5.6 is a directory in the same directory
in which this terminal window is open. 'abiword-0.5.6' is
just an example, and contains subdirectories and files
that will become the PET package."
 exit 1
fi

if [ ! -d $1 ];then
 echo "$1 must be a directory"
 exit 1
fi

ADIR=$1
MYPID=${$}

#split ADIR path/filename into components...
BASEPKG=`basename $ADIR`
DIRPKG=`dirname $ADIR`
[ "$DIRPKG" = "/" ] && DIRPKG=""

#w482 directory may already have a pet.specs, reuse it...
NAMEONLY=""
PUPMENUDESCR=""
PUPOFFICIALDEPS=""
PUPCATEGORY=""
[ "$FORCE" ] && rm -f ${1}/pet.specs
if [ -f ${1}/pet.specs ];then
 #new: pkgname|nameonly|version|pkgrelease|category|size|path|fullfilename|dependencies|description|
 #optionally on the end: compileddistro|compiledrelease|repo| (fields 11,12,13)
 PETSPECS=`cat ${1}/pet.specs | head -n 1`
 DB_pkgname=`echo -n "$PETSPECS" | cut -f 1 -d '|'`
 DB_nameonly=`echo -n "$PETSPECS" | cut -f 2 -d '|'`
 NAMEONLY="$DB_nameonly"
 DB_version=`echo -n "$PETSPECS" | cut -f 3 -d '|'`
 DB_pkgrelease=`echo -n "$PETSPECS" | cut -f 4 -d '|'`
 DB_category=`echo -n "$PETSPECS" | cut -f 5 -d '|'`
 PUPCATEGORY="$DB_category"
 DB_size=`echo -n "$PETSPECS" | cut -f 6 -d '|'`
 DB_path=`echo -n "$PETSPECS" | cut -f 7 -d '|'`
 DB_fullfilename=`echo -n "$PETSPECS" | cut -f 8 -d '|'`
 DB_dependencies=`echo -n "$PETSPECS" | cut -f 9 -d '|'`
 PUPOFFICIALDEPS="$DB_dependencies"
 DB_description=`echo -n "$PETSPECS" | cut -f 10 -d '|'`
 PUPMENUDESCR="$DB_description"
 DB_compileddistro=`echo -n "$PETSPECS" | cut -f 11 -d '|'`
 DB_compiledrelease=`echo -n "$PETSPECS" | cut -f 12 -d '|'`
 DB_repo=`echo -n "$PETSPECS" | cut -f 13 -d '|'`
fi

#difficult task, separate package name from version part...
#not perfect, some start with non-numeric version info...
[ "$NAMEONLY" = "" ] && NAMEONLY=`echo -n "$BASEPKG" | sed -e 's/\-[0-9].*$//g'`
#...if that fails, do it the old way...
[ "$NAMEONLY" = "$BASEPKG" ] && NAMEONLY=`echo "$BASEPKG" | cut -f 1 -d "-"`

[ "$DEBUG" ] || clear
echo "Welcome to the 'dir2pet' script."
if [ ! "$FORCE" ];then
echo "This will convert a directory into a PET package. Example, you have a
directory named 'abiword-0.5.6' and inside that you place whatever is
needed for the package, for example usr/local/bin/abiword (the executable)
and usr/share/applications/abiword.desktop (the XDG menu file).
Whatever the packages needs, though don't worry if there is no .desktop
file as this script will ask some simple questions and optionally create
one. The package only needs a .desktop file if a menu entry is to be
created, and also a 16x16 pixel icon is required for the menu.
It is preferred that the icon be an xpm image and the default location
for these is at /usr/local/lib/X11/mini-icons/, but it can be anywhere.

The directory $BASEPKG must separate name of the package and
version number with a dash. Ex: abiword-0.5.6

The package may optionally have post-install and post-remove scripts,
named 'pinstall.sh' and 'puninstall.sh' placed at the top directory.
(to create official PETs for the Unleashed suite, see its README file
 for more information how to create these scripts properly)"
fi
echo
echo "If any of the above needs to be further sorted out, you can quit this"
echo "script right now by pressing CTRL-C, otherwise just press ENTER."
echo -n "Press ENTER key to continue: "
read $TOUT goforit

. /etc/xdg/menus/hierarchy #has PUPHIERARCHY variable.

DESKTOPFILE=""
ADESKTOPFILE=`find $ADIR -type f -name \*.desktop`
[ "$ADESKTOPFILE" ] && DESKTOPFILE="yes"

echo
echo -en "\\033[1;31mStep 1" #red
echo -e "\\033[0;39m"
if [ "$DESKTOPFILE" = "" ];then
 echo "Currently there is no .desktop file (they are usually at usr/share/applications"
 if [ ! "$FORCE" ];then
 echo "or usr/local/share/applications), so perhaps this package is not supposed to
have a menu entry? You can optionally create one though...
If you know that the ${BASEPKG} application does not require
a menu entry, press the ENTER key only.
If a menu entry is required, type any printable character then ENTER.
(if in doubt, just press ENTER key)"
 echo -n "Type a printable character or just ENTER key: "
 read $TOUT YESMENU
 [ "$YESMENU" ] || DESKTOPFILE=""
 fi
else #w476
 echo "A .desktop file was found here:"
 echo "$ADESKTOPFILE"
 if [ ! "$FORCE" ];then
 echo "So this application will have a menu entry.
If you want to change the .desktop file in any way, open it in a text editor
right now, before proceeding and make any changes you want.
In particular, check that the icon exists, and that 'Category' entry fits
into Puppy's menu hierarchy (see file /etc/xdg/menus/hierarchy).
After satisfying yourself that the .desktop file is ok, press the ENTER key
to continue this script."
 #echo "Or, type 'ignore' to build pet pkg as if there is no .desktop file."
 fi
 echo "Or, type 'ignore' to build pet pkg as is"
 echo "Or, type 'new' if you would like this script to ask a series of"
 echo -n "questions and rebuild the .desktop file from scratch: "
 read $TOUT NEWMENU
 [ "$NEWMENU" ] || DESKTOPFILE=""
 [ "$NEWMENU" = "ignore" ] && DESKTOPFILE="" #w478
 if [ "$NEWMENU" = "new" ];then
  for ONEDESKTOP in $ADESKTOPFILE
  do
   BASEDESK=`basename $ONEDESKTOP .desktop`
   DIRDESK=`dirname $ONEDESKTOP`
   echo "Moving ${DIRDESK}/${BASEDESK}.desktop to /tmp"
   mv -f ${DIRDESK}/${BASEDESK}.desktop /tmp/
  done
  DESKTOPFILE="new"
 fi
fi

PUPAPPLICATION=""
PUPEXECUTABLE=""
PUPICON16=""
PUPAPPLICATION=""
if [ "$DESKTOPFILE" = "yes" ];then #w476
 #get some info out of it...
 FIRSTDESKTOPFILE=`echo -n "$ADESKTOPFILE" | head -n 1`
 PUPCATEGORY=`cat $FIRSTDESKTOPFILE | grep '^Categories=' | cut -f 2 -d '='`
 PUPEXECUTABLE=`cat $FIRSTDESKTOPFILE | grep '^Exec=' | cut -f 2 -d '='`
 PUPICON16=`cat $FIRSTDESKTOPFILE | grep '^Icon=' | cut -f 2 -d '='`
 PUPMENUDESCR=`cat $FIRSTDESKTOPFILE | grep '^Comment=' | cut -f 2 -d '='`
 [ "$PUPMENUDESCR" = "" ] && PUPMENUDESCR=`cat $FIRSTDESKTOPFILE | grep '^Name=' | cut -f 2 -d '='`
 [ "$PUPMENUDESCR" = "" ] && PUPMENUDESCR=`cat $FIRSTDESKTOPFILE | grep '^GenericName=' | cut -f 2 -d '='`
fi

if [ "$DESKTOPFILE" ];then
 echo
 echo -en "\\033[1;31mStep 1B" #red
 echo -e "\\033[0;39m"
 echo "Please type the category in which you want the application"
 echo "to create a window manager menu entry. The official Puppy"
 echo "has a menu hierarchy as follows:"
 echo "('X-' categories are unofficial, Puppy-specific)"
 echo "$PUPHIERARCHY"
 echo
 echo -n "Type one word from the CATEGORIES column: "
 read $TOUT PUPCATEGORY

 echo
 echo -en "\\033[1;31mStep 1C" #red
 echo -e "\\033[0;39m"
 echo "Please enter the name of the executable. If it is in the
executable-search-path, namely /bin, /sbin, /usr/bin,
/usr/sbin, /root/my-applications/bin or /usr/local/bin,
then you only need to enter the name of the executable
not the path. Example: mtpaint
(of course, if you need to specify the path here, it is
 the path AFTER the package is installed)"
 echo
 echo -n "Enter [path]executable: "
 read $TOUT PUPEXECUTABLE

 echo
 echo -en "\\033[1;31mStep 1D" #red
 echo -e "\\033[0;39m"
 echo "Please enter the name of the icon that is to be used in
the window manager menu entry. This must be a 16x16 pixel
.xpm file (.png okay but not suitable all window managers).
If this icon is located at /usr/local/lib/X11/mini-icons
then there is no need to specify the path.
If the icon is located elsewhere then the full path must
be provided. An example: the package gfnrename-0.4 installs
a 16x16 icon at /usr/local/gfnrename-0.4/icon.xpm
(of course, if you need to specify the path here, it is
 the path AFTER the package is installed)
IT MUST BE A 16x16 PIXEL ICON, NO BIGGER!"
 echo
 echo -n "Please type [path]icon: "
 read $TOUT PUPICON16

 echo
 echo -en "\\033[1;31mStep 1E" #red
 echo -e "\\033[0;39m"
 echo "Please enter the name of the application, as you wish it to"
 echo "appear in the menu. It will be the first word in the menu entry."
 echo "Example: Abiword"
 echo
 echo -n "Type application name: "
 read $TOUT PUPAPPLICATION
fi

if [ "$PUPMENUDESCR" = "" ];then #w476
 echo
 echo -en "\\033[1;31mDescription" #red
 echo -e "\\033[0;39m"
 echo "Please enter a description of 1-3 words."
 if [ "$DESKTOPFILE" = "" ];then
  echo "This must be extremely short. as it will appear in the window"
  echo "manager menu entry immediately after the application name."
 fi
 echo "This may be used for various purposes, such by PETget for package"
 echo "management purposes."
 echo "Example for Abiword: powerful wordprocessor"
 echo
 echo -n "Type the VERY SHORT description (without quotes): "
 read $TOUT PUPMENUDESCR
#else
# echo "A description of the package has been extracted:"
# echo " '${PUPMENUDESCR}'"
# echo "This will be placed in the package database entry. Press ENTER if ok,"
# echo -n "or type an alternative very short description: "
# read NEWDESCR
# if [ "$NEWDESCR" != "" ];then
#  PUPMENUDESCR="$NEWDESCR"
# fi
fi

echo

#if pkg is a split-off, already has a known dependency...
DEPBASE="";DEPNOTE=""
[ "`echo -n "$NAMEONLY" | grep '_DEV'`" ] &&  DEPBASE="+`echo -n "$NAMEONLY" | sed -e 's/_DEV//g'`"
[ "`echo -n "$NAMEONLY" | grep '_DOC'`" ] &&  DEPBASE="+`echo -n "$NAMEONLY" | sed -e 's/_DOC//g'`"
[ "`echo -n "$NAMEONLY" | grep '_NLS'`" ] &&  DEPBASE="+`echo -n "$NAMEONLY" | sed -e 's/_NLS//g'`"
if [ "$DEPBASE" ];then
 DEPNOTE="NOTE5: It is strongly suggested that you at least enter ${DEPBASE}
       the main package
"
fi

if [ "$PUPOFFICIALDEPS" = "" ];then
 echo
 echo -en "\\033[1;31mDependencies" #red
 echo -e "\\033[0;39m"
 if [ ! "$FORCE" ];then
 echo "Please enter a dependency-list for the PET package that is now being
created. Packages already built-in to Puppy do not need to be
explicitly named as dependencies (except a cut-down barebones version
of Puppy may not have all of these built in, so you may have to
think of the worst-case situation).
How to enter this dependency-list is shown by an example: the package
'pupdvdtool-0.5b' has the following dependency list:
+vamps,+vobcopy,+ffmpeg,+dvdauthor,+gtkdialog3
Each package name is preceded by a '+' and delimited by a ','."
 echo "NOTE1: that 'gtkdialog3' requires the GTK libraries, but it is not
       necessary to specify sub-dependencies, as if 'gtkdialog3'
       needs to be installed it has its own dependency list."
 echo "NOTE2: You can lookup the dependency-list of each package in the
       /root/.packages/Packages-* database files"
 echo "NOTE3: it is not required to specify package version numbers,
       VERSION NUMBERS NOT YET SUPPORTED BY PACKAGE MANAGER"
 echo "NOTE4: If you don't know what to specify, just press ENTER key
       (the package manager will still do some basic dependency checking)"
 fi
 echo "$DEPNOTE"
 echo -n "Type dependency-list: "
 read $TOUT PUPOFFICIALDEPS
fi

echo
echo -en "\\033[1;31mGUI window" #red
echo -e "\\033[0;39m"

#create tarball...
rm -f $DIRPKG/${BASEPKG}.tar 2>$ERR
rm -f $DIRPKG/${BASEPKG}.tar.gz 2>$ERR
rm -f $DIRPKG/${BASEPKG}.pet 2>$ERR
if [ "$DESKTOPFILE" = 'new' ];then
 mkdir -p $DIRPKG/$BASEPKG/usr/share/applications
 echo '[Desktop Entry]' > $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo 'Encoding=UTF-8' >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Name=${PUPAPPLICATION} ${PUPMENUDESCR}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Icon=${PUPICON16}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Comment=${PUPAPPLICATION} ${PUPMENUDESCR}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Exec=${PUPEXECUTABLE}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Terminal=false" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Type=Application" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "Categories=${PUPCATEGORY}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo "GenericName=${PUPAPPLICATION} ${PUPMENUDESCR}" >> $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop
 echo
 echo "File $DIRPKG/$BASEPKG/usr/share/applications/${NAMEONLY}.desktop created."
 echo
fi

echo "Press ENTER key to bring up a GUI window that will help you to create"
echo "a database entry for the package. This will be shown in a text editor"
echo "for saving somewhere, also written to file 'pet.specs' inside the pkg."
echo -n "Press ENTER: "
read $TOUT enternow

SIZEK=`du -s -k $DIRPKG/$BASEPKG | cut -f 1` #w476

[ "${PUPCATEGORY}" ] || PUPCATEGORY="EMPTY"
#if PUPCATEGORY is in format 'entry1;entry2;' extract only 'entry2'...
xPUPCATEGORY=`echo -n "$PUPCATEGORY" | tr ';' ' ' | tr -s ' ' | sed -e 's% $%%' | rev | cut -f 1 -d ' ' | rev`
TOPCAT=`echo "$PUPHIERARCHY" | grep "$xPUPCATEGORY" | cut -f 1 -d ' ' | head -n 1`
[ "${TOPCAT}" ] || TOPCAT="EMPTY"

[ "${PUPOFFICIALDEPS}" ] || PUPOFFICIALDEPS="EMPTY"
[ "${PUPMENUDESCR}" ] || PUPMENUDESCR="EMPTY"
export PET_EXT
[ "$ME_VERB" ] && echo "${NAMEONLY}" "${TOPCAT}" "${PUPOFFICIALDEPS}" "${PUPMENUDESCR}" "$BASEPKG" "$SIZEK"
FORCE=$FORCE DEBUG=$DEBUG ME_VERB=$ME_VERB petspec "${NAMEONLY}" "${TOPCAT}" "${PUPOFFICIALDEPS}" "${PUPMENUDESCR}" "$BASEPKG" "$SIZEK"
cat /tmp/petspec_db_entry | tail -n 1 > $DIRPKG/$BASEPKG/pet.specs

echo
echo "Creating package..."
tar -c -f $DIRPKG/${BASEPKG}.tar $DIRPKG/$BASEPKG/
sync
#gzip $DIRPKG/${BASEPKG}.tar
$COMPRESS_BIN $DIRPKG/${BASEPKG}.tar
#rmdir $DIRPKG/$BASEPKG
#TARBALL="$DIRPKG/${BASEPKG}.tar.gz"
TARBALL="$DIRPKG/${BASEPKG}.tar${EXT}"

echo
echo "File $DIRPKG/${BASEPKG}.tar${EXT} created. Now converting to .pet..."
FULLSIZE=`stat --format=%s ${TARBALL}`
MD5SUM=`md5sum $TARBALL | cut -f 1 -d ' '`
echo -n "$MD5SUM" >> $TARBALL
sync
mv -f $TARBALL $DIRPKG/${BASEPKG}${PET_EXT}
sync

echo
echo "${BASEPKG}${PET_EXT} has been created. Finished."
echo
echo "If you look in ${BASEPKG} you will see the new '.specs' file."
if [ "$DESKTOPFILE" = "" ];then
 if [ -f $BASEPKG/usr/share/applications/${NAMEONLY}.desktop ];then
 echo "And in $BASEPKG/usr/share/applications/
the new '${NAMEONLY}.desktop' file."
 fi
fi
echo "Directory $BASEPKG is now configured correctly as a PET package
and in future you do not need to go through this script again.
You could manually edit the files if required, and create another
.pet package just by doing this:
# tar -c -f ${BASEPKG}.tar ${BASEPKG}/
# $COMPRESS_BIN ${BASEPKG}.tar
# tgz2pet $OPT ${BASEPKG}${EXT}"
echo
echo "dir2pet exited."

[ -s nohup.out ] || rm -f nohup.out

###END###
