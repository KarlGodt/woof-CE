#!/bin/ash

LOG=/tmp/backg.log
echo "$0:$*" >>$LOG

killslide() {
 ME=$$
 PIDS=`pidof slideshow`
 while read pid; do
 [ "$pid" = "$ME" ] && continue
 kill -9 $pid
 done<<EOI
$(echo $PIDS |tr ' ' '\n')
EOI
}

wallpaper(){
   if [ "$(which fixwidgets)" ]; then
		echo "$*" > "$HOME"/.config/wallpaper/bg_img
		fixwidgets -wallpaper_setter
	else
		"$APPDIR/set_bg" "$*"
	    #set_bg "$*"
	fi	
}

wallslide(){
DIR="$*"
SHOW="$HOME/.config/wallpaper/slideshow"
find "$DIR" -type f |sort > "$SHOW"

	while :;
do
 
 while read IMG
 do
  # re-source the preferences file in case the interval has changed
  . "$HOME"/.config/wallpaper/preferences
  case ${INT#*/} in
  1) T=s;;
  2) T=m;;
  3) T=h;;
  *) T=s;;
  esac
  echo "$0:IMG=$IMG T=${INT#*/}$T ${INT%/*}" >>$LOG
  wallpaper "$IMG"
  sleep ${INT%/*}$T
 done<<EOI
$(grep -i --extended-regexp '\.jpg$|\.jpeg$|\.png$|\.gif$|\.tif$|\.tiff$|\.svg$' "$SHOW")
EOI
	done
}
MEPID=$$
case $1 in
 -stop)
 killall -9 slideshow
 ;;
 -start)
 if  ps | grep slideshow | grep -vE "grep|$MEPID" ;then  ##no test, adds to ps output
 echo TYEPPAKILLA
  killslide
 else
  shift
  echo Stattaslupshoo
   wallslide `dirname "$*"`
 fi
 ;;
esac
