#!/bin/sh

. "$APPDIR"/common.sau
LOG=/tmp/backg.log
echo "$0:$*" >>"$LOG"

# if run with an image file as an argument
if [ "$#" -eq 1 ];then
 case $1 in
  -play)
   [ -f "$HOME"/.config/sessionrc ] && . "$HOME"/.config/sessionrc
   [ -f "$HOME"/.config/wallpaper/preferences ] && . "$HOME"/.config/wallpaper/preferences
   [ "$SLIDEDIR" ] || SLIDEDIR="/usr/share/backgrounds"
   exec "$APPDIR/slideshow" -start "$SLIDEDIR/file"
  ;;
  -*about|about|-*help|help|-*usage|usage)
   exec "$APPDIR/functions" -about
  ;;
  *)
   #killall wallslide
   if [ "$(which fixwidgets)" ]; then
		echo "$1" > "$HOME"/.config/wallpaper/bg_img
		fixwidgets -wallpaper_setter
	else
		exec "$APPDIR/set_bg" "$1"
		#exec set_bg "$*" #110408 ##13-MAR out again
	fi
	exit
  ;;
 esac
elif [ "$#" -gt 1 ];then ##multiple arguments = several images for a slideshow
 [ "$1" = '-nextslide' ] && { shift; exec "$APPDIR/set_bg" "$*"; }
 killall wallslide
 [ -f "$HOME"/.config/sessionrc ] && . "$HOME"/.config/sessionrc
 [ -f "$HOME"/.config/wallpaper/preferences ] && . "$HOME"/.config/wallpaper/preferences
 SLIDEDIR="$HOME/.config/wallpaper/slideshow-dir"
 SLIDEDIR_ESC=$(echo "$SLIDEDIR" | sed 's/\//\\\//g')
 sed -i 's/SLIDEDIR=.*/SLIDEDIR=\"'"$SLIDEDIR_ESC"'\"/' "$HOME"/.config/wallpaper/preferences
 rm "$SLIDEDIR_ESC"/*
 mkdir -p "$SLIDEDIR"
 oldIFS=$IFS
 IFS='
'
 for FILE in $@; do
 ln -s "$FILE" "$SLIDEDIR"
 done
 IFS=$oldIFS
 exec "$APPDIR/slideshow" -start "$SLIDEDIR/file"
fi
