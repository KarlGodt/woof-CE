#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_dialog_addaccount"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/psip/dialog_addaccount"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
# GPL v3 License
# PS VOIP for Puppy Linux v 0.7 June 27 008
# created by Lobster, CEL, HairyWill
# tested by Eric, Grant and the Puppy Community
###################

#add a new account
#this can only cope with one account but pjsua allows for many
#todo
#check the input is at least close to matching a valid account


OLD_ID=$(sed -rn /^--id/s/^--id.//p /$PJCFG)
[ "$OLD_ID" = '' ] && OLD_ID="sip:dummy@proxy01.sipphone.com"
OLD_REGISTRAR=$(sed -rn /^--registrar/s/^--registrar.//p /$PJCFG)
[ "$OLD_REGISTRAR" = "" ] && OLD_REGISTRAR="sip:proxy01.sipphone.com"
OLD_REALM=$(sed -rn /^--realm/s/^--realm.//p /$PJCFG)
[ ! "$OLD_REALM" ] && OLD_REALM="*"
OLD_USERNAME=$(sed -rn /^--username/s/^--username.//p /$PJCFG)
[ ! "$OLD_USERNAME" ] && OLD_USERNAME="joeblogs"
OLD_PASSWORD=$(sed -rn /^--password/s/^--password.//p /$PJCFG)
[ ! "$OLD_PASSWORD" ] && OLD_PASSWORD="dummy"

export DIALOG='<window width="500"><vbox><text>
      <label>Enter the details for your sip account</label>
    </text><hbox>
    <text>
      <label>Your SIP URL:   </label>
    </text>
    <entry>
    <default>'$OLD_ID'</default>
       <variable>SIP_ID</variable>
     </entry>
  </hbox>
  <hbox>
    <text>
      <label>Registrar URL: </label>
    </text>
    <entry>
    <default>'$OLD_REGISTRAR'</default>
       <variable>SIP_REGISTRAR</variable>
     </entry>
  </hbox>
  <hbox>
    <text>
      <label>Auth Realm:(*)</label>
    </text>
    <entry>
    <default>'$OLD_REALM'</default>
       <variable>SIP_REALM</variable>
     </entry>
  </hbox>
  <hbox>
    <text>
      <label>Username:      </label>
    </text>
    <entry>
    <default>'$OLD_USERNAME'</default>
       <variable>SIP_USERNAME</variable>
     </entry>
  </hbox>
  <hbox>
    <text>
      <label>Password:       </label>
    </text>
    <entry invisible_char="*" visibility="false">
    <default>'$OLD_PASSWORD'</default>
      <variable>SIP_PASSWORD</variable>
    </entry>
  </hbox><hbox><text>
      <label>If you do not have a SIP account already you can obtain one at the following URL https://signup.sipphone.com/new-users/app?class=NewUser;proc=start</label>
    </text>    
   <button cancel></button>
    <button ok></button>
  </hbox></vbox></window>'
  
for STATEMENTS in $(gtkdialog3 --program DIALOG --name "PSIP Edit Account"); do
  eval $STATEMENTS
done

if [ "$EXIT" = "OK" ]; then
#add account to the currently running session
echo  >> $PJSIGNAL #always need to start with a blank line to clear any existing instructions
echo -e "\n+a\n$SIP_ID\n$SIP_REGISTRAR\n$SIP_REALM\n$SIP_USERNAME\n$SIP_PASSWORD\n" >> $PJSIGNAL

#save the config to file
sed -i '/Account 0:/d;/^--id/d;/^--registrar/d;/^--realm/d;/^--username/d;/^--password/d;/--reg-timeout/d' $PJCFG 
  echo "# Account 0:
--id $SIP_ID
--registrar $SIP_REGISTRAR
--realm $SIP_REALM
--username $SIP_USERNAME
--password $SIP_PASSWORD
--reg-timeout 55" >> $PJCFG 
fi
