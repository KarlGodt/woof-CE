#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_dialog_addbuddy"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/psip/dialog_addbuddy"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
# GPL v3 License
# PS VOIP for Puppy Linux v 0.7 June 27 008
# created by Lobster, CEL, HairyWill
# tested by Eric, Grant and the Puppy Community
###################

#add a new buddies
#todo
#check the input is at least close to matching a valid address
#check that the buddy is not already listed


export DIALOG='<window width="500">
<vbox>
	<text><label>Enter the sip address for your new buddy</label></text>
	<entry>
		<variable>BUDDY</variable>
		<default>sip:</default>
	</entry>
	<hbox>
		<button ok></button>
	</hbox>
</vbox>
</window>'
for STATEMENTS in $(gtkdialog3 --program DIALOG --name "PSIP Add Buddy"); do
  eval $STATEMENTS
done

if [ "$EXIT" = "OK" ]; then
	#add buddy to the currently running session
	echo  -e "\n+b\n$BUDDY" >> $PJSIGNAL
	#subscribe to buddy
	echo  -e "\ns\n$BUDDY" >> $PJSIGNAL

	#add buddy to config file
	LINE=$(grep -n '^\-\-add-buddy' $PJCFG | tail -1 | cut -f 1 -d ':')
	((LINE++))
	echo $LINE
	echo >> $PJCFG ##just in case the insertion point is the last line
	sed  -i $LINE\i'--add-buddy '$BUDDY $PJCFG
fi