#!/bin/sh
#states
#TX_START TX RX_START RX MSG_END ACCOUNTS_START ACCOUNTS BUDDIES_START BUDDIES IDLE

UPDATE_TIME=0
while read LINE
do
EVENT_TYPE=$(echo $LINE | cut -f 1 -d ',')
EVENT=$(echo $LINE | cut -f 2- -d ',')
[ ! "$EVENT_TYPE" ] && EVENT_TYPE=NULL
	case $EVENT_TYPE in
	
#put this one first as it needs the fastest response
	INCOMING_CALL)
	CALLER="$(echo $EVENT | cut -f 2 -d ',' | sed 's/<//;s/>//' )"
	if [ ! "$(grep ${CALLER} $PJTMP/account-list)" ] ; then
		$PJAPPDIR/dialog_incomingcall "$CALLER" &
	fi
	;;
	
	CALL_STATE_CHANGE)
	gxmessage -center -timeout 2 -buttons "" "$EVENT"
	CALL_EVENT_TYPE="$(echo $EVENT | cut -f 2 -d ',')"
	case $CALL_EVENT_TYPE in
	
		CALLING)
		echo -e "\n\cc 1 0\n" >> $PJSIGNAL
		;;
		
		CONFIRMED)
		echo -e "\n\cd 1 0\n" >> $PJSIGNAL
		;;
		
	esac
	;;

	INCOMING_IM)
	SENDER="$(echo $EVENT | cut -f 1 -d ',' | sed 's/<//;s/>//')"
	SENDER_NAME=$(echo $SENDER | sed 's/sip://;s/@.*//')
	SENDER_NAME="$(date +%y/%m/%d-%T) [$SENDER_NAME] " 
	TEXT="$(echo $EVENT | cut -f 2- -d ',' | sed 's/,(text\/plain)//')"
	echo ${SENDER_NAME}${TEXT} >> $HOME/.psip/PSIP_chatlog
	$PJAPPDIR/dialog_inputchat "$SENDER" &
	;;

	REGISTRATION)
	# what to do with this
	;;
	
	DISCONNECTED_CALL)
	$PJAPPDIR/dialog_disconnectedcall "$(echo $EVENT | sed 's/.*,.*,//')" &
	;;
	
	BUDDY_STATUS)
	#drop events which have unknown status, there are too many of them
	if [ ! "$(echo $EVENT | grep '?')" ]; then
		if [ "$(head -1 $PJTMP/status-message)" = "0" ]; then
			echo -e "100\n$EVENT" | sed 's/sip://;s/@proxy01.sipphone.com,/ is /' > $PJTMP/status-message
			else
			echo -e "0\n$EVENT" | sed 's/sip://;s/@proxy01.sipphone.com,/ is /' > $PJTMP/status-message
		fi
	fi
	;;
	
	esac
	
done < $PJTMP/pjsua-output-pipe