#!/bin/bash
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_func_index"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/pmusic/func_index"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
#Pmusic
#Copyright 2008,2009,2010
#Sigmund Berglund
IFS=$'\n'

rm $WORKDIR/update_index_cancel
if [ $USE_TAGS = true ]; then #change name from filename to metatag artist - title
	echo true > $WORKDIR/USE_TAGS #defines <table> header
	if [ $INDEX_CHANGES = true ]; then #update only new files
		if [ -s $WORKDIR/LAST_INDEX ]; then
			LAST_INDEX="`cat $WORKDIR/LAST_INDEX`"
			TMP="`date +%s`"
			INDEX_TIME=`expr $TMP / 60` #minutes since 1970. For -cmin.
			CMIN=`expr $LAST_INDEX - $INDEX_TIME`
		else
			INDEX_TIME=20000000 #minutes since 1970. For -cmin
		fi
		echo $INDEX_TIME > $WORKDIR/LAST_INDEX
	else #reset
		rm -f $WORKDIR/generated_playlists/*
	fi
	[ ! "$CMIN" ] && CMIN='-20000000'
	#find both changed files and new added files
	echo -e "\c" > $WORKDIR/index_new
	while read I; do
		find -P "$I" -cmin $CMIN -printf "  %p|%f\n" | grep -iE "$AUDIO_FORMATS|\.m3u|\.pls" >> $WORKDIR/index_new
	done < $HOME/.pmusic/index_directories
	#check meta tag. file by file
	COUNT=0
	TOTAL=`cat $WORKDIR/index_new | wc -l`
	echo -e "\c" > $WORKDIR/index_tmp
	echo -e "\c" > $WORKDIR/index_albums
	while read I; do
		FILE="`echo "$I" | cut -d '|' -f 1 | awk -F"  " '{print $2}'`"
		id3info "$FILE" > $WORKDIR/id3info
		ID3_ARTIST="`grep -Fm1 'Lead performer' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
		if [ "$ID3_ARTIST" ] && [ "$ID3_ARTIST" != " " ] && [ "$ID3_ARTIST" != "unknown" ]; then
			ID3_TITLE="`grep -Fm1 'Title' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
			ID3_ALBUM="`grep -Fm1 'Album' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
			echo "$ID3_ARTIST|$ID3_ALBUM" >> $WORKDIR/index_albums
			ID3_TRACK="`grep -Fm1 'Track' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
			ID3_YEAR="`grep -Fm1 'Year' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
			#genre
			TMP="`grep -Fm1 'Content' $WORKDIR/id3info | cut -d '(' -f 3 | cut -d ')' -f 1`"
			if [ "`expr $TMP + 1`" ]; then #number
				ID3_GENRE="`grep "^$TMP|" $APPDIR/id3_genre | cut -d '|' -f 2`"
			else
				ID3_GENRE="`grep -Fm1 'Content' $WORKDIR/id3info | cut -d ':' -f 2- | cut -b 2-`"
			fi
			#---
			echo "  $FILE|$ID3_TITLE|$ID3_ARTIST|$ID3_ALBUM|$ID3_TRACK|$ID3_YEAR|$ID3_GENRE" >> $WORKDIR/index_tmp
		else
			echo "$I" >> $WORKDIR/index_tmp
		fi
		#update progress bar
		PERCENT=$((($COUNT*100/$TOTAL)+1))
		echo "$LOC311" > $WORKDIR/splashtext
		echo $PERCENT > $WORKDIR/index_splash #update progressbar
		COUNT=$(($COUNT+1))
		echo $PERCENT >> /root/gtk
		[ "`cat $WORKDIR/update_index_cancel`" = "cancel" ] && exit
	done < $WORKDIR/index_new
	#generate playlists based on ALBUM metatags
	sort -u --output=$WORKDIR/tmp $WORKDIR/index_albums
	mv -f $WORKDIR/tmp $WORKDIR/index_albums
	COUNT=0
	TOTAL=`cat $WORKDIR/index_albums | wc -l`
	while read I; do
		ARTIST=`echo "$I" | cut -d '|' -f 1`
		ALBUM=`echo "$I" | cut -d '|' -f 2`
		if [ "$ALBUM" ] && [ "$ALBUM" != " " ]; then
			cat $WORKDIR/index_tmp | grep "$ALBUM" | cut -b 3- | awk -F "|" '{print $5"|"$1}' > $WORKDIR/generated_playlists/"$ARTIST - $ALBUM".album
			sort --output=$WORKDIR/tmp $WORKDIR/generated_playlists/"$ARTIST - $ALBUM".album
			cut -d '|' -f 2 $WORKDIR/tmp > $WORKDIR/generated_playlists/"$ARTIST - $ALBUM".album
		fi
		#update progress bar
		PERCENT=`expr $COUNT \* 100 / $TOTAL`
		PERCENT=`expr $PERCENT + 1`
		echo "$LOC311" > $WORKDIR/splashtext
		echo $PERCENT > $WORKDIR/index_splash #update progressbar
		COUNT=`expr $COUNT + 1`
		[ "`cat $WORKDIR/update_index_cancel`" = "cancel" ] && exit
	done < $WORKDIR/index_albums
	#---
	if [ $INDEX_CHANGES = false ]; then
		mv -f $WORKDIR/index_tmp $HOME/.pmusic/index_all
	else
		cat $WORKDIR/index_tmp >> $HOME/.pmusic/index_all
	fi
else #only use filenames in add-list
	echo false > $WORKDIR/USE_TAGS #defines <table> header
	rm -f $WORKDIR/generated_playlists/*
	echo false > $WORKDIR/USE_TAGS
	echo -e "\c" > $HOME/.pmusic/index_all
	while read I; do
		find -P "$I" -printf "  %p|%f\n" | grep -iE "$AUDIO_FORMATS|\.m3u|\.pls" >> $HOME/.pmusic/index_all
	done < $HOME/.pmusic/index_directories
fi
#generate playlists based on directory structure
if [ "$INDEX_DIR" != "$LOC306" ]; then
	COUNT=0
	TOTAL=`cat $WORKDIR/index_new | wc -l`
	while read I; do
		case "$INDEX_DIR" in
		"../$LOC_ARTIST - $LOC_ALBUM/$LOC223")
			TMP="`echo "$I" | cut -d '|' -f 1`"
			DIR_ARTIST_ALBUM="`dirname "$TMP"`"
			ARTIST_ALBUM="`basename "$DIR_ARTIST_ALBUM"`"
			find "$DIR_ARTIST_ALBUM" -type f | grep -iE "$AUDIO_FORMATS" > $WORKDIR/generated_playlists/"$ARTIST_ALBUM".dir
			;;
		"../$LOC_ARTIST/$LOC_ALBUM/$LOC223")
			TMP="`echo "$I" | cut -d '|' -f 1`"
			DIR_ALBUM="`dirname "$TMP"`" #level 1
			DIR_ARTIST="`dirname "$DIR_ALBUM"`" #level 2
			ALBUM="`basename "$DIR_ALBUM"`"
			ARTIST="`basename "$DIR_ARTIST"`"
			find "$DIR_ALBUM" -type f | grep -iE "$AUDIO_FORMATS" > $WORKDIR/generated_playlists/"$ARTIST - $ALBUM".dir
			find "$DIR_ARTIST" -type f | grep -iE "$AUDIO_FORMATS" > $WORKDIR/generated_playlists/"$ARTIST".dir
			;;
		"../$LOC_ARTIST/$LOC223")
			TMP="`echo "$I" | cut -d '|' -f 1`"
			DIR_ARTIST="`dirname "$TMP"`" #level 1
			ARTIST="`basename "$DIR_ARTIST"`"
			find "$DIR_ARTIST" -type f | grep -iE "$AUDIO_FORMATS" > $WORKDIR/generated_playlists/"$ARTIST".dir
			;;
		esac
		rm $WORKDIR/generated_playlists/.dir
		rm $WORKDIR/generated_playlists/..dir
		#update progress bar
		PERCENT=`expr $COUNT \* 100 / $TOTAL`
		PERCENT=`expr $PERCENT + 1`
		echo "$LOC313" > $WORKDIR/splashtext
		echo $PERCENT > $WORKDIR/index_splash #update progressbar
		COUNT=`expr $COUNT + 1`
		[ "`cat $WORKDIR/update_index_cancel`" = "cancel" ] && exit
	done < $WORKDIR/index_new
fi
#spread index to subindexes
echo -e "\c" > $HOME/.pmusic/index_alphabetic
echo -e "\c" > $HOME/.pmusic/index_playlists
find $WORKDIR/generated_playlists -printf "  %p|%f\n" >> $HOME/.pmusic/index_all #generated directories
grep -iE "$AUDIO_FORMATS" $HOME/.pmusic/index_all >> $HOME/.pmusic/index_alphabetic
grep -iE "\.m3u|\.pls|\.dir|\.album" $HOME/.pmusic/index_all >> $HOME/.pmusic/index_playlists
sort -u --output=$WORKDIR/tmp $HOME/.pmusic/index_alphabetic
mv -f $WORKDIR/tmp $HOME/.pmusic/index_alphabetic
sort -u --output=$WORKDIR/tmp $HOME/.pmusic/index_playlists
mv -f $WORKDIR/tmp $HOME/.pmusic/index_playlists
#convert underscores and %20
if [ $CONV_UNDERSCORE = true ]; then
	cut -d'|' -f1 $HOME/.pmusic/index_alphabetic > $WORKDIR/tmp
	cut -d'|' -f2 $HOME/.pmusic/index_alphabetic > $WORKDIR/tmp1
	cat $WORKDIR/tmp1 | tr '_' ' ' > $WORKDIR/tmp2
	paste -d'|' $WORKDIR/tmp $WORKDIR/tmp2 > $HOME/.pmusic/index_alphabetic
	#---
	cut -d'|' -f1 $HOME/.pmusic/index_playlists > $WORKDIR/tmp
	cut -d'|' -f2 $HOME/.pmusic/index_playlists > $WORKDIR/tmp1
	cat $WORKDIR/tmp1 | tr '_' ' ' > $WORKDIR/tmp2
	paste -d'|' $WORKDIR/tmp $WORKDIR/tmp2 > $HOME/.pmusic/index_playlists
fi
if [ $CONV_20 = true ]; then
	cut -d'|' -f1 $HOME/.pmusic/index_alphabetic > $WORKDIR/tmp
	cut -d'|' -f2 $HOME/.pmusic/index_alphabetic > $WORKDIR/tmp1
	sed -i 's/%20/ /g' $WORKDIR/tmp1
	paste -d'|' $WORKDIR/tmp $WORKDIR/tmp1 > $HOME/.pmusic/index_alphabetic
	#---
	cut -d'|' -f1 $HOME/.pmusic/index_playlists > $WORKDIR/tmp
	cut -d'|' -f2 $HOME/.pmusic/index_playlists > $WORKDIR/tmp1
	sed -i 's/%20/ /g' $WORKDIR/tmp1
	paste -d'|' $WORKDIR/tmp $WORKDIR/tmp1 > $HOME/.pmusic/index_playlists
fi
#index_all is the search source, and should only contain playable files
cp -f $HOME/.pmusic/index_alphabetic $HOME/.pmusic/index_all
cat $HOME/.pmusic/index_playlists >> $HOME/.pmusic/index_all
#reset
echo 100 > $WORKDIR/index_splash
#$APPDIR/func -index_songs #show songs in index list
#pmusic #reload Pmusic to change index heading (tags/no tags)# Very End of this file 'usr/local/pmusic/func_index' #
###END###
