#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_func_lyrics"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/pmusic/func_lyrics"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in 1; do shift; done; }

_trap

}
# End new header
#
IFS=$'\n'

export WORKDIR=$HOME/.pmusic/tmp
export APPDIR=`cat $WORKDIR/APPDIR`

case $1 in
-gui)
	. $APPDIR/func_lyrics -fetch_playing
	. $APPDIR/gui_lyrics
	export Pmusic_lyrics="
	<window title=\"Pmusic - $LOC144\" icon-name=\"gtk-media-stop\">
	<vbox>
	$GUI_LYRICS
	</vbox>
	</window>"
	 $GTKDIALOG -p Pmusic_lyrics
	;;
-fetch_playing)
	cut -d'|' -f1 $WORKDIR/ffmpeg_NOW_PLAYING > $WORKDIR/lyrics_song
	;;
-search)
	echo "http://www.azlyrics.com
http://www.elyrics.net
http//www.lyricswiki.org
http://lyrc.com.ar" > $WORKDIR/splashtext
	$APPDIR/box_splash_progress &
	#check internet connection
	LANG=C wget -S --spider -T 1 puppylinux.com 2> $WORKDIR/tmp
	if [ ! "`grep 'connected' $WORKDIR/tmp`" ]; then
		TXT1="<b>$LOC326</b>"
		. $APPDIR/box_ok
		echo 100 > $WORKDIR/splash
		exit
	fi
	#azlyrics
	echo 20 > $WORKDIR/splash
	TMP_ARTIST="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 1 | tr [A-Z] [a-z] | tr -d ' ' | tr -d \' | tr -d '-'`"
	TMP_SONG="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 2 | tr [A-Z] [a-z] | tr -d ' ' | tr -d \' | tr -d '-'`"
	wget --tries=1 -O $WORKDIR/lyrics http://www.azlyrics.com/lyrics/$TMP_ARTIST/$TMP_SONG.html
	LYRICS="`cat $WORKDIR/lyrics | grep -A 1000 -m 1 'END OF RINGTONE' | grep -B 1000 -m 1 'azlyrics' | grep -v azlyrics | grep -vi ringtone | sed -e "s/<[^>]*>//g"`"
	echo "$LYRICS" > $WORKDIR/lyrics
	#elyrics
	if [ ! "$LYRICS" ]; then
		echo 40 > $WORKDIR/splash
		TMP_ARTIST="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | sed -e 's/-/,,/g' | tr ' ' '-' | cut -d '_' -f 1 | tr [A-Z] [a-z] | tr -d \'`"
		TMP_SONG="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | sed -e 's/-/,,/g' | tr ' ' '-' | cut -d '_' -f 2 | tr [A-Z] [a-z] | tr -d \'`"
		TMP_CHAR="`echo $TMP_ARTIST | cut -c 1`"
		wget --tries=1 -O $WORKDIR/lyrics http://www.elyrics.net/read/$TMP_CHAR/$TMP_ARTIST-lyrics/$TMP_SONG-lyrics.html
		LYRICS="`cat $WORKDIR/lyrics | grep -A 1000 -m 1 'terms of service' | grep -B 1000 -m 1 'Ringtone to your Cell Phone' | grep -v 'terms of service' | grep -v 'Ringtone to your Cell Phone' | sed -e "s/<[^>]*>//g" `"
		echo "$LYRICS" > $WORKDIR/lyrics
	fi
	#lyricwiki.org
	if [ ! "$LYRICS" ]; then
		echo 60 > $WORKDIR/splash
		TMP_ARTIST="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 1 | tr ' ' _`"
		TMP_SONG="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 2 | tr ' ' _`"
		LYRICS="`wget --tries=1 -O $WORKDIR/tmp http://lyricwiki.org/$TMP_ARTIST:$TMP_SONG ; sed '/lyricbox\|h1/!d;/class/!d;s/.*lyricbox//;s/<h1 class=\"firstHeading\"//;s/<\/h1>//;s/<br \///g;' $WORKDIR/tmp|tr '>' '\n'`"
		[ `echo $LYRICS | wc -l` -lt 5 ] && LYRICS=""
		echo "$LYRICS" > $WORKDIR/lyrics
	fi
	#lyrc.com.ar
	if [ ! "$LYRICS" ]; then
		echo 80 > $WORKDIR/splash
		TMP_ARTIST="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 1 | tr ' ' _ | tr '/' '_'`"
		TMP_SONG="`echo $LYRICS_SONG | tr '_' ' ' | sed -e 's/ - /_/g' | cut -d '_' -f 2 | tr ' ' _ | tr '/' '_'`"
		wget --tries=1 -O $WORKDIR/lyrics http://lyrc.com.ar/lyric/for/$TMP_SONG/by/$TMP_ARTIST
		LYRICS="`cat $WORKDIR/lyrics | grep -A 200 -m 1 'viewvideomusic.com' | grep -B 200 -m 1 '</font>' | grep -v videomusic | grep -vi '/font'  | sed -e "s/<[^>]*>//g"`"
		echo "$LYRICS" > $WORKDIR/lyrics.latin1
		#encoding
		iconv --from-code=ISO-8859-1 --to-code=UTF-8 $WORKDIR/lyrics.latin1 > $WORKDIR/lyrics
	fi
	#---
	[ ! "$LYRICS" ] && echo "$LOC325" > $WORKDIR/lyrics
	echo 100 > $WORKDIR/splash
	;;
esac
# Very End of this file 'usr/local/pmusic/func_lyrics' #
###END###
