#!/bin/sh

####################################
#
# A JWM panel button configuring tool
# for jwmconfig
# 2006-NOV-05
# by plinej
#
#####################################
# 2009-NOV-06 low and high position fixed by himajin, shinobar
# 23aug2010 shinobar: skip comments from edit

##_____________________________________________________________________________________________________________________________##
# Fri Apr  8 02:39:57 GMT-1 2011 Karl Reimer Godt																				#
# 2.6.34-KRG-i486-compiled-AcerLaptop-rev4.1 Lucid Puppy 218 http://murga-linux.com/puppy/viewtopic.php?t=58978					#
# fixes for the low and high positions :)																						#
# replaced the use of `echo "(("$VAL1" "$MATH" "$VAL2"))" | bc -l` with $(($VAL1 ... )) to eliminate the possibility of floats	#
# made functions for the multiply use of "case $? in ..."																		#
# the "MOVE" part should work now																								#
# cleaned up and deleted much ( to be found it in the original 431 or 511 )	^Ooops^												#
##_____________________________________________________________________________________________________________________________##

########################################################################
#
# CHANGES by Karl Reimer Godt
# 00.0 : see above
# 01.0 : changed /root to $HOME
# 02.0 : using separate tmp dir /tmp/JWMconfig
#
# /dev/hda7
# /dev/hda7:
# LABEL="/"
# UUID="429ee1ed-70a4-43a5-89f8-33496c489260"
# TYPE="ext4"
# DISTRO_NAME='Lucid·Puppy'
# DISTRO_VERSION=218
# DISTRO_MINOR_VERSION=00
# DISTRO_BINARY_COMPAT='ubuntu'
# DISTRO_FILE_PREFIX='luci'
# DISTRO_COMPAT_VERSION='lucid'
# DISTRO_KERNEL_PET='linux_kernel-2.6.33.2-tickless_smp_patched-L3.pet'
# PUPMODE=2
# SATADRIVES=''
# PUP_HOME='/'
# PDEV1='hda7'
# DEV1FS='ext4'
# Linux·puppypc·2.6.31.14·#1·Mon·Jan·24·21:03:21·GMT-8·2011·i686·GNU/Linux
# Xserver=/usr/bin/Xorg
# $LANG=en_US
# today=Tue·Oct·25·19:11:44·GMT+1·2011
#
# TODO1 : returnvalues for Backup aso with message if ok or not
#
#
#
########################################################################


if [ ! -f $HOME/.jwmrc-tray-bak ]; then
cp $HOME/.jwmrc-tray $HOME/.jwmrc-tray-bak  ### makes .jwmrc-tray-bak backup file unless it already exists
fi
#cat /root/.jwmrc-tray | sed 's#^[[:blank:]]*$##g' | sed '/^$/d' > /tmp/JWMconfig/.jwmrc-tray
cat $HOME/.jwmrc-tray | grep -v -x -e '^[[:blank:]]*' > /tmp/JWMconfig/.jwmrc-tray ### remove all blank lines in .jwmrc-tray
mv /tmp/JWMconfig/.jwmrc-tray $HOME/

if test "`tail -n 1 $HOME/.jwmrc-tray | hexdump | grep -o '0a'`" = "" ; then
 #KRGensure newline so wc counts the real line numbers :)
 
 lastLine=`cat $HOME/.jwmrc-tray | tail -n 1`
 #addJMWendNEWline=`echo $lastLine| sed 's#$#\n#'`
 
 if test "$lastLine" = "</JWM>" ;then 
 echo >> $HOME/.jwmrc-tray
 else
 if test "`grep -o -w '</JWM>' $HOME/.jwmrc-tray`" = "" ; then
 echo '</JWM>' >> $HOME/.jwmrc-tray
 echo >> $HOME/.jwmrc-tray
 fi
 fi
fi
 
# 2009-NOV-06 low and high position fixed 

total=`wc -l $HOME/.jwmrc-tray | cut -f1 -d' '` ### get total number of lines
low=`grep -n '^[[:blank:]]*<TrayButton popup' $HOME/.jwmrc-tray | head -n 1 | cut -d':' -f1`  ### get line number of the first button (Menu)
low=$(($low - 1)) ## nr until to preserve the head of jwmrc-tray

high=`grep '<!-- Additional Pager attributes; width, height -->' -n $HOME/.jwmrc-tray | sed -e 's/\:.*>//g'` ### get line number with Additional Pager

last=$(($total - $high + 1))

begin=$(($low + 1)) ### first line with panel buttons , without menubutton [requires menubutton first in this partic. list]

cat $HOME/.jwmrc-tray | head -n "$low" > /tmp/JWMconfig/jwmrc-tray-head.txt
echo >> /tmp/JWMconfig/jwmrc-tray-head.txt # one empty line for better overview
echo > /tmp/JWMconfig/jwmrc-tray-tail.txt  # -"-
cat $HOME/.jwmrc-tray | tail -n "$last" >> /tmp/JWMconfig/jwmrc-tray-tail.txt

echo $DBG 64 "total=$total, low=$low, high=$high, last=$last, begin=$begin"
num=1

F_0_further_1_exit_rm_255_exit_rm_func() {
	
case $retval in 
  0)
    echo "'$choice' chosen.";;
  1|255)
    echo "Cancel pressed or Box closed"
     rm /tmp/JWMconfig/jwm*
    exit 0
    ;;
esac
	
}

F_0_further_255_exit_func() {
	
case $? in
  0)
    echo "OK";;
  255)
    echo "Box closed."
    exit 0
    ;;
esac
	
}

F_0_further_255_further_func() {
	
case $? in
  0)
    echo "OK";;
  255)
    echo "Box closed.";;
esac
	
}


### xdialog radiolist gui
Xdialog --backtitle "" \
	--title "RADIOLIST BOX" \
        --radiolist "JWM panel button configuring tool." 26 46 5 \
        "Backup" "Backup your current .jwmrc-tray" off \
        "Restore" "Restore .jwmrc-tray from backup above" off \
        "Edit" "Edit your existing Panel Buttons" ON \
        "Add" "Add a panel button" off \
        "Move" "Move panel buttons around" off \
        "Remove" "Remove a panel button" off\
        "Exit" "Exit this program" off 2>/tmp/JWMconfig/checklist.tmp.$$

retval=$?
choice=`cat /tmp/JWMconfig/checklist.tmp.$$`
rm -f /tmp/JWMconfig/checklist.tmp.$$

if [ "$retval" != 0 ]; then
rm /tmp/JWMconfig/jwm*
exit
fi

F_0_further_1_exit_rm_255_exit_rm_func

if [ "$choice" = "Exit" ]; then
rm /tmp/JWMconfig/jwm*
exit 0
fi
if [ "$choice" = "Backup" ]; then
rm /tmp/JWMconfig/jwm*
Xdialog --title "MESSAGE BOX" \
        --msgbox "This will backup your current
	     $HOME/.jwmrc-tray and will be the version
	     that gets restored if you choose restore." 10 41

F_0_further_255_exit_func  ##changed to exit if cancel pressed

cp $HOME/.jwmrc-tray $HOME/.jwmrc-tray-bak
exit 0
fi


if [ "$choice" = "Restore" ]; then
rm /tmp/JWMconfig/jwm*
cp $HOME/.jwmrc-tray $HOME/.jwmrc-tray.$$  ##+++2011_10_25
if [ -f $HOME/.jwmrc-tray-bak ] ; then
cp -f $HOME/.jwmrc-tray-bak $HOME/.jwmrc-tray
restoreRetVal=$?
fi
if [ "$restoreRetVal" == "0" ] ; then
Xdialog --title "MESSAGE BOX" \
        --msgbox "Your original $HOME/.jwmrc-tray
        file has been restored.
	     You must restart jwm for
	     changes to take effect." 10 41
rm $HOME/.jwmrc-tray.$$ 
else
xmessage -bg "red" "ERROR : the cp command returned $restoreRetVal"
rm $HOME/.jwmrc-tray
mv $HOME/.jwmrc-tray.$$ $HOME/.jwmrc-tray
xmessage -bg "red" "Tried to keep the last $HOME/.jwmrc-tray ."
fi
#F_0_further_255_exit_func
#[ -f $HOME/.jwmrc-tray-bak ] && cp -f $HOME/.jwmrc-tray-bak $HOME/.jwmrc-tray
exit 0
fi


if [ "$choice" = "Edit" ]; then
echo "Debug: $begin":"$high"
while [ "$begin" != "$high" ]; do

cat $HOME/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//' | sed -e 's/\".*//' | sed 's/^[ \t]*//' > /tmp/JWMconfig/tmp-popup.txt  ### gets popup text
popup=`cat /tmp/JWMconfig/tmp-popup.txt`
cat $HOME/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//' | sed -e "s/$popup//" | sed -e 's/" icon="//' | sed -e 's/\".*//' | sed 's/^[ \t]*//' > /tmp/JWMconfig/tmp-icon.txt  ### gets icon text
icon=`cat /tmp/JWMconfig/tmp-icon.txt`
cat $HOME/.jwmrc-tray | sed -n ""$begin"p" | sed 's/\<.*\"//g' | sed -e 's/<\/TrayButton>//' | sed -e 's/<>//' | sed 's/^[ \t]*//' > /tmp/JWMconfig/tmp-exec.txt  ### gets executable text
#action=`cat /tmp/JWMconfig/tmp-exec.txt`
SKIP=""
echo "$popup" | grep -q '^<!--' && SKIP="yes"
[ "$icon" = "" ] && SKIP="yes"
if [ "$SKIP" != "yes" ]; then
 ### This is the Edit gui
 export JWM_Panel_Button_Editor="
<vbox>
 <frame Button $num Information - edit as you wish>
  <hbox>
      <text><label>Popup display</label></text>
      <entry>
    <variable>Entry1</variable>
    <input>cat /tmp/JWMconfig/tmp-popup.txt</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>executable</label></text>
      <entry>
    <variable>Entry3</variable>
    <input>cat /tmp/JWMconfig/tmp-exec.txt</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>Icon name</label></text>
      <entry>
    <variable>Entry2</variable>
    <input>cat /tmp/JWMconfig/tmp-icon.txt</input>
    </entry>
    <button>
      <input file>/usr/local/lib/X11/mini-icons/dir_o.xpm</input>
      <action>./file-selector</action>
      <action>refresh:Entry2</action>
    </button>
  </hbox>
 </frame>
  <hbox>
   <button ok>
	<action>echo \$Entry1 | tee /tmp/JWMconfig/tmp-popup-$num.txt</action>
	<action>echo \$Entry2 | tee /tmp/JWMconfig/tmp-icon-$num.txt</action>
	<action>echo \$Entry3 | tee /tmp/JWMconfig/tmp-exec-$num.txt</action>
	<action type=\"exit\">EXIT</action>
   </button>
   <button cancel>
   <action> rm $POP $EXC $ICO </action>
   <action type=\"exit\">EXIT:ok</action>
   </button>
  </hbox>
</vbox>"

 ##------------run------------->>
 gtkdialog3 --program JWM_Panel_Button_Editor

 ##----------cleanup------------>>
 unset JWM_Panel_Button_Editor

 new_line=`echo \<TrayButton popup\=\"``cat /tmp/JWMconfig/tmp-popup-$num.txt``echo \" icon\=\"``cat /tmp/JWMconfig/tmp-icon-$num.txt``echo \"\>``cat /tmp/JWMconfig/tmp-exec-$num.txt``echo \</TrayButton\>`  ### builds replacement line for .jwmrc-tray
 echo "$new_line" >> /tmp/JWMconfig/jwmrc-tray-2.txt
fi

begin=$(($begin +1))
num=$(($num +1))
shift
done

cat /tmp/JWMconfig/jwmrc-tray-2.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
cat /tmp/JWMconfig/jwmrc-tray-tail.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
mv /tmp/JWMconfig/jwmrc-tray-head.txt $HOME/.jwmrc-tray

rm -f /tmp/JWMconfig/jwmrc-tray-*
rm -f /tmp/JWMconfig/tmp-popup*.txt
rm -f /tmp/JWMconfig/tmp-icon*.txt
rm -r /tmp/JWMconfig/tmp-exec*.txt

Xdialog --title "MESSAGE BOX" \
        --msgbox "Editing complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

exit 0
fi



if [ "$choice" = "Add" ]; then
while [ "$begin" != "$high" ]; do
cat $HOME/.jwmrc-tray | sed -n ""$begin"p" >> /tmp/JWMconfig/jwmrc-tray-panel.txt

begin=$(($begin + 1))
shift
done

### This is the Add gui
export JWM_Panel_Button_Add="
<vbox>
 <frame Button Add>
  <hbox>
      <text><label>Popup display</label></text>
      <entry>
    <variable>Entry1</variable>
      </entry>
  </hbox>
  <hbox>
      <text><label>executable</label></text>
      <entry>
    <variable>Entry3</variable>
    <input>echo exec:</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>Select icon</label></text>
      <entry>
    <variable>Entry2</variable>
    <input>cat /tmp/JWMconfig/tmp-icon.txt</input>
    </entry>
    <button>
      <input file>/usr/local/lib/X11/mini-icons/dir_o.xpm</input>
      <action>./file-selector</action>
      <action>refresh:Entry2</action>
    </button>
  </hbox>
  </frame>
  <hbox>
   <button ok>
	<action>echo \$Entry1 | tee /tmp/JWMconfig/tmp-popup.txt</action>
	<action>echo \$Entry3 | tee /tmp/JWMconfig/tmp-exec.txt</action>
	<action type=\"exit\">EXIT</action>
   </button>
   <button cancel>
   <action> rm $POP $EXC $ICO </action>
   <action type=\"exit\">EXIT:ok</action>
   </button>
  </hbox>
</vbox>"

##------------run------------->>
gtkdialog3 --program JWM_Panel_Button_Add

##----------cleanup------------>>
unset JWM_Panel_Button_Add

new_line=`echo \<TrayButton popup\=\"``cat /tmp/JWMconfig/tmp-popup.txt``echo \" icon\=\"``cat /tmp/JWMconfig/tmp-icon.txt``echo \"\>``cat /tmp/JWMconfig/tmp-exec.txt``echo \</TrayButton\>`  ### builds new line for .jwmrc-tray
echo -e "\t\t$new_line" >> /tmp/JWMconfig/jwmrc-tray-panel.txt

cat /tmp/JWMconfig/jwmrc-tray-panel.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
cat /tmp/JWMconfig/jwmrc-tray-tail.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
mv /tmp/JWMconfig/jwmrc-tray-head.txt $HOME/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Adding complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

rm -f /tmp/JWMconfig/jwmrc-tray-*
rm -f /tmp/JWMconfig/tmp-popup.txt
rm -f /tmp/JWMconfig/tmp-icon.txt
rm -r /tmp/JWMconfig/tmp-exec.txt
exit 0
fi


if [ "$choice" = "Remove" ]; then #1.0

y=1

z=$(($high -$begin))
while [ "$begin" != "$high" ]; do

PB=`cat $HOME/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//g' | sed -e 's/\".*//g' | sed 's/^[ \t]*//'`

Xdialog --backtitle "Remove panel buttons" \
	--title "RADIOLIST BOX" \
        --radiolist "Would you like to delete $PB\n\
from the panel? If you want to delete it choose\n\
yes, otherwise choose no." 26 46 5 \
        "no"    "no do not delete this button" ON \
        "yes" "yes delete this button" off 2>/tmp/JWMconfig/checklist.tmp.$$

retval=$?
choice=`cat /tmp/JWMconfig/checklist.tmp.$$`
rm -f /tmp/JWMconfig/checklist.tmp.$$

F_0_further_1_exit_rm_255_exit_rm_func

if [ "$choice" = "no" ]; then #1.1.0
cat $HOME/.jwmrc-tray | sed -n ""$begin"p" >> /tmp/JWMconfig/jwmrc-tray-head.txt
fi #1.1.0

begin=$(($begin + 1))
y=$(($y + 1))
shift
done

cat /tmp/JWMconfig/jwmrc-tray-tail.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
mv /tmp/JWMconfig/jwmrc-tray-head.txt $HOME/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Removing complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

rm -f /tmp/JWMconfig/jwmrc-tray*
exit 0
fi #1.0


##### MOVE PART ####

error_mesg_func(){
if [ -f /tmp/JWMconfig/jwmrc-tray-tmp-`expr 100 + $begin`.txt -o "$1" = "invalid_input" ]; then
Xdialog --title "MESSAGE BOX" \
        --msgbox "Something went wrong \n
    `cat /tmp/JWMconfig/jwmrc-tray-tmp-$(( 100 + $begin)).txt`
	$input
    Start new ! " 10 35
        rm -f /tmp/JWMconfig/jwmrc-tray*
        exit 0        
       fi
}

if [ "$choice" = "Move" ]; then # 1.0

b=$(($begin - 1)) ##b eventually not needed
grep -n '<TrayButton popup' $HOME/.jwmrc-tray | grep -v '<!--' > /tmp/JWMconfig/jwmrc-tray-g0.txt
z=`grep -c '<TrayButton popup' /tmp/JWMconfig/jwmrc-tray-g0.txt` ##total number of tray buttons incl commented ones
buttonsTotalRaw=`grep -c '<TrayButton popup' /tmp/JWMconfig/jwmrc-tray-g0.txt`
y=0 ##actual number of valid button at process loop
actualButtonNumber=0

while [ "$begin" != "$high" ]; do

(( b++ )) ##b=$((b+1)) ; b=$begin ##b eventually not needed

##PB = single Panel Button
PB=`cat $HOME/.jwmrc-tray | sed -n "$begin p" | sed -e 's/<TrayButton popup="//g' | sed -e 's/\".*//g' | sed 's/^[ \t]*//'`

#cat -n $HOME/.jwmrc-tray | sed 's/^[[:blank:]]*//g;s/\([[:digit:]]*\)\([[:blank:]]\)\(.*\)/\1\|\3/g' -> example line:34|</JWM>
#LINE=`cat -n $HOME/.jwmrc-tray | grep "$PB" | grep -w $b -m 1` ##b eventually not needed
LINE=`cat -n $HOME/.jwmrc-tray | grep "$PB" | grep -w $begin -m 1` #grep filters leading blanks from cat -n already (::HAPPY::)
##LINE = actual line in .jwmrc-tray ;  LINE = $begin

#LINENR=`echo "$LINE" | cut -f 2 -d ' '` ## echo "$LINE" does not work , perhaps of doublequotes inside
#LINENR=`echo $LINE | cut -f 1 -d ' '` #should be $begin

LINEwoNr=`echo $LINE | cut -f 2-99 -d ' ' | sed 's#\t##g ; s#^#\t\t#'`  ##TODO : \t\t does not show in file ??

if test "$LINEwoNr" = "$b"; then # 1.1.0
LINEwoNr=" " ; echo "$LINEwoNr" > /tmp/JWMconfig/jwmrc-tray-move-$begin.txt

else # 1.1.0
echo "$LINEwoNr" > /tmp/JWMconfig/jwmrc-tray-move-$begin.txt
fi # 1.1.0

SKIP=""
echo "$PB" | grep -q '^<!--' && SKIP="yes"
[ "$PB" = "" ] && SKIP="yes"

#yy="$b" ##b eventually not needed
#yy="$begin" #yy eventually not needed here

if [ "$SKIP" != "yes" ]; then # 1.2.0

(( y++ )) ##not needed , replaced by actualButtonNumber
echo $y 
actualButtonNumber=$((actualButtonNumber+1))
echo $actualButtonNumber

#TTPT=`cat /root/.jwmrc-tray | grep "$PB"`
#TTPTnr=`cat -n $HOME/.jwmrc-tray | sed 's#^ *##g' | grep "$PB" | grep "^$LINENR"`
TTPTnr=`cat -n $HOME/.jwmrc-tray | sed 's#^ *##g' | grep "$PB" | grep "^$begin"`
TTPT=`echo "$TTPTnr" | sed 's#^[0-9]*## ; s#\t##g ; s#^#\t\t#'` ##TODO : \t\t does not show in file ??
echo "$TTPT" > /tmp/JWMconfig/jwmrc-tray-move-$begin.txt

Xdialog --title "INPUT BOX" \
        --inputbox "$PB is button $actualButtonNumber of your $buttonsTotalRaw buttons.\n\
\n\
If you would like that button in another\n\
position please enter the number below." 18 50 2> /tmp/JWMconfig/inputbox.tmp.$$

retval=$?
input=`cat /tmp/JWMconfig/inputbox.tmp.$$`
rm -f /tmp/JWMconfig/inputbox.tmp.$$

F_0_further_1_exit_rm_255_exit_rm_func
if [ "$retval" != 0 ]; then # 1.2.1.0
rm -f /tmp/JWMconfig/jwmrc-tray*
exit 0
fi # 1.2.1.0

#if test "`echo $input | grep -i '[a-z]'`" != "" ; then error_mesg_func invalid_input ; fi #1.2.1.1
if test "`echo $input`" = "" ; then input=$actualButtonNumber ; fi ##2011_10_25 changed position of test
if test "`echo $input | grep -v -w -x -e '[0-9]*'`" != "" ; then error_mesg_func invalid_input ; fi
if [ "$input" -gt "$buttonsTotalRaw" -o "$input" -lt 1 ] ; then error_mesg_func invalid_input ; fi
#if test "`echo $input`" = "" ; then input=$actualButtonNumber ; fi # 1.2.1.2
if [ "$input" != "" ]; then # 1.2.1.3

if test "$input" -lt $actualButtonNumber ; then Math="-"; yy=$(( $actualButtonNumber - $input )); fi #1.2.1.3.1
if test "$input" -gt $actualButtonNumber ; then Math="+"; yy=$(( $input - $actualButtonNumber )); fi #1.2.1.3.2
if test "$input" -eq $actualButtonNumber ; then Math="+"; yy="0"; fi #1.2.1.3.3

LINENRnew=$(( $begin $Math $yy ))

if [ -f /tmp/JWMconfig/jwmrc-tray-tmp-$((100 + $LINENRnew)).txt ]; then #1.2.1.3.4
Xdialog --title "MESSAGE BOX" \
        --msgbox "Position "$input"
	     has already been selected.
	     you must now start over." 10 41

F_0_further_255_further_func
rm -f /tmp/JWMconfig/jwmrc-tray*
exit 0
fi # 1.2.1.3.4

mv /tmp/JWMconfig/jwmrc-tray-move-"$begin".txt /tmp/JWMconfig/jwmrc-tray-tmp-`expr 100 + $LINENRnew`.txt
fi # 1.2.1.0

else # 1.2.0 

error_mesg_func  ##check ??

mv /tmp/JWMconfig/jwmrc-tray-move-"$begin".txt /tmp/JWMconfig/jwmrc-tray-tmp-`expr 100 + $begin`.txt

fi # 1.2.0

begin=$(($begin + 1))
shift
done

cat /tmp/JWMconfig/jwmrc-tray-tmp-* >> /tmp/JWMconfig/jwmrc-tray-head.txt
cat /tmp/JWMconfig/jwmrc-tray-tail.txt >> /tmp/JWMconfig/jwmrc-tray-head.txt
mv /tmp/JWMconfig/jwmrc-tray-head.txt $HOME/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Moving complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func    

fi # 1.0

rm -f /tmp/JWMconfig/jwmrc-tray*

exit 0
