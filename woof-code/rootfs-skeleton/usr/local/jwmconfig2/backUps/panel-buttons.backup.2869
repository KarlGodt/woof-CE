#!/bin/sh

####################################
#
# A JWM panel button configuring tool
# for jwmconfig
# 2006-NOV-05
# by plinej
#
#####################################
# 2009-NOV-06 low and high position fixed by himajin, shinobar
# 23aug2010 shinobar: skip comments from edit

##_____________________________________________________________________________________________________________________________##
# Fri Apr  8 02:39:57 GMT-1 2011 Karl Reimer Godt																				#
# 2.6.34-KRG-i486-compiled-AcerLaptop-rev4.1 Lucid Puppy 218 http://murga-linux.com/puppy/viewtopic.php?t=58978					#
# fixes for the low and high positions :)																						#
# replaced the use of `echo "(("$VAL1" "$MATH" "$VAL2"))" | bc -l` with $(($VAL1 ... )) to eliminate the possibility of floats	#
# made functions for the multiply use of "case $? in ..."																		#
# the "MOVE" part should work now																								#
# cleaned up and deleted much ( to be found it in the original 431 or 511 )	^Ooops^												#
##_____________________________________________________________________________________________________________________________##

if [ ! -f /root/.jwmrc-tray-bak ]; then
cp /root/.jwmrc-tray /root/.jwmrc-tray-bak  ### makes .jwmrc-tray-bak backup file unless it already exists
fi
#cat /root/.jwmrc-tray | sed 's#^[[:blank:]]*$##g' | sed '/^$/d' > /tmp/.jwmrc-tray
cat /root/.jwmrc-tray | grep -v -x '^[[:blank:]]*' > /tmp/.jwmrc-tray ### remove all blank lines in .jwmrc-tray
mv /tmp/.jwmrc-tray /root/

if test "`tail -n 1 /root/.jwmrc-tray | hexdump | grep -o '0a'`" = "" ; then
 #KRGensure newline so wc counts the real line numbers :)
 
 lastLine=`cat /root/.jwmrc-tray | tail -n 1`
 #addJMWendNEWline=`echo $lastLine| sed 's#$#\n#'`
 
 if test "$lastLine" = "</JWM>" ;then 
 echo >> /root/.jwmrc-tray
 else
 if test "`grep -o -w '</JWM>' /root/.jwmrc-tray`" = "" ; then
 echo '</JWM>' >> /root/.jwmrc-tray
 echo >> /root/.jwmrc-tray
 fi
 fi
fi
 
# 2009-NOV-06 low and high position fixed 

total=`wc -l /root/.jwmrc-tray | cut -f1 -d' '` ### get total number of lines
low=`grep -n '^[[:blank:]]*<TrayButton popup' /root/.jwmrc-tray | head -n 1 | cut -d':' -f1`  ### get line number of the first button (Menu)
low=$(($low - 1)) ## nr until to preserve the head of jwmrc-tray

high=`grep '<!-- Additional Pager attributes; width, height -->' -n /root/.jwmrc-tray | sed -e 's/\:.*>//g'` ### get line number with Additional Pager

last=$(($total - $high + 1))

begin=$(($low + 1)) ### first line with panel buttons , without menubutton [requires menubutton first in this partic. list]

cat /root/.jwmrc-tray | head -n "$low" > /tmp/jwmrc-tray-head.txt
echo >> /tmp/jwmrc-tray-head.txt # one empty line for better overview
echo > /tmp/jwmrc-tray-tail.txt  # -"-
cat /root/.jwmrc-tray | tail -n "$last" >> /tmp/jwmrc-tray-tail.txt

echo $DBG 64 "total=$total, low=$low, high=$high, last=$last, begin=$begin"
num=1

F_0_further_1_exit_rm_255_exit_rm_func() {
	
case $retval in 
  0)
    echo "'$choice' chosen.";;
  1|255)
    echo "Cancel pressed or Box closed"
     rm /tmp/jwm*
    exit 0
    ;;
esac
	
}

F_0_further_255_exit_func() {
	
case $? in
  0)
    echo "OK";;
  255)
    echo "Box closed."
    exit 0
    ;;
esac
	
}

F_0_further_255_further_func() {
	
case $? in
  0)
    echo "OK";;
  255)
    echo "Box closed.";;
esac
	
}


### xdialog radiolist gui
Xdialog --backtitle "" \
	--title "RADIOLIST BOX" \
        --radiolist "JWM panel button configuring tool." 26 46 5 \
        "Edit" "Edit your existing Panel Buttons" ON \
        "Add" "Add a panel button" off \
        "Move" "Move panel buttons around" off \
	"Remove" "Remove a panel button" off\
        "Restore" "Restore original .jwmrc-tray" off \
        "Backup" "Backup your current .jwmrc-tray" off \
	"Exit" "Exit this program" off 2>/tmp/checklist.tmp.$$

retval=$?
choice=`cat /tmp/checklist.tmp.$$`
rm -f /tmp/checklist.tmp.$$

if [ "$retval" != 0 ]; then
rm /tmp/jwm*
exit
fi

F_0_further_1_exit_rm_255_exit_rm_func

if [ "$choice" = "Exit" ]; then
rm /tmp/jwm*
exit 0
fi
if [ "$choice" = "Backup" ]; then
rm /tmp/jwm*
Xdialog --title "MESSAGE BOX" \
        --msgbox "This will backup your current
	     .jwmrc-tray and will be the version
	     that gets restored if you choose restore." 10 41

F_0_further_255_exit_func

cp /root/.jwmrc-tray /root/.jwmrc-tray-bak
exit 0
fi


if [ "$choice" = "Restore" ]; then
rm /tmp/jwm*
Xdialog --title "MESSAGE BOX" \
        --msgbox "Your original .jwmrc-tray
        file has been restored.
	     You must restart jwm for
	     changes to take effect." 10 41
	     
F_0_further_255_exit_func

[ -f /root/.jwmrc-tray-bak ] && cp -f /root/.jwmrc-tray-bak /root/.jwmrc-tray
exit 0
fi


if [ "$choice" = "Edit" ]; then
echo "Debug: $begin":"$high"
while [ "$begin" != "$high" ]; do

cat /root/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//' | sed -e 's/\".*//' | sed 's/^[ \t]*//' > /tmp/tmp-popup.txt  ### gets popup text
popup=`cat /tmp/tmp-popup.txt`
cat /root/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//' | sed -e "s/$popup//" | sed -e 's/" icon="//' | sed -e 's/\".*//' | sed 's/^[ \t]*//' > /tmp/tmp-icon.txt  ### gets icon text
icon=`cat /tmp/tmp-icon.txt`
cat /root/.jwmrc-tray | sed -n ""$begin"p" | sed 's/\<.*\"//g' | sed -e 's/<\/TrayButton>//' | sed -e 's/<>//' | sed 's/^[ \t]*//' > /tmp/tmp-exec.txt  ### gets executable text
#action=`cat /tmp/tmp-exec.txt`
SKIP=""
echo "$popup" | grep -q '^<!--' && SKIP="yes"
[ "$icon" = "" ] && SKIP="yes"
if [ "$SKIP" != "yes" ]; then
 ### This is the Edit gui
 export JWM_Panel_Button_Editor="
<vbox>
 <frame Button $num Information - edit as you wish>
  <hbox>
      <text><label>Popup display</label></text>
      <entry>
    <variable>Entry1</variable>
    <input>cat /tmp/tmp-popup.txt</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>executable</label></text>
      <entry>
    <variable>Entry3</variable>
    <input>cat /tmp/tmp-exec.txt</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>Icon name</label></text>
      <entry>
    <variable>Entry2</variable>
    <input>cat /tmp/tmp-icon.txt</input>
    </entry>
    <button>
      <input file>/usr/local/lib/X11/mini-icons/dir_o.xpm</input>
      <action>./file-selector</action>
      <action>refresh:Entry2</action>
    </button>
  </hbox>
 </frame>
  <hbox>
   <button ok>
	<action>echo \$Entry1 | tee /tmp/tmp-popup-$num.txt</action>
	<action>echo \$Entry2 | tee /tmp/tmp-icon-$num.txt</action>
	<action>echo \$Entry3 | tee /tmp/tmp-exec-$num.txt</action>
	<action type=\"exit\">EXIT</action>
   </button>
   <button cancel>
   <action> rm $POP $EXC $ICO </action>
   <action type=\"exit\">EXIT:ok</action>
   </button>
  </hbox>
</vbox>"

 ##------------run------------->>
 gtkdialog3 --program JWM_Panel_Button_Editor

 ##----------cleanup------------>>
 unset JWM_Panel_Button_Editor

 new_line=`echo \<TrayButton popup\=\"``cat /tmp/tmp-popup-$num.txt``echo \" icon\=\"``cat /tmp/tmp-icon-$num.txt``echo \"\>``cat /tmp/tmp-exec-$num.txt``echo \</TrayButton\>`  ### builds replacement line for .jwmrc-tray
 echo "$new_line" >> /tmp/jwmrc-tray-2.txt
fi

begin=$(($begin +1))
num=$(($num +1))
shift
done

cat /tmp/jwmrc-tray-2.txt >> /tmp/jwmrc-tray-head.txt
cat /tmp/jwmrc-tray-tail.txt >> /tmp/jwmrc-tray-head.txt
mv /tmp/jwmrc-tray-head.txt /root/.jwmrc-tray

rm -f /tmp/jwmrc-tray-*
rm -f /tmp/tmp-popup*.txt
rm -f /tmp/tmp-icon*.txt
rm -r /tmp/tmp-exec*.txt

Xdialog --title "MESSAGE BOX" \
        --msgbox "Editing complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

exit 0
fi



if [ "$choice" = "Add" ]; then
while [ "$begin" != "$high" ]; do
cat /root/.jwmrc-tray | sed -n ""$begin"p" >> /tmp/jwmrc-tray-panel.txt

begin=$(($begin + 1))
shift
done

### This is the Add gui
export JWM_Panel_Button_Add="
<vbox>
 <frame Button Add>
  <hbox>
      <text><label>Popup display</label></text>
      <entry>
    <variable>Entry1</variable>
      </entry>
  </hbox>
  <hbox>
      <text><label>executable</label></text>
      <entry>
    <variable>Entry3</variable>
    <input>echo exec:</input>
      </entry>
  </hbox>
  <hbox>
      <text><label>Select icon</label></text>
      <entry>
    <variable>Entry2</variable>
    <input>cat /tmp/tmp-icon.txt</input>
    </entry>
    <button>
      <input file>/usr/local/lib/X11/mini-icons/dir_o.xpm</input>
      <action>./file-selector</action>
      <action>refresh:Entry2</action>
    </button>
  </hbox>
  </frame>
  <hbox>
   <button ok>
	<action>echo \$Entry1 | tee /tmp/tmp-popup.txt</action>
	<action>echo \$Entry3 | tee /tmp/tmp-exec.txt</action>
	<action type=\"exit\">EXIT</action>
   </button>
   <button cancel>
   <action> rm $POP $EXC $ICO </action>
   <action type=\"exit\">EXIT:ok</action>
   </button>
  </hbox>
</vbox>"

##------------run------------->>
gtkdialog3 --program JWM_Panel_Button_Add

##----------cleanup------------>>
unset JWM_Panel_Button_Add

new_line=`echo \<TrayButton popup\=\"``cat /tmp/tmp-popup.txt``echo \" icon\=\"``cat /tmp/tmp-icon.txt``echo \"\>``cat /tmp/tmp-exec.txt``echo \</TrayButton\>`  ### builds new line for .jwmrc-tray
echo -e "\t\t$new_line" >> /tmp/jwmrc-tray-panel.txt

cat /tmp/jwmrc-tray-panel.txt >> /tmp/jwmrc-tray-head.txt
cat /tmp/jwmrc-tray-tail.txt >> /tmp/jwmrc-tray-head.txt
mv /tmp/jwmrc-tray-head.txt /root/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Adding complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

rm -f /tmp/jwmrc-tray-*
rm -f /tmp/tmp-popup.txt
rm -f /tmp/tmp-icon.txt
rm -r /tmp/tmp-exec.txt
exit 0
fi


if [ "$choice" = "Remove" ]; then #1.0

y=1

z=$(($high -$begin))
while [ "$begin" != "$high" ]; do

PB=`cat /root/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//g' | sed -e 's/\".*//g' | sed 's/^[ \t]*//'`

Xdialog --backtitle "Remove panel buttons" \
	--title "RADIOLIST BOX" \
        --radiolist "Would you like to delete $PB\n\
from the panel? If you want to delete it choose\n\
yes, otherwise choose no." 26 46 5 \
        "no"    "no do not delete this button" ON \
        "yes" "yes delete this button" off 2>/tmp/checklist.tmp.$$

retval=$?
choice=`cat /tmp/checklist.tmp.$$`
rm -f /tmp/checklist.tmp.$$

F_0_further_1_exit_rm_255_exit_rm_func

if [ "$choice" = "no" ]; then #1.1.0
cat /root/.jwmrc-tray | sed -n ""$begin"p" >> /tmp/jwmrc-tray-head.txt
fi #1.1.0

begin=$(($begin + 1))
y=$(($y + 1))
shift
done

cat /tmp/jwmrc-tray-tail.txt >> /tmp/jwmrc-tray-head.txt
mv /tmp/jwmrc-tray-head.txt /root/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Removing complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func

rm -f /tmp/jwmrc-tray*
exit 0
fi #1.0


##### MOVE PART ####

error_mesg_func(){
if [ -f /tmp/jwmrc-tray-tmp-`expr 100 + $LINENR`.txt -o "$1" = "invalid_input" ]; then
Xdialog --title "MESSAGE BOX" \
        --msgbox "Something went wrong \n
    `cat /tmp/jwmrc-tray-tmp-$(( 100 + $LINENR)).txt`
	$input
    Start new ! " 10 35
        rm -f /tmp/jwmrc-tray*
        exit 0        
       fi
}

if [ "$choice" = "Move" ]; then # 1.0

b=$(($begin - 1)) 
grep -n '<TrayButton popup' /root/.jwmrc-tray | grep -v '<!--' > /tmp/jwmrc-tray-g0.txt
z=`grep -c '<TrayButton popup' /tmp/jwmrc-tray-g0.txt`
y=0

while [ "$begin" != "$high" ]; do

(( b++ ))

yy="$b"
PB=`cat /root/.jwmrc-tray | sed -n ""$begin"p" | sed -e 's/<TrayButton popup="//g' | sed -e 's/\".*//g' | sed 's/^[ \t]*//'`

LINE=`cat -n /root/.jwmrc-tray | grep "$PB" | grep -w $b -m 1`

#LINENR=`echo "$LINE" | cut -f 2 -d ' '` ## echo "$LINE" does not work , perhaps of doublequotes inside
LINENR=`echo $LINE | cut -f 1 -d ' '`

LINEwoNr=`echo $LINE | cut -f 2-99 -d ' ' | sed 's#\t##g ; s#^#\t\t#'`

if test "$LINEwoNr" = "$b"; then # 1.1.0
LINEwoNr=" " ; echo "$LINEwoNr" > /tmp/jwmrc-tray-move-$LINENR.txt

else # 1.1.0
echo "$LINEwoNr" > /tmp/jwmrc-tray-move-$LINENR.txt
fi # 1.1.0
SKIP=""
echo "$PB" | grep -q '^<!--' && SKIP="yes"
[ "$PB" = "" ] && SKIP="yes"

if [ "$SKIP" != "yes" ]; then # 1.2.0

(( y++ ))
echo $y
#TTPT=`cat /root/.jwmrc-tray | grep "$PB"`
TTPTnr=`cat -n /root/.jwmrc-tray | sed 's#^ *##g' | grep "$PB" | grep "^$LINENR"`
TTPT=`echo "$TTPTnr" | sed 's#^[0-9]*## ; s#\t##g ; s#^#\t\t#'`
echo "$TTPT" > /tmp/jwmrc-tray-move-$LINENR.txt

Xdialog --title "INPUT BOX" \
        --inputbox "$PB is button $y of your $z buttons.\n\
\n\
If you would like that button in another\n\
position please enter the number below." 18 50 2> /tmp/inputbox.tmp.$$

retval=$?
input=`cat /tmp/inputbox.tmp.$$`
rm -f /tmp/inputbox.tmp.$$

F_0_further_1_exit_rm_255_exit_rm_func

if [ "$retval" != 0 ]; then # 1.2.1.0
rm -f /tmp/jwmrc-tray*
exit 0
fi # 1.2.1.0
#if test "`echo $input | grep -i '[a-z]'`" != "" ; then error_mesg_func invalid_input ; fi #1.2.1.1
if test "`echo $input | grep -v -w -x '[0-9]*'`" != "" ; then error_mesg_func invalid_input ; fi
if [ "$input" -gt "$z" -o "$input" -lt 1 ] ; then error_mesg_func invalid_input ; fi
if test "`echo $input`" = "" ; then input=$y ; fi # 1.2.1.2
if [ "$input" != "" ]; then # 1.2.1.3

if test "$input" -lt $y ; then Math="-"; yy=$(( $y - $input )); fi #1.2.1.3.1
if test "$input" -gt $y ; then Math="+"; yy=$(( $input - $y )); fi #1.2.1.3.2
if test "$input" -eq $y ; then Math="+"; yy="0"; fi #1.2.1.3.3

LINENRnew=$(( $LINENR $Math $yy ))

if [ -f /tmp/jwmrc-tray-tmp-$((100 + $LINENRnew)).txt ]; then #1.2.1.3.4
Xdialog --title "MESSAGE BOX" \
        --msgbox "Position "$input"
	     has already been selected.
	     you must now start over." 10 41

F_0_further_255_further_func

rm -f /tmp/jwmrc-tray*
exit 0

fi # 1.2.1.3.4

mv /tmp/jwmrc-tray-move-"$LINENR".txt /tmp/jwmrc-tray-tmp-`expr 100 + $LINENRnew`.txt
fi # 1.2.1.0
else # 1.2.0 

error_mesg_func

mv /tmp/jwmrc-tray-move-"$LINENR".txt /tmp/jwmrc-tray-tmp-`expr 100 + $LINENR`.txt

fi # 1.2.0

begin=$(($begin + 1))
shift
done

cat /tmp/jwmrc-tray-tmp-* >> /tmp/jwmrc-tray-head.txt
cat /tmp/jwmrc-tray-tail.txt >> /tmp/jwmrc-tray-head.txt
mv /tmp/jwmrc-tray-head.txt /root/.jwmrc-tray

Xdialog --title "MESSAGE BOX" \
        --msgbox "Moving complete.
	     You must restart jwm for
	     changes to take effect." 10 41

F_0_further_255_further_func    

fi # 1.0

rm -f /tmp/jwmrc-tray*

exit 0
