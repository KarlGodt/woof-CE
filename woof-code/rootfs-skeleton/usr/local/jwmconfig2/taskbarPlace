#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_taskbarPlace"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/jwmconfig2/taskbarPlace"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
#
# Code adapted for Puppy 1.0.9, JWM 1.7
# by Kwiller on 6-May-2006
#
###################

##-----taskbarPlace----->>

########################################################################
#
#
#
#
#
# /dev/hda7
# /dev/hda7:
# LABEL="/"
# UUID="429ee1ed-70a4-43a5-89f8-33496c489260"
# TYPE="ext4"
# DISTRO_NAME='Lucid·Puppy'
# DISTRO_VERSION=218
# DISTRO_MINOR_VERSION=00
# DISTRO_BINARY_COMPAT='ubuntu'
# DISTRO_FILE_PREFIX='luci'
# DISTRO_COMPAT_VERSION='lucid'
# DISTRO_KERNEL_PET='linux_kernel-2.6.33.2-tickless_smp_patched-L3.pet'
# PUPMODE=2
# SATADRIVES=''
# PUP_HOME='/'
# PDEV1='hda7'
# DEV1FS='ext4'
# Linux·puppypc·2.6.31.14·#1·Mon·Jan·24·21:03:21·GMT-8·2011·i686·GNU/Linux
# Xserver=/usr/bin/Xorg
# $LANG=en_US
# today=Tue·Oct·25·19:11:57·GMT+1·2011
#
#
#
#
#
########################################################################

GEO=`xwininfo -root | grep 'geometry'|awk '{print $2}' |cut -f 1 -d '+'`
GEO_X=`echo "$GEO" |cut -f 1 -d 'x'`
GEO_Y=`echo "$GEO" |cut -f 2 -d 'x'`

TMP="/tmp/JWMconfig/checklist.tmp.$$"
mkdir $VERB -p "${TMP%/*}"

TOP="0";TOPL=horizontal;TOPA=right;TOPH=28;TOPV=top;TOPW=$GEO_X
BTM="-1";BTML=horizontal;BTMA=left;BTMH=28;BTMV=bottom;BTMW=$GEO_X
RIG='1';RIGL=vertical;RIGA=right;RIGH=$((GEO_Y));RIGV=top;RIGW=48
LEF='2';LEFL=vertical;LEFA=left;LEFH=$((GEO_Y));LEFV=top;LEFW=48

CONF_TRAY="/root/.jwmrc-tray"
CONF_BAK="/root/.jwmrc-tray-bak"
CONF_TMP="/root/.jwmrc-tray-temp"

check_config(){
#------check new configuration----->>
jwm -p 2> "$TMP"
CHECKCONF=`cat "$TMP" |grep -viE 'DEBUG:|no version information'`
[ "$CHECKCONF" ] || return 0
RESMSG="Current configuration not OK:\n$CHECKCONF\nLaunching Editor ..."
RESTOP="Refusing to continue."

defaulttexteditor "$CONF_TRAY" &
sleep 3
Xdialog --title "$RESTOP" --msgbox "$RESMSG" 0 0 &
exit 1
}
check_config

#---get value--->

   SET_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* y="([-[:digit:]]+)"|^<Tray .* y="([-[:digit:]]+)"' "$CONF_TRAY" | sed 's|\(.* y="\)\([-[:digit:]]*\)\(" .*\)|\2|'`
LAYOUT_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* layout="([[:alpha:]]+)"|^<Tray .* layout="([[:alpha:]]+)"' "$CONF_TRAY" | sed 's|\(.* layout="\)\([[:alpha:]]*\)\(" .*\)|\2|'`
HALIGN_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* halign="([[:alpha:]]+)"|^<Tray .* halign="([[:alpha:]]+)"' "$CONF_TRAY" | sed 's|\(.* halign="\)\([[:alpha:]]*\)\(" .*\)|\2|'`
HEIGHT_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* height="([[:digit:]]+)"|^<Tray .* height="([[:digit:]]+)"' "$CONF_TRAY" | sed 's|\(.* height="\)\([[:digit:]]*\)\(" .*\)|\2|'`
VALIGN_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* valign="([[:alpha:]]+)"|^<Tray .* valign="([[:alpha:]]+)"' "$CONF_TRAY" | sed 's|\(.* valign="\)\([[:alpha:]]*\)\(" .*\)|\2|'`
 WIDTH_NOW=`grep -m 1 -E -e '^([[:blank:]]*)<Tray .* width="([[:digit:]]+)"|^<Tray .* width="([[:digit:]]+)"' "$CONF_TRAY" | sed 's|\(.* width="\)\([[:digit:]]*\)\(" .*\)|\2|'`

echo    SET_NOW=$SET_NOW
echo LAYOUT_NOW=$LAYOUT_NOW
echo HALIGN_NOW=$HALIGN_NOW
echo HEIGHT_NOW=$HEIGHT_NOW
echo VALIGN_NOW=$VALIGN_NOW
echo  WIDTH_NOW=$WIDTH_NOW

if [ "$LAYOUT_NOW" = '' ] ; then
sed -i 's|^\([[:blank:]]*<Tray .*\)\(layout[^ ]*\)\(.*\)|\1\3|' "$CONF_TRAY"
sed -i 's|^\([[:blank:]]*<Tray \)\(.*\)\( .*\)|\1\2 layout="vertical"\3|' "$CONF_TRAY"
sleep 1
check_config
fi

if [ "$HALIGN_NOW" = '' ] ; then
sed -i 's|^\([[:blank:]]*<Tray .*\)\(halign[^ ]*\)\(.*\)|\1\3|' "$CONF_TRAY"
sed -i 's|^\([[:blank:]]*<Tray .*\)\(.*\)\( .*\)|\1\2 halign="left"\3|' "$CONF_TRAY"
sleep 1
check_config
fi

if [ "$HEIGHT_NOW" = '' ] ; then
sed -i 's|^\([[:blank:]]*<Tray .*\)\(height[^ ]*\)\(.*\)|\1\3|' "$CONF_TRAY"
sed -i 's|^\([[:blank:]]*<Tray .*\)\(.*\)\( .*\)|\1\2 height="28"\2|' "$CONF_TRAY"
sleep 1
check_config
fi

if [ "$VALIGN_NOW" = '' ] ; then
sed -i 's|^\([[:blank:]]*<Tray .*\)\(valign[^ ]*\)\(.*\)|\1\3|' "$CONF_TRAY"
sed -i 's|^\([[:blank:]]*<Tray .*\)\(.*\)\( .*\)|\1\2 valign="bottom"\3|' "$CONF_TRAY"
sleep 1
check_config
fi

if [ "$WIDTH_NOW" = '' ] ; then
sed -i 's|^\([[:blank:]]*<Tray .*\)\(width[^ ]*\)\(.*\)|\1\3|' "$CONF_TRAY"
sed -i "s|^\([[:blank:]]*<Tray .*\)\(.*\)\( .*\)|\1\2 width=\"$GEO_X\"\3|" "$CONF_TRAY"
sleep 1
check_config
fi


AT_TOP=off;AT_BTM=off;AT_RIG=off;AT_LEF=off
case $SET_NOW in
-1) AT_BTM=on;;
0)  AT_TOP=on;;
1)  AT_RIG=on;;
2)  AT_LEF=on;;
esac

#-----Backup current settings----->>
cp $VERB "$CONF_TRAY" "$CONF_BAK"

#-------------gui----------->>

Xdialog --backtitle "JWM Taskbar Configuration" \
    --title "Taskbar" \
        --radiolist "Choose a tray placement option" 13 46 2 \
"BOTTOM"  "Tray at Bottom of Screen." $AT_BTM \
"TOP"  "Tray at Top of Screen" $AT_TOP \
"RIGHT"  "Tray at Right Side of Screen" $AT_RIG \
"LEFT"  "Tray at Left Side of Screen2" $AT_LEF 2>$TMP

retval=$?

#--------cancel pressed----->>
case $retval in
  1 | 255) echo "Quit.";exit 0;;
esac

#---------save changes----->>

#---
#SEDTOP=s!y=\"[-[:digit:]]*\"!y=\"$TOP\"!
SEDTOP=s!y=\"$SET_NOW\"!y=\"$TOP\"!
SEDTOQ=s!layout=\"$LAYOUT_NOW\"!layout=\"$TOPL\"!
SEDTOR=s!halign=\"$HALIGN_NOW\"!halign=\"$TOPA\"!
SEDTOS=s!height=\"$HEIGHT_NOW\"!height=\"$TOPH\"!
SEDTOT=s!valign=\"$VALIGN_NOW\"!valign=\"$TOPV\"!
SEDTOU=s!width=\"$WIDTH_NOW\"!width=\"$TOPW\"!
#SEDBTM=s!y=\"[-[:digit:]]*\"!y=\"$BTM\"!
SEDBTM=s!y=\"$SET_NOW\"!y=\"$BTM\"!
SEDBTQ=s!layout=\"$LAYOUT_NOW\"!layout=\"$BTML\"!
SEDBTR=s!halign=\"$HALIGN_NOW\"!halign=\"$BTMA\"!
SEDBTS=s!height=\"$HEIGHT_NOW\"!height=\"$BTMH\"!
SEDBTT=s!valign=\"$VALIGN_NOW\"!valign=\"$BTMV\"!
SEDBTU=s!width=\"$WIDTH_NOW\"!width=\"$BTMW\"!
#SEDRIG=s!y=\"[-[:digit:]]*\"!y=\"$RIG\"!
SEDRIG=s!y=\"$SET_NOW*\"!y=\"$RIG\"!
SEDRIH=s!layout=\"$LAYOUT_NOW\"!layout=\"$RIGL\"!
SEDRII=s!halign=\"$HALIGN_NOW\"!halign=\"$RIGA\"!
SEDRIJ=s!height=\"$HEIGHT_NOW\"!height=\"$RIGH\"!
SEDRIK=s!valign=\"$VALIGN_NOW\"!valign=\"$RIGV\"!
SEDRIL=s!width=\"$WIDTH_NOW\"!width=\"$RIGW\"!
#SEDLEF=s!y=\"[-[:digit:]]*\"!y=\"$LEF\"!
SEDLEF=s!y=\"$SET_NOW*\"!y=\"$LEF\"!
SEDLEH=s!layout=\"$LAYOUT_NOW\"!layout=\"$LEFL\"!
SEDLEI=s!halign=\"$HALIGN_NOW\"!halign=\"$LEFA\"!
SEDLEJ=s!height=\"$HEIGHT_NOW\"!height=\"$LEFH\"!
SEDLEK=s!valign=\"$VALIGN_NOW\"!valign=\"$LEFV\"!
SEDLEL=s!width=\"$WIDTH_NOW\"!width=\"$LEFW\"!

POSN=`cat "$TMP" | tail -n1`
echo "POSN='$POSN'"
#-----If there new settings chosen then make the changes----->>
case $POSN in
TOP)
sed -e "$SEDTOP" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDTOQ" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDTOR" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDTOS" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDTOT" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDTOU" "$CONF_TMP"  > "$CONF_TRAY"
;;
RIGHT)
sed -e "$SEDRIG" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDRIH" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDRII" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDRIJ" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDRIK" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDRIL" "$CONF_TMP"  > "$CONF_TRAY"
;;
LEFT)
sed -e "$SEDLEF" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDLEH" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDLEI" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDLEJ" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDLEK" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDLEL" "$CONF_TMP"  > "$CONF_TRAY"
;;
BOTTOM)
sed -e "$SEDBTM" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDBTQ" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDBTR" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDBTS" "$CONF_TMP"  > "$CONF_TRAY"
sed -e "$SEDBTT" "$CONF_TRAY" > "$CONF_TMP"
sed -e "$SEDBTU" "$CONF_TMP"  > "$CONF_TRAY"
;;
esac
#    mv $CONF_TMP $CONF_TRAY


#------check new configuration----->>
jwm -p 2> "$TMP"

CHECKCONF=`cat "$TMP" |grep -viE 'DEBUG:|no version information'`

#----notify of result----->>
if [ "$CHECKCONF" ]; then
    RESTOP="Change Reversed"
    RESMSG="$CHECKCONF\nNew config corrupt. Keeping original"
    mv $VERB "$CONF_BAK" "$CONF_TRAY"
else
   RESTOP="Change applied"
   RESMSG="Restart jwm to apply change"
fi


Xdialog --title "$RESTOP" --msgbox "$RESMSG" 0 0

#--------clean exit------->>
[ "$DEBUG" ] || rm $VERB -f "$TMP"
exit 0
# Very End of this file 'usr/local/jwmconfig2/taskbarPlace' #
###END###
