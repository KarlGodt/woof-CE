#!/bin/bash
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_defaultmediaplayer"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/bin/defaultmediaplayer"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || source /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#

simple(){
EXT="${@##*\.}"
BN="${@##*/}"
echo "$@"
echo "'$BN' '$EXT'"
file "$@" |grep -iE 'media|video|audio|Matroska' || { xmessage -bg red "$0:
Sorry, '$@' not a media file.
"
exit 200
}

}

MY_SELF=`realpath "$0"`
MY_BASE=${MY_SELF##*/}
exec 2>>/tmp/$MY_BASE.log 1>&2

NR=`set |grep BASH_ARGC`;
echo -n "BASH_ARGC: $NR : "  # expl: BASH_ARGC: BASH_ARGC=([0]="1") : 1
NR="${NR##*=}";NR="${NR//\"/}";NR="${NR//)/}";
N=$NR;    #keep original nr
echo $NR  #NR get decremented

PARAMS=`set |grep BASH_ARGV |grep -o '=(.*)$'`
PARAMS=`echo "$PARAMS" |sed 's|^=(||;s|)$||'`
PARAMS=`echo "$PARAMS" |sed 's|" \(\[[0-9]*\]="\)|"\n\1|g'`
echo "PARAMS='$PARAMS'"  #expl: PARAMS='[0]="cdda://"'

while read p;do
echo "p='$p'"              #expl: p='[0]="cdda://"'
param="${p#*=}"
((NR--))
echo "param[$NR]='$param'"   #expl: param[0]='"cdda://"'
eval parameters[$NR]=$param
done<<EOI
$(echo "$PARAMS")
EOI
echo "PARAMETERS ALL: ${parameters[@]}"
#echo "$PARAMS"

for i in `seq 0 1 $((N-1))`;do
echo "${parameters[$i]}"
if [ -f "${parameters[$i]}" ];then
simple "${parameters[$i]}"
fi
done

case $EXT in
flv|FLV)
#exe=vlc;;
#exe=gxineshell;;
exe=gnome-mplayer;;
mp*|MP*)
exe='gmplayer -ao oss';;
mkv)
exe='gmplayer -ao oss';;
'')
exe='gmplayer -ao oss';;
*)
#exe=gxineshell;;
exe=gnome-mplayer;;
esac

[ "`which $exe`" ] || { xmessage -bg  red "$0:
Sorry, $exe seems not to be installed in the PATH.
"
exit 201
}

# REM: Try to omitt run twice by pup_event_frontend_d
ps | grep "$exe" | grep "${parameters[@]}"    #DEBUG
ps | grep "$exe" | grep $Q "${parameters[@]}" && exit 0

exec $exe "${parameters[@]}"
