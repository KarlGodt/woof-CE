#!/bin/sh
#(c) Copyright Nov 2007 Barry Kauler www.puppylinux.com
#2007 Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
#written dec 2007 for Puppy Linux.
#v3.98 BK: fix unionfs saving problem when newer file in pup_save.
#v4.00 HairyWill: restart rox and jwm immediately.
#w477 record name of theme in /etc/desktop_icon_theme
#100411 fbpanel menu did not update.

FILENAME0=

FILENAME10=
FILENAME11=
FILENAME12=

FILENAME20=
FILENAME21=
FILENAME22=

FILENAME30=
FILENAME31=
FILENAME32=

FILENAME40=
FILENAME41=
FILENAME42=
FILENAME43=

FILENAME50=
FILENAME51=
FILENAME52=

  _TITLE_=iconswitcher
_VERSION_=1.0omega
_COMMENT_="GTKdialog GUI to select icon theme in /usr/local/lib/X11/themes/ ."

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
 set +e
 source /etc/rc.d/f4puppy5 && {
 set +n
 source /etc/rc.d/f4puppy5; } || echo "WARNING : Could not source /etc/rc.d/f4puyppy5 ."

ADD_PARAMETER_LIST=
ADD_PARAMETERS=
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
for i in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
} || echo "Warning : No /etc/rc.d/f4puppy5 installed."

#  <text><label>\"${CHARPAD}\"</label></text>

tmpDIR=/tmp/icon_switcher
rm -rf "$tmpDIR"
mkdir -p "$tmpDIR"

ICONSETSGUI=""
for oneDIR in `find /usr/local/lib/X11/themes/ -mindepth 1 -maxdepth 1 -type d `
do
 #ONENAME="`basename $ONEDIR`"
 oneNAME="${oneDIR##*/}"
 [ -f $oneDIR/folder.svg ] && rsvg-convert -w 48 -h 48 -o "$tmpDIR"/pis-${NAME}-folder.png $oneDIR/folder.svg
 [ -f $oneDIR/folder48.png ] && cp -f $oneDIR/folder48.png "$tmpDIR"/pis-${oneNAME}-folder.png
 [ -f $oneDIR/www.svg ] && rsvg-convert -w 48 -h 48 -o "$tmpDIR"/pis-${oneNAME}-www.png $oneDIR/www.svg
 [ -f $oneDIR/www48.png ] && cp -f $oneDIR/www48.png "$tmpDIR"/pis-${oneNAME}-www.png
 [ -f $oneDIR/word.svg ] && rsvg-convert -w 48 -h 48 -o "$tmpDIR"/pis-${oneNAME}-word.png $oneDIR/word.svg
 [ -f $oneDIR/word48.png ] && cp -f $oneDIR/word48.png "$tmpDIR"/pis-${oneNAME}-word.png
 [ -f $oneDIR/spread.svg ] && rsvg-convert -w 48 -h 48 -o "$tmpDIR"/pis-${oneNAME}-spread.png $oneDIR/spread.svg
 [ -f $oneDIR/spread48.png ] && cp -f $oneDIR/spread48.png "$tmpDIR"/pis-${oneNAME}-spread.png
 ICONSETSGUI="$ICONSETSGUI
 <hbox>
  <pixmap><input file>$tmpDIR/pis-${oneNAME}-folder.png</input></pixmap>
  <pixmap><input file>$tmpDIR/pis-${oneNAME}-www.png</input></pixmap>
  <pixmap><input file>$tmpDIR/pis-${oneNAME}-word.png</input></pixmap>
  <pixmap><input file>$tmpDIR/pis-${oneNAME}-spread.png</input></pixmap>
  <vbox>
   <pixmap><input file>/usr/local/lib/X11/pixmaps/invisible96x8.png</input></pixmap>
   <button><label>${oneNAME}</label></button>
  </vbox>
 </hbox>
"

done

export ICONSWITCHGUI="
<window title=\"Puppy Icon Switcher\" icon-name=\"gtk-convert\">
 <vbox>
  <text><label>Choose the icon-set for desktop and menu</label></text>

  ${ICONSETSGUI}

  <hbox>
   <button><input file stock=\"gtk-quit\"></input><label>QUIT</label></button>
  </hbox>
 </vbox>
</window>"

echo "$ICONSWITCHGUI" > "$tmpDIR"/iconswitchgui
#echo "$ICONSWITCHGUI" | gtkdialog3 --stdin
RETSTUFF="`gtkdialog3 --program=ICONSWITCHGUI`"

eval "$RETSTUFF"

NEWTHEME="$EXIT"
#[ "`echo "$EXIT" | grep 'theme$'`" != "" ] && NEWTHEME="`echo "$EXIT" | head -n 1`"
[ "$NEWTHEME" = "" ] && exit
[ ! -d /usr/local/lib/X11/themes/${NEWTHEME} ] && exit

if [ "$NEWTHEME" != "" ];then
 for oneSVG in `find /usr/local/lib/X11/themes/${NEWTHEME}/ -maxdepth 1 -type f -name \*.svg`
 do
  oneBASENAME="`basename $oneSVG .svg`"
  rm -f /usr/local/lib/X11/pixmaps/${oneBASENAME}48.png
  rsvg-convert -w 48 -h 48 -o /usr/local/lib/X11/pixmaps/${oneBASENAME}48.png $oneSVG
  rm -f /usr/local/lib/X11/pixmaps/${oneBASENAME}24.png
  #rsvg-convert -w 24 -h 24 -o "$tmpDIR"/${oneBASENAME}24.png $oneSVG
  ##if svg has transparency, JWM does not render properly in x16 bit color, screen out...
  #pngtopnm -mix "$tmpDIR"/${oneBASENAME}24.png | pnmtopng > /usr/local/lib/X11/pixmaps/${oneBASENAME}24.png
  rsvg-convert -w 24 -h 24 -o /usr/local/lib/X11/pixmaps/${oneBASENAME}24.png $oneSVG
 done

 for onePNG in `find /usr/local/lib/X11/themes/${NEWTHEME}/ -maxdepth 1 -type f -name \*.png`
 do
  oneBASENAME=`basename $onePNG .png`
  cp -f $onePNG /usr/local/lib/X11/pixmaps/
  touch -m /usr/local/lib/X11/pixmaps/${oneBASENAME}.png #v3.98
  xoneBASENAME=`basename $oneBASENAME 48`
  if [ "$xoneBASENAME" != "$oneBASENAME" ];then #scale to 24 pixels...
   pngtopnm -alpha $onePNG > "$tmpDIR"/temp.pbm #separate transparency channel.
   pnmscale -reduce 2 "$tmpDIR"/temp.pbm > "$tmpDIR"/temp2.pbm 2>$ERR
   pngtopnm $onePNG | pnmscale -reduce 2 2>$ERR | pnmtopng -alpha="$tmpDIR"/temp2.pbm > /usr/local/lib/X11/pixmaps/${xoneBASENAME}24.png
   touch -m /usr/local/lib/X11/pixmaps/${xoneBASENAME}24.png #v3.98
  fi
 done

__old_endgui__(){
export ENDGUI="
<window title=\"Puppy Icon Switcher\" icon-name=\"gtk-convert\">
 <vbox>
  <text><label>\"You have chosen the '${NEWTHEME}' theme.
These are icons for the desktop and top-level of menu.
However, you need to restart X to see the change
(see 'Restart X server' in 'Shutdown' menu)\"</label></text>
  <hbox>
   <button><input file stock=\"gtk-quit\"></input><label>OK</label></button>
  </hbox>
 </vbox>
</window>
"
 gtkdialog3 --program=ENDGUI
}

 #v4.00 HairyWill restart rox and jwm immediately...
 export ENDGUI="
<window title=\"Puppy Icon Switcher\" icon-name=\"gtk-convert\">
 <vbox>
  <text><label>\"You have chosen the '${NEWTHEME}' theme.
These are icons for the desktop and top-level of menu.
Click OK button and you will see them...\"</label></text>
  <hbox>
   <button><input file stock=\"gtk-quit\"></input><label>OK</label></button>
  </hbox>
 </vbox>
</window>"
 gtkdialog3 --program=ENDGUI

 yaf-splash -bg orange -text "Please wait..." &
 yPID=$!
 #w477 record current theme...
 echo "$NEWTHEME" > /etc/desktop_icon_theme
 fixmenus #100411
 jwm -restart
 sleep 2
 rox -p=$HOME/Choices/ROX-Filer/PuppyPin
 kill $yPID 2>$ERR

fi


###END###
