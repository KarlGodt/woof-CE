#!/bin/sh
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_tgz2pet"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/bin/tgz2pet"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || . /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#

#convert a .tar.gz file to .pet...
#passed param is file to be converted.
#this works for md5sum returning 8-bit characters!

sync
TARBALL=$1
#chmod +w $TARBALL #make it writable.
chmod 644 $TARBALL #make it writable.

#only accept .tgz or .tar.gz files...
EXT=''
[ ! "`echo -n "$TARBALL" | grep '\\.tar\\.gz$'`" = "" ] && EXT='.tar.gz'
[ ! "`echo -n "$TARBALL" | grep '\\.tgz$'`" = "" ] && EXT='.tgz'
[ "$EXT" = "" ] && exit 1

#split TARBALL path/filename into components...
BASEPKG="`basename $TARBALL $EXT`"
DIRPKG="`dirname $TARBALL`"
[ "$DIRPKG" = "/" ] && DIRPKG=""

#perhaps makes following code easier if do this...
if [ "$EXT" = ".tgz" ];then
 mv $VERB -f $TARBALL $DIRPKG/${BASEPKG}.tar.gz
 TARBALL="$DIRPKG/${BASEPKG}.tar.gz"
 EXT='.tar.gz'
fi

#if tarball expands direct to '/' want to wrap around it (slackware pkg)... 100628 add -z ...
if [ "`tar -z --list -f $TARBALL | head -n 1`" = "./" ];then
# [ -d $DIRPKG/$BASEPKG ] && rm $VERB -rf $DIRPKG/$BASEPKG #a bit radical
 [ -d $DIRPKG/$BASEPKG ] && exit 1
 mkdir $VERB $DIRPKG/$BASEPKG
 mv $VERB $DIRPKG/${BASEPKG}.tar.gz $DIRPKG/$BASEPKG/
 #can put other files in here if want...
 
 tar $VERB --remove-files -c -f $DIRPKG/${BASEPKG}.tar $DIRPKG/$BASEPKG/
 gzip $DIRPKG/${BASEPKG}.tar
 rmdir $VERB $DIRPKG/$BASEPKG
fi

FULLSIZE="`stat --format=%s ${TARBALL}`"
MD5SUM="`md5sum $TARBALL | cut -f 1 -d ' '`"
echo -n "$MD5SUM" >> $TARBALL
sync
#NEWNAME="`echo -n "${TARBALL}" | sed -e 's/\\.tar\\.gz$/\\.pet/g'`"
#mv -f $TARBALL $NEWNAME
mv -f $TARBALL $DIRPKG/${BASEPKG}.pet
sync

###END###
