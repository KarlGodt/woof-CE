#!/bin/ash

DEBUG=1
#
# New header by Karl Reimer Godt, September 2014
  _TITLE_="Puppy_pupzip"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="/usr/local/bin/pupzip"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
[ "$HAVE_F4PUPPY5" ] || . /etc/rc.d/f4puppy5

ADD_PARAMETER_LIST=""
ADD_PARAMETERS=""
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
  for oneSHIFT in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap

}
# End new header
#
#Barry Kauler 2005 www.puppylinux.com
# Frontend for XArchive.
# Well, I want this to be a universal archiver frontend for puppy.
#v4.00 25apr2008 BK: now have full dpkg-deb in Puppy.
#w474 support .delta, .bfe files.

__old_header__(){
#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************
}

PARAM="$@"
PARAM=`echo "${PARAM}" | sed 's%^ *%%;s% *$%%'`
echo "PARAM='$PARAM'"
CDIR=`pwd`
echo "CDIR='$CDIR'"
#note, do not cd to directory this app is located in.

#w474
if [ "`echo -n "$1" | grep '\.delta$'`" ];then
 [ "$VERBOSE" ] && echo XDELTA
 exec xdelta_gui "$1"
elif [ "`echo -n "$1" | grep '\.bfe$'`" ];then
 [ "$VERBOSE" ] && echo BCRYPT
 exec bcrypt_gui "$1"
fi

#v2.11 G2 has suggested this...
if [ "`echo "$1" | grep -i '\.gz$'`" != "" ];then
[ "$VERBOSE" ] && echo 'GZ'
   if [ "`echo "$1" | grep -i '\.tar\.gz$'`" = "" ];then
   echo 'NO TARGZ'
      ##xmessage -buttons "Yes,No" -nearmouse "Do you want to decompress $1 ?
        xmessage -buttons "Yes,No" "Do you want to decompress
$1 ?
"
[ $? -eq 101 ] || exit  #first button returns 101, second 102
      cp $VERB "$1" "${1%/*}"/tmp-"${1##*/}"
      gunzip $VERB "$1"
      sync
      mv $VERB "${1%/*}"/tmp-"${1##*/}" "$1"
      exit
   fi


#also this...
elif [ "`echo "$1" | grep -i '\.bz2$'`" != "" ] ;then
[ "$VERBOSE" ] && echo 'BZ2'
   if [ "`echo "$1" | grep -i '\.tar\.bz2$'`" = "" ] ;then
   echo 'NO TARBZ2'
      xmessage -buttons "Yes,No" -nearmouse "Do you want to decompress
$1 ?
"
[ $? -eq 101 ] || exit  #first button returns 101, second 102
      cp $VERB "$1" "${1%/*}"/tmp-"${1##*/}"
      xmessage "Uncompressing, please wait..." & UPID=$!
      bunzip2 $VERB "$1"
      sync
      /bin/ps -p $UPID && kill $UPID
      mv $VERB "${1%/*}"/tmp-"${1##*/}" "$1"
      exit
   fi
fi


#in order of preference...
if [ "`which xarchive`" != "" ];then
 echo "XARCHIVE PROGRAM IS INSTALLED"
 XARCHIVE="xarchive"
elif [ "`which TkZip`" != "" ]; then
  XARCHIVE="TkZip"
elif [ "`which guitar`" != "" ];then
   XARCHIVE="guitar"
else
   exec xmessage -bg "orange red" -center -title "PupZip: ERROR" "No archive GUI program found.
Please install XArchive."
fi

#the full alternatives, dotpups by GuestToo...
DPKGDEB="dpkg-deb"
[ "`which dpkg-deb2`" != "" ] && DPKGDEB="dpkg-deb2"
#RPM2CPIO="rpm2cpio2"  ##BUG
#1.0.7a: xarchive - gz, rpm, deb by GuestToo Puppy Master Mon 12 Dec 2005, 03:42
#http://208.109.22.214/puppy/viewtopic.php?t=4577&sid=1a697fb27e2f9301f269eaf64da53d8b
RPM2CPIO="rpm2cpio"
[ "`which rpm2cpio2`" != "" ] && RPM2CPIO="rpm2cpio2"

if [ "$PARAM" = "" ];then
echo "$PARAM is EMPTY ; starting now XARCHIVE ..."
 #just start xarchive...
 exec $XARCHIVE
fi

if [ "$XARCHIVE" = "xarchive" ];then
 MSGE="Drag and drop invocation of XArchive is achieved by dragging any file or
directory the \"pupzip\" icon on the desktop. If you drag one of the
recognised archived files, such as .tar.gz, .rpm, .deb, .zip, .tar.bz2,
it will open in XArchive and you will be given the opportunity to extract
it. If you drag an ordinary file to the desktop icon, such as for example
\"myfile.txt\", a XArchive will popup a dialog asking if you want to add
it to an existing archive or create a new one."
else
 MSGE="There is support for drag-and-drop of archive files to the desktop icon,
however not for files and directories -- for that you need to have
XArchiver installed, the preferred archiver program for Puppy."
fi

if [ "$PARAM" = "--help" ];then
 xmessage -bg "orange" -center -title "PupZip: help" "
This is a frontend to $XARCHIVE, which in turn is a frontend to the
archiver utilities in Puppy (such as gzip, bzip2, dpkg, rpm, zip).

Note: $XARCHIVE can be started in the conventional way via the menu.

$MSGE

PupZip can also be invoked from Rox by the \"Open With...\" menu,
by right-clicking on a file or directory."
 exit
fi


ARCHIVEFILE=`echo -n "$PARAM" | grep -i -E '\.tar|\.bz|\.gz|\.rpm|\.deb|\.zip|\.tgz|\.tbz' | grep -v '\\\.'`
[ "$DEBUG" ] && echo 'ARCHIVEFILE='"$ARCHIVEFILE"

if [ "$ARCHIVEFILE" != "" ]; then
 #it is an archive file...

 #get absolute path of file...
 if [ "`echo -n "$PARAM" | cut -b 1`" = "/" ];then  ##11
  FULLSPEC="$PARAM"
 else
  #relative path...
  if [ "$CDIR" = "/" ];then  ##111
   FULLSPEC="/$PARAM"
  else
   FULLSPEC="$CDIR/$PARAM"
  fi
 fi ##11
 [ "$DEBUG" ] && echo 'FULLSPEC='"$FULLSPEC"

 #busybox applets are not adequate for handling rpm, deb...
 aFILE=`basename "$PARAM"`
 echo "aFILE='$aFILE'"
 if [ "`echo -n "$aFILE" | grep '\.'`" = "" ];then  ##11
  #file has no extension, so treat as ordinary file...
    if [ "$XARCHIVE" = "xarchive" ]; then  ##111
     exec xarchive --add=ask "$PARAM"
    else
     exec xmessage -bg "orange red" -center -title "PupZip: ERROR" "Not an archive file"
    fi
 else  ##11
  taEXT="$aFILE"
  [ "$DEBUG" ] && echo "taEXT='$taEXT'"
  #while [ "`echo -n "$aEXT" | grep '\.'`" != "" ]; do
  while :; do
   taEXT=${taEXT#*.}
   test "$aEXT" = "$taEXT" && break
   aEXT="$taEXT"
   sleep 0.1
  done
 fi  ##11

 #drops here with aEXT=extension.
 case $aEXT in
  rpm|RPM)

   # REM: Simple way
   #mkdir /tmp/temprpm
   #cd /tmp/temprpm

   # REM: use filename for pkg.tar
   fileBASE=`basename "$aFILE" .$aEXT`
   [ "$DEBUG" ] && echo "fileBASE='$fileBASE'"

   mkdir $VERB -p /tmp/"$fileBASE"
   cd /tmp/"$fileBASE"

   $RPM2CPIO "$FULLSPEC" | cpio $VERB -d -i -m
   if [ ! $? -eq 0 ];then
    exec xmessage -bg "orange red" -center -title "PupZip: ERROR" "An error has occurred opening the RPM file.
Suggestion: install unrpm.pup DotPup package, which contains an alternative
RPM extraction program, that PupZip will automatically use if present."
   fi
   sync

   #tar -c -f /tmp/temprpm.tar .
   #rm -rf /tmp/temprpm

   # REM : Above extracted .rpm into directory
   #       Now creating a tar archive of that directory
   tar $VERB -c -f /tmp/"$fileBASE".tar .
   [ "$DEBUG" ] || rm -rf /tmp/"$fileBASE"

   cd /

   #$XARCHIVE /tmp/temprpm.tar
   #rm -f /tmp/temprpm.tar

   $XARCHIVE /tmp/"$fileBASE".tar
   [ "$DEBUG" ] || rm -f /tmp/"$fileBASE".tar

   cd $CDIR
   exit
   ;;

   *)
__unpack_debian__(){
#v4.00 remove...
  case $* in
  deb|DEB)
   mkdir $VERB -p /tmp/temprpm
   cd /tmp/temprpm
   $DPKGDEB -x "$FULLSPEC"
   if [ ! $? -eq 0 ];then
    exec xmessage -bg "orange red" -center -title "PupZip: ERROR" "An error has occurred opening the DEB file."
   fi
   tar $VERB -c -f /tmp/temprpm.tar .
   [ "$DEBUG" ] || rm -rf /tmp/temprpm
   cd /
   $XARCHIVE /tmp/temprpm.tar
   [ "$DEBUG" ] || rm -f /tmp/temprpm.tar
   cd $CDIR
   exit
   ;;
   esac
}
   ;;

 esac

 set - $PARAM
 echo "NOW ABOUT TO EXEC XARCHIVER '$XARCHIVE' \"$@\""

 #LANG=C;LC_ALL=C
 #export LANG=C
 #export LC_ALL=C
 #locale

 exec $XARCHIVE "$@"
elif [ "$XARCHIVE" = "xarchive" ]; then
  set - $PARAM
  echo  "Now about starting xarchive --add=ask \"$@\""
  exec xarchive --add=ask "$@"
else
  exec xmessage -bg 'orange red' -center -title 'PupZip: ERROR' 'Not an archive file ..!?..'

fi

###END###
