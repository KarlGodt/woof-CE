#!/bin/bash
#BK nov 2007 gui frontend for dict.
# 2010-05-26 ecube: refurbishing

FILENAME0=

FILENAME10=
FILENAME11=
FILENAME12=

FILENAME20=
FILENAME21=
FILENAME22=

FILENAME30=
FILENAME31=
FILENAME32=

FILENAME40=
FILENAME41=
FILENAME42=
FILENAME43=

FILENAME50=
FILENAME51=
FILENAME52=

  _TITLE_="Puppy_pdict"
_VERSION_=1.0omega
_COMMENT_="$_TITLE_:Puppy Linux shell script [to TODO here]"

MY_SELF="$0"
MY_PID=$$

test -f /etc/rc.d/f4puppy5 && {
 set +e
 . /etc/rc.d/f4puppy5 && {
 set +n
 . /etc/rc.d/f4puppy5; } || echo "WARNING : Could not source /etc/rc.d/f4puyppy5 ."

ADD_PARAMETER_LIST=
ADD_PARAMETERS=
_provide_basic_parameters

TWO_HELP=''; TWO_VERSION=''; TWO_VERBOSE=''; TWO_DEBUG=''; ## Set to anything if code requires further down (ie. custom usage or version message)
ADD_HELP_MSG="$_COMMENT_"
_parse_basic_parameters "$@"
[ "$DO_SHIFT" ] && [ ! "${DO_SHIFT//[[:digit:]]/}" ] && {
for i in `seq 1 1 $DO_SHIFT`; do shift; done; }

_trap
} || echo "Warning : No /etc/rc.d/f4puppy5 installed."


[ "`which dict`" ] || {
    xmessage -bg red "$(gettext 'Sorry, no "dict" found in PATH .
Please install "dict" binary.
Aborting.')"
 exit 1
}

tmpDIR=/tmp/pdict
mkdir -p "$tmpDIR"

WIDTH=550; HEIGHT=700

echo -n "" > /tmp/pdict-results.txt

# Use local dicod server if it is running and no internet connection available
if ! [ "`ifconfig | grep -E '^wlan|^eth|^ppp'`" ]; then
 if _pidof $Q dicod; then
  hostP=-h
  hostURL=127.0.0.1
  portP=-p
  hostPORT=2628      #default 2628, see /etc/dicod.conf if changed
 fi
fi

VERB=-v
DICTLIST=`dict $VERB $hostP $hostURL -p $hostPORT --dbs`
DEBUG=1
_debug "DICTLIST='$DICTLIST'"

if ! [ "$DICTLIST" ]; then
 xmessage -bg red -title "${0##*/}" "WARNING: Could not receive any databases"
fi


__home_dict_dbs(){
if [ "`ls $HOME/.dict_dbs`" = "" ]; then
#  `dict --dbs > $HOME/.dict_dbs`
    dict --dbs > $HOME/.dict_dbs
fi

DICTLIST="`cat $HOME/.dict_dbs`"
}


COMBOCONTENT="`echo "$DICTLIST" | grep -v '^Databases available:' | sed -e 's/^/<item>/' | sed -e 's/$/<\/item>/'`"


if [ "$hostURL" = '127.0.0.1' ]; then
 _debug "hostURL='$hostURL' (127.0.0.1)"
else
 _debug "hostURL='$hostURL' (else)"
 COMBOCONTENT="<item>all        Search all databases</item>
 ${COMBOCONTENT}"
fi

true

echo '#/bin/sh' > "$tmpDIR"/pdict-func1
echo "dict $VERB $hostP $hostURL $portP $hostPORT \\
 -d \$2 \$1 >$tmpDIR/pdict-results.txt 2>&1

echo                          >>$tmpDIR/pdict.log
echo \"Lookup for    :\$1\"   >>$tmpDIR/pdict.log
echo \"dict database :\$2\"   >>$tmpDIR/pdict.log
cat $tmpDIR/pdict-results.txt >>$tmpDIR/pdict.log
"  >> "$tmpDIR"/pdict-func1
chmod $VERB 0755 "$tmpDIR"/pdict-func1



export MAIN_DIALOG="
<window title=\"Pdict dictionary and thesaurus\" icon-name=\"gtk-info\">
 <vbox>
  <hbox>
   <button>
    <label>config</label>
<action type=\"execute\"> Xdialog --title \"DICT databases\" --msgbox \"Initialize the list of databases by deleting the hidden file $HOME/.dict_dbs.\" 5 70</action>
    <action type=\"execute\">/usr/local/bin/defaulttexteditor $HOME/.dict_dbs</action>
    <action type=\"execute\">yaf-splash  -timeout 5 -font \"9x15B\" -outline 0 -margin 4 -bg cyan -text \"Restart pdict to activate the configuration\" &</action>
   </button>

   <entry activates-default=\"true\">
    <variable>WORD</variable>
   </entry>
   <text><label>enter a word:</label></text>

   <button>
    <label>dict</label>
    <action>dict -d \"\${DB%  *}\" \"\$WORD\" &>/tmp/pdict-results.txt</action>
    <action>refresh:INFO</action>
   </button>

  </hbox>
  <text><label>Choose which online database:</label></text>
  <combobox>
   <variable>DB</variable>
    $COMBOCONTENT
  </combobox>
  <frame result:>
   <edit>
    <variable>INFO</variable>
    <input file>/tmp/pdict-results.txt</input>
    <width>$WIDTH</width>
    <height>$HEIGHT</height>
   </edit>
  </frame>
  <hbox>
   <button>
    <label>exit</label>
    <input file stock=\"gtk-quit\"></input>
    <action type=\"exit\">EXIT</action>
   </button>
  </hbox>
 </vbox>
</window>
"
gtkdialog3 --program=MAIN_DIALOG
# Very End of this file 'usr/sbin/pdict' #
###END###
