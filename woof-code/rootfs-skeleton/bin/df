#!/bin/ash
#(c) Barry Kauler 2009, licence GPL2
#w482 fix for /dev/root.

test -f /etc/rc.d/f4puppy5 && . /etc/rc.d/f4puppy5
# BATCHMARKER01 - Marker for Line-Position to bulk insert code into.

DF="busybox df"
[ "`which df-FULL`" ] && DF="df-FULL"
_debug 'DF='"$DF"
_debug '$@='"$@"

#150420: df only works on entries in /proc/mounts
test -e /proc/mounts || busybox mount -t proc proc /proc >&2

_get_retstuff(){
RETSTUFF="`$DF $@`"
RETVAL=$?

_debug 'RETSTUFF='"$RETSTUFF"
_debug 'RETVAL='"$RETVAL"

__hack_what__(){
#hack to remove two conflicting entries mounted on / ...
if [ "`echo "$RETSTUFF" | grep '^rootfs '`" != "" ];then
 if [ "`echo "$RETSTUFF" | grep '^/dev/root '`" != "" ];then
  RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"
 fi
fi
}

RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"
}

#150420 Slacko64: manpage of rdev claims rdev only works on i386 arch ,
# but df-FULL now shows real root device when root=/dev/sdaX sdaX is mounted on another mountpoint once temporarily

_force_root_mount(){
    tMNTPT=$((RANDOM));
    mkdir $VERB "/etc/$tMNTPT" || return 1
    mount-FULL $VERB $ROOTD "/etc/$tMNTPT" || { rmdir $VERB "/etc/$tMNTPT"; return 2; }
    ( sleep 1 && busybox umount -lr "/etc/$tMNTPT"
    sleep 1 && rmdir $VERB "/etc/$tMNTPT" ) #&
}

case $(uname -m) in
i[0-9]86)
_get_retstuff "$@"
_i386_real_rootdevice(){
#replace /dev/root with correct root partition...
#rdev is a busybox applet...
ROOTPARTITION="`rdev | grep ' /$' | cut -f 1 -d ' ' | grep -E '/dev/sd|/dev/hd|/dev/mmc'`"
nPATTERN="s%^/dev/root %${ROOTPARTITION} %"
[ "$ROOTPARTITION" ] && RETSTUFF="`echo "$RETSTUFF" | sed -e "$nPATTERN"`"
}
_i386_real_rootdevice
;;
*_64)

ROOTD=`grep -o 'root=[^[:blank:]]\+' /proc/cmdline | cut -f2- -d'='`
if test -b "$ROOTD"; then
grep $Q "^$ROOTD " /proc/mounts >&2 || _force_root_mount >&2
else true
fi
_get_retstuff "$@"
;;
esac

echo "$RETSTUFF"
exit $RETVAL

###END###
