#!/bin/sh
#(c) Barry Kauler 2009, licence GPL2
#w482 fix for /dev/root.

echo "QUOTE_IT_M='$QUOTE_IT_M'"
echo "D_QUOTE_IT_M='$D_QUOTE_IT_M'"

QUOTE_IT=`echo "$@" | grep -w '\-q'`
D_QUOTE_IT=`echo "$@" | grep -w '\-Q'`
PARAMS=${@//\-q/}
PARAMS=${PARAMS//\-Q/}
echo "PARAMS='$PARAMS'"
if [ "$QUOTE_IT" ];then
QUOTE_IT_M=-q exec $0 $PARAMS
elif [ "$D_QUOTE_IT" ];then
D_QUOTE_IT_M=-Q exec $0 $PARAMS
fi

DF="busybox df"
[ "`which df-FULL`" != "" ] && DF="df-FULL"
#echo 'DF='"$DF"
#echo '$@='"$@"
RETSTUFF="`$DF $@`"
RETVAL=$?
#if [ "`echo "$@" | grep ' \-q '`" ];then
if [ "$QUOTE_IT_M" ];then
RETSTUFF=`echo "$RETSTUFF" |sed -r "s|(.*%) (/.*)|\1 '\2'|"`
#elif [ "`echo "$@" | grep ' \-Q '`" ];then
elif [ "$D_QUOTE_IT_M" ];then
RETSTUFF=`echo "$RETSTUFF" |sed -r 's|(.*%) (/.*)|\1 "\2"|'`
fi
#echo 'RETSTUFF='"$RETSTUFF"
#echo 'RETVAL='"$RETVAL"
#echo

#hack to remove two conflicting entries mounted on / ...
#if [ "`echo "$RETSTUFF" | grep '^rootfs '`" != "" ];then
# if [ "`echo "$RETSTUFF" | grep '^/dev/root '`" != "" ];then
#  RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"
# fi
#fi

RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"

#replace /dev/root with correct root partition...
#rdev is a busybox applet...
ROOTPARTITION="`rdev | grep ' /$' | cut -f 1 -d ' ' | grep -E '/dev/sd|/dev/hd|/dev/mmc'`"
nPATTERN="s%^/dev/root %${ROOTPARTITION} %"
[ "$ROOTPARTITION" ] && RETSTUFF="`echo "$RETSTUFF" | sed -e "$nPATTERN"`"

echo "$RETSTUFF"
exit $RETVAL

###END###
