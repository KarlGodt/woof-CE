#!/bin/sh
#(c) Barry Kauler 2009, licence GPL2
#w482 fix for /dev/root.

#exec 1>>/tmp/df.log 2>&1
if test "$DEBUG"; then
echo "
##$0 :" >&2
fi

DF="busybox df"
[ "`which df-FULL`" != "" ] && { DF="df-FULL" ; [ -L /etc/mtab ] || ln -sf /proc/mounts /etc/mtab ; }

if test "$DEBUG"; then
echo "#applying `which $DF`" >&2
fi

RETSTUFF="`$DF $@`"
RETVAL=$?

if test "$DEBUG"; then
RETSTUFF0=`echo "$RETSTUFF" |sed 's+^+#+g'`
echo "$RETSTUFF0
##NOW Puppy df:" >&2
fi

#hack to remove two conflicting entries mounted on / ...
#if [ "`echo "$RETSTUFF" | grep '^rootfs '`" != "" ];then
# if [ "`echo "$RETSTUFF" | grep '^/dev/root '`" != "" ];then
#  RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"
# fi
#fi
RETSTUFF="`echo "$RETSTUFF" | grep -v '^rootfs '`"

#replace /dev/root with correct root partition...
#rdev is a busybox applet...
ROOTPARTITION="`rdev | grep ' /$' | cut -f 1 -d ' ' | grep -E '/dev/sd|/dev/hd|/dev/mmc'`"
nPATTERN="s%^/dev/root %${ROOTPARTITION} %"
[ "$ROOTPARTITION" ] && RETSTUFF="`echo "$RETSTUFF" | sed -e "$nPATTERN"`"

echo "$RETSTUFF" >&1
exit $RETVAL

###END###
