#!/bin/sh
#(c) Barry Kauler 2009, licence GPL2
#w482 fix for /dev/root.

#************
#KRG

OUT=/dev/null;ERR=$OUT
[ "$DEBUG" ] && { OUT=/dev/stdout;ERR=/dev/stderr; }
[ "$DEBUG" = 2 ] && set -x

Version=1.1-KRG-MacPup_O2

usage(){
MSG="
$0 [ help | version ]
"
echo "$MSG
$2"
exit $1
}
[ "`echo "$1" | grep -Ei "help|\-h"`" ] && usage 0
[ "`echo "$1" | grep -Ei "version|\-V"`" ] && { echo "$0: $Version";exit 0; }

trap "exit" HUP INT QUIT ABRT KILL TERM

#KRG
#************


DF="busybox df"
[ "`which df-FULL`" != "" ] && DF="df-FULL"

RETSTUFF=`$DF $@`
RETVAL=$?

#hack to remove two conflicting entries mounted on / ...
#if [ "`echo "$RETSTUFF" | grep '^rootfs '`" != "" ];then
# if [ "`echo "$RETSTUFF" | grep '^/dev/root '`" != "" ];then
#  RETSTUFF=`echo "$RETSTUFF" | grep -v '^rootfs '`
# fi
#fi
RETSTUFF=`echo "$RETSTUFF" | grep -v '^rootfs '`

#replace /dev/root with correct root partition...
#rdev is a busybox applet...
ROOTPARTITION=`$(which rdev) | grep ' /$' | cut -f 1 -d ' ' | grep -E '/dev/sd|/dev/hd|/dev/mmc'`
[ "$DEBUG" ] && echo "ROOTPARTITION='${ROOTPARTITION##*/}'"

if [ -e /sys/class/block/${ROOTPARTITION##*/} ];then

:

else

MAJh=`stat -c %t $ROOTPARTITION`
MAJd=$(( 16#$MAJh ))
MINh=`stat -c %T $ROOTPARTITION`
MINd=$(( 16#$MINh ))
POSSIBLE=`LANG=C ls -l /dev |awk '{print $5" "$6" "$10}' |grep "${MAJd}, ${MINd}" |awk '{print $3}'`
for p in $POSSIBLE;do
[ "$DEBUG" ] && echo "POSSIBLE='$p'"
[ -e /sys/class/block/$p ] && { ROOTPARTITION=/dev/$p ; break ; }
done

fi

nPATTERN="s%^/dev/root %${ROOTPARTITION} %"
[ "$ROOTPARTITION" ] && RETSTUFF=`echo "$RETSTUFF" | sed -e "$nPATTERN"`

echo "$RETSTUFF"
exit $RETVAL

###END###
