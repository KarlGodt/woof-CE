#!/bin/sh

exe=autom4te

#autom4te_exe=/usr/bin/autom4te-2.59
 autom4te_exe=/usr/bin/autom4te-2.67
#autom4te_exe=/usr/local/bin/autom4te-2.68

echo -e "\\033[1;36m""
############
# Wrapper  #
# Type \"$0 --wrapper=help\" #
# for info #
############
""\\033[0;39m" >&2

_usage(){
MSG="$0:
Wrapper for '$exe'

Usage :
$0 [--wrapper=option1,option2,..] [ $exe-options ]

Wrapper options are a comma separated list of

help  :to show this message
info  :lists installed $exe executables
menu  :interactively choose the $exe executable

verbose :emit some diagnostic messages
debug   :set -x
"
echo "$MSG"
exit $1
}

EXE_OPTIONS=`echo "$@" |tr ' ' '\n' |grep -v 'wrapper=.*' |tr '\n' ' '`
WRAPPER_OPTIONS=`echo "$@" |tr ' ' '\n' |grep 'wrapper=.*' |cut -f2 -d= |tr ',' ' '`
for opt in $WRAPPER_OPTIONS;do
case $opt in
help) _usage 0;;
info) sINFO=1;;
menu) MENU=1;;
debug) set -x;;
verbose) ME_VERBOSE=1;;
*)_usage 1;;
esac
done

if [ "$sINFO" ];then
echo "$0:
autom4te_exe='$autom4te_exe'"

file "$autom4te_exe"
echo

AUTOMAKEs=`type -a $exe`
AUTOMAKEs=`echo "$AUTOMAKEs" |awk '{print $3}'`
echo "$AUTOMAKEs"
echo
for m in $AUTOMAKEs;do
dir_name="${m%/*}"
find $dir_name -iname "$exe*" -exec file {} \;
echo
done

echo "
/usr/local/bin:
"

find /usr/local/bin -iname "$exe*" -exec file {} \;
exit $?
fi


if [ "$MENU" ];then

for dir in `echo $PATH |tr ":" " "`;do
AUTOMAKE_S="$AUTOMAKE_S
`find $dir -maxdepth 1 -type f -name "$exe[-_][0-9]*"`"
done
AUTOMAKE_S=`echo "$AUTOMAKE_S" |sort`
echo "Select the $exe executable :"
select AUTOMAKE_EXE in $AUTOMAKE_S;do echo $AUTOMAKE_EXE;break;done
[ "$AUTOMAKE_EXE" ] || { echo "Nothing available selected ";exit 0; }
[ -e $autom4te_exe -a ! -L $autom4te_exe ] && { echo "'$autom4te_exe' is not a link ";exit 1; }

prefix="${AUTOMAKE_EXE//\/bin*/}"
base_name="${AUTOMAKE_EXE##*/}"
VERSION="${AUTOMAKE_EXE##*\-}"
M_VERSION=`echo "$VERSION" |sed -r 's/([0-9]*)\.([0-9]*)\.([0-9]*)/\1\.\2/'`
echo "'$prefix' '$base_name' '$M_VERSION' '$VERSION'"

rm ${VERB:+'-v'} -f $autom4te_exe
if [ "$VERSION" != "$M_VERSION" ];then
rm ${VERB:+'-v'} ${autom4te_exe}-$M_VERSION
ln ${VERB:+'-v'} -s $AUTOMAKE_EXE ${autom4te_exe}-$M_VERSION
ln ${VERB:+'-v'} -s ${exe}-$M_VERSION $autom4te_exe
else
ln ${VERB:+'-v'} -s $AUTOMAKE_EXE $autom4te_exe
fi
touch $AUTOMAKE_EXE
[ "$ME_VERBOSE" ] && ls -l $autom4te_exe && ls -l ${autom4te_exe}-$M_VERSION

__out__(){
#sync aclocal
rm ${VERB:+'-v'} -f /usr/bin/aclocal
if [ "$VERSION" != "$M_VERSION" ];then
rm ${VERB:+'-v'} -f /usr/bin/aclocal-$M_VERSION
ln ${VERB:+'-v'} -s $prefix/bin/aclocal-$VERSION /usr/bin/aclocal-$M_VERSION
ln ${VERB:+'-v'} -s /usr/bin/aclocal-$M_VERSION /usr/bin/aclocal
else
ln ${VERB:+'-v'} -s $prefix/bin/aclocal-$VERSION /usr/bin/aclocal
fi
touch $prefix/bin/aclocal-$VERSION
[ "$ME_VERBOSE" ] && ls -l /usr/bin/aclocal && ls -l /usr/bin/aclocal-$M_VERSION
}

rm ${VERB:+'-v'} $prefix/share/$exe
if [ "$VERSION" != "$M_VERSION" ];then
rm ${VERB:+'-v'} $prefix/share/${exe}-$M_VERSION
ln ${VERB:+'-v'} -s $base_name $prefix/share/${exe}-$M_VERSION
ln ${VERB:+'-v'} -s ${exe}-$M_VERSION $prefix/share/$exe
RETURN_VAL=$?
else
ln ${VERB:+'-v'} -s $base_name $prefix/share/$exe
RETURN_VAL=$?
fi
[ "$ME_VERBOSE" ] && ls -l $prefix/share/$exe && ls -l $prefix/share/${exe}-$M_VERSION

[ $RETURN_VAL -eq 0 ] || exit $RETURN_VAL
fi

#automake: `configure.ac' or `configure.in' is required

[ -f configure.ac -o -f configure.in ] || exit 0

[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
(
echo
echo `date` "$@"
echo "$0 '$@'"
echo "$PWD:`pwd`"
) >>${exe}-errs.log

#$autom4te_exe $EXE_OPTIONS 2>>${exe}-errs.log
 $autom4te_exe "$@"         2>>${exe}-errs.log
RET_VAL=$?

if [ "$RET_VAL" -ne '0' ];then
echo -e "\\033[1;31m""ERROR : '$RET_VAL' for
$autom4te_exe '$@' '$EXE_OPTIONS' .
See ${exe}-errs.log for details
""\\033[0;39m" >&2
defaulttexteditor ${exe}-errs.log &
else
echo -e "\\033[1;32m""OK : $autom4te_exe '$EXE_OPTIONS' finished with '$RET_VAL'""\\033[0;39m" >&2
[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
fi
[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
exit $RET_VAL
