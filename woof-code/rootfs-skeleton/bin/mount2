#!/bin/bash --norc
# Karl Reimer Godt June 2013
# Thanks to L18L for testing and confirming that ntfs-3g could need a patch to
# ignore unused common Linux/GNU mount options

[ "$*" ] || exec busybox mount

[ "$DEBUG" ] || DEBUG=1
[ "$DEBUG" ] && echo "$0:$*" >&2
#/bin/mount:-i -f -t fuse.gphotofs -o rw,nosuid,nodev gphotofs /mntp/PTPdevice

. /etc/rc.d/f4puppy5

ARGS=`set | grep 'BASH_ARG'`
ARGV=`echo "$ARGS" | grep 'ARGV' | grep -o '\[.*"'`
[ "$DEBUG" ] && echo  "$ARGV"
ARGC=`echo "$ARGS" | grep 'ARGC' |cut -f2 -d'"'`
[ "$DEBUG" ] && echo $ARGC
c=$ARGC


# here document needs writable /tmp ...
# but /proc may be umounted ...
if test -e /proc/mounts; then
:
else
 _warn "/proc not mounted"
 _notice "Attempting to mount procfs .."
 test -e /proc && { busybox mount -t proc none /proc; RETVAL=$?; } || {
 _info "Attempting to remount rw of '/' to ensure it is writable .."
 busybox mount -o remount,rw /dev/root /
 mkdir /proc && { busybox mount -t proc none /proc; RETVAL=$?; } || {
 _err "Failed to mount procfs"
 }
}
fi

if test -f /proc/mounts; then
if cut -f2 -d' ' /proc/mounts | grep $Q '^/tmp$'; then
 _info "Attempting to remount rw /tmp to ensure it is writable .."
 busybox mount -o remount,rw tmpfs /tmp
else
 _info "Attempting to remount rw of '/' to ensure it is writable .."
 busybox mount -o remount,rw /dev/root /
fi
else
 _warn "/proc/mounts does not exist"
fi
[ "$RETVAL" = 0 ] && { NEED_PROC_MOUNT=YES; _notice "Had to mount /proc"; }
[ "$DEBUG" ] && echo RETVAL=$RETVAL

while read p
do
P[$c]="${p#*=}"
P[$c]="${P[$c]/#\"}"
P[$c]="${P[$c]/%\"}"
[ "${P[$c]}" = 'ntfs' ]  && P[$c]='ntfs-3g'
[ "${P[$c]}" = '/proc' ] && WANT_PROC_MOUNT=YES
# try to prevent overlaying mounts since eg a mount of /tmp
# on top of an older /tmp may prevent users of files in /tmp to work properly
if cut -f2 -d' ' /proc/mounts | grep $Q "^${P[$c]}$"; then
HAVE_OVERLAY_MOUNT=YES
fi
# but need to check remount , bind , move options
#case ${P[$c]} in *remount*|-R) WANT_REMOUNT=YES;;
#*move*|-M) WANT_MOVE=Y;; *bind*|-B) WANT_BIND=Y;; esac
case ${P[$c]} in *remount*) WANT_REMOUNT=YES;;
*move*) WANT_MOVE=Y;; *bind*) WANT_BIND=Y;; esac
(( c-- ))
done<<EOI
$(echo "$ARGV" | sed 's%" \[%"\n\[%g' )
EOI
[ "$DEBUG" ] && echo ${P[@]} >&2

if test "$WANT_REMOUNT"; then
 unset HAVE_OVERLAY_MOUNT WANT_PROC_MOUNT;
elif test "$WANT_MOVE" ; then
 unset HAVE_OVERLAY_MOUNT WANT_PROC_MOUNT;
elif test "$WANT_BIND"; then
 unset HAVE_OVERLAY_MOUNT WANT_PROC_MOUNT;
fi

if test "$HAVE_OVERLAY_MOUNT"; then
 test "$WANT_REMOUNT" -o "$WANT_MOVE" -o "$WANT_BIND" || { RETVAL=9
 if test "$NEED_PROC_MOUNT"; then
 _notice "Refusing to mount '$*' since already done."
 else
 _err "Refusing to mount '$*' since it is already mounted."
 _notice "Use -o remount , --bind , --move if needed."
 fi
exit $RETVAL; }
fi

[ "$DEBUG" ] && echo RETVAL=$RETVAL
[ $# = 1 -a -b "$1" ] &&
{
    mkdir $VERB -p /mnt/"${1##*/}"
    mount-FULL "$1" /mnt/"${1##*/}"
    RETVAL=$?
} ||
{
    for sp in ${P[@]}
    do
    case $sp in
    ntfs-3g) NTFSMOUNT=YES;;
    vfat) FATMOUNT=YES;CPAGE=437;IOCSET=iso8859-1
          IFS='.' read KM rest </etc/keymap || KM=us
          case $KM in
          de|be|br|dk|es|fi|fr|it|no|se|pt)         CPAGE=850 ;;
          slovene|croat|hu101|hu|cz-lat2|pl|ro_win) CPAGE=852 ; IOCSET=iso8859-2 ;;
          esac ;;
    esac
    done
}
[ "$DEBUG" ] && echo RETVAL=$RETVAL
[ "$RETVAL" ] ||
{
[ "$NTFSMOUNT" ] && {
    mount-FULL ${P[@]} && RETVAL=$? || {
    mount-FULL ${*} && { RETVAL=$? ; NTFSRO=YES ; } || RETVAL=$? ; } ; }

[ "$FATMOUNT" ]  && { mount-FULL ${P[@]} -o shortname=mixed,quiet,codepage=${CPAGE},iocharset=$IOCSET ; RETVAL=$? ; }
[ "$RETVAL" ]    || {  if test ! "$WANT_PROC_MOUNT" -a ! "$HAVE_OVERLAY_MOUNT"; then
                       [ "$DEBUG" ] && echo "Doing mount-FULL ${P[@]}" >&2;
                       mount-FULL ${P[@]} ; RETVAL=$? ; fi; }
}

[ "$DEBUG" ] && echo RETVAL=$RETVAL
[ "$DISPLAY" ]    || exit $RETVAL

[ "$RETVAL" = 0 ] || exit $RETVAL

[ "$NTFSRO" ] && xmessage -bg orange "NTFS mount
$0 $*
as
mount-FULL $[P{@]}
failed to mount read-write .
The kernel NTFS driver was used to mount
mount-FULL ${*} at least read-only ." &

[ "$DEBUG" ] && echo "Checking for desktop icons..."
. /etc/eventmanager
[ "$ICONDESK" = true ] || exit $RETVAL
[ "$ICONPARTITIONS" = true ] || exit $RETVAL

[ "$DEBUG" ] && echo "Checking for desktop icons..."
. /etc/rc.d/functions4puppy4

read device rest <<EOI
$(tail -n1 /proc/mounts)
EOI

case $device in /dev/*) :;; *) exit $RETVAL;; esac

DEVNAME=${device##*/}
 case  $DEVNAME in
 fd*)      DRV_CATEGORY=floppy ;;
 mmc*) DEVNAME=${DEVNAME%p*} ; DRV_CATEGORY=card ;;
 scd*|sr*) DRV_CATEGORY=cdrom;;
 esac
[ "$DRV_CATEGORY" ] || DRV_CATEGORY=`probedisk2 | grep -m1 "^${device:0:8}|" |cut -f2 -d'|'`

[ "$DRV_CATEGORY" ] && icon_mounted_func "$DEVNAME" "$DRV_CATEGORY"

[ -L /etc/mtab ] || ln -sf /proc/mounts /etc/mtab
exit $RETVAL

