#!/bin/sh

exe=m4
#mfour_exe=/usr/bin/m4
mfour_exe=/usr/bin/m4-1.4.10
#mfour_exe=/usr/bin/m4-1.4.14
#mfour_exe=/usr/bin/m4-1.4.14-upx
#mfour_exe=/usr/local/bin/m4-1.4.16


echo -e "\\033[1;36m""
############
# Wrapper  #
# Type \"$0 --wrapper=help\" #
# for info #
############
""\\033[0;39m" >&2

_usage(){
MSG="$0:
Wrapper for '$exe'

Usage :
$0 [--wrapper=option1,option2,..] [ $exe-options ]

Wrapper options are a comma separated list of

help  :to show this message
info  :lists installed $exe executables
menu  :interactively choose the $exe executable

verbose :emit some diagnostic messages
debug   :set -x
"
echo "$MSG"
exit $1
}

EXE_OPTIONS=`echo "$@" |tr ' ' '\n' |grep -v 'wrapper=.*' |tr '\n' ' '`
WRAPPER_OPTIONS=`echo "$@" |tr ' ' '\n' |grep 'wrapper=.*' |cut -f2 -d= |tr ',' ' '`
for opt in $WRAPPER_OPTIONS;do
case $opt in
help) _usage 0;;
info) INFO=1;;
menu) MENU=1;;
debug) set -x;;
verbose) ME_VERBOSE=1;;
*)_usage 1;;
esac
done


if [ "$INFO" ];then
echo "$0:
mfour_exe='$mfour_exe'"

file "$mfour_exe"
echo

MFOURs=`type -a $exe`
MFOURs=`echo "$MFOURs" |awk '{print $3}'`
echo "$MFOURs"
echo
for m in $MFOURs;do
dir_name="${m%/*}"
find $dir_name -iname "$exe*" -exec file {} \;
echo
done

echo "
/usr/local/bin:
"

find /usr/local/bin -iname "$exe*" -exec file {} \;
exit $?
fi


if [ "$MENU" ];then

for dir in `echo $PATH |tr ":" " "`;do
MFOUR_S="$MFOUR_S
`find $dir -maxdepth 1 -type f -name "$exe[-_][0-9]*"`"
done
MFOUR_S=`echo "$MFOUR_S" |sort`
echo "Select the $exe executable :"
select MFOUR_EXE in $MFOUR_S;do echo $MFOUR_EXE;break;done
[ "$MFOUR_EXE" ] || { echo "Nothing available selected ";exit 0; }
[ -e $mfour_exe -a ! -L $mfour_exe ] && { echo "'$mfour_exe' is not a link ";exit 1; }

prefix="${AUTOMAKE_EXE//\/bin*/}"
base_name="${AUTOMAKE_EXE##*/}"
VERSION="${AUTOMAKE_EXE##*\-}"
M_VERSION=`echo "$VERSION" |sed -r 's/([0-9]*)\.([0-9]*)\.([0-9]*)/\1\.\2/'`
echo "'$prefix' '$base_name' '$M_VERSION' '$VERSION'"

rm ${VERB:+'-v'} -f $mfour_exe
ln ${VERB:+'-v'} -s $MFOUR_EXE $mfour_exe
touch $MFOUR_EXE

[ "$ME_VERBOSE" ] && ls -l $mfour_exe

fi

[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
(
echo
echo `date` "$@"
echo "$0 '$@'"
echo "$PWD:`pwd`"
) >> ${exe}-errs.log

#$mfour_exe $EXE_OPTIONS 2>>${exe}-errs.log
 $mfour_exe "$@"         2>>${exe}-errs.log
RET_VAL=$?

if [ "$RET_VAL" -ne '0' ];then
echo -e "\\033[1;31m""ERROR : '$RET_VAL' for
$mfour_exe '$@' '$EXE_OPTIONS' .
See ${exe}-errs.log for details
""\\033[0;39m" >&2
defaulttexteditor ${exe}-errs.log &
else
echo -e "\\033[1;32m""OK : $mfour_exe '$EXE_OPTIONS' finished with '$RET_VAL'""\\033[0;39m" >&2
[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
fi
[ -s ${exe}-errs.log ] || rm ${VERB:+'-v'} -f ${exe}-errs.log
exit $RET_VAL
