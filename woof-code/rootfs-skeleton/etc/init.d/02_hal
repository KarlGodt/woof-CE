#!/bin/ash
# Start/stop/restart the hal daemon:
# slackware script, modified for woof/puppy dec 2008, BK.

# i have named this script x_hal so it starts after 'messagebus' (dbus) script.

PREFIX=/usr/local
#PIDFILE=/var/run/hald/hald.pid
PIDFILE=$PREFIX/var/run/hald/pid

hal_start() {
	#CUSTOM=' --retain-privileges --use-syslog --verbose=yes'
	#CUSTOM='--retain-privileges --verbose=yes'
    #CUSTOM='--drop-privileges --verbose=yes'
    #CUSTOM='--verbose=yes'
    #echo "Starting HAL daemon:  /usr/sbin/hald --daemon=yes $CUSTOM"
    #/usr/sbin/hald --daemon=yes $CUSTOM
    #/usr/sbin/hald --daemon=yes --verbose=yes --retain-privileges --use-syslog

	if ! ps aux |grep hald | grep -vE 'grep|man' ;then
    #CUSTOM='--retain-privileges --use-syslog'
    echo "Starting HAL daemon:  /usr/local/sbin/hald --daemon=yes $CUSTOM"
    /usr/local/sbin/hald --daemon=yes $CUSTOM
    else
    echo "Another instance of hald apparently running:"
    ps aux |grep hald | grep -vE 'grep|man'
    fi
    sleep 2
    PID=` pidof hald`
    if [ "$PID" ];then
    echo "Sucessfully started hald : '$PID'"
    else
    echo "Failed to start hald"
    fi
}

hal_stop() {
  if [ -e "$PIDFILE" ]; then
    kill $(cat $PIDFILE)
    rm -f $PIDFILE
  else
  echo "NO PID file '$PIDFILE'"
  PID=`pidof hald`
   if [ "$PID" ];then
  kill $PID
   fi
  sleep 2
  PID=`pidof hald`
   if [ "$PID" ];then
  echo "Failed to stop hald, still running with '$PID'"
   else
  echo "Successfully stopped hald"
   fi
  fi

  # Just in case:
  #killall hald 1> /dev/null 2> /dev/null
}

# See how we were called.
case "$1" in
    start)
        hal_start
        ;;
    stop)
        hal_stop
        ;;
    restart)
        hal_stop
	sleep 1
        hal_start
        ;;
    *)
        echo $"Usage: $0 {start|stop|restart}"
        ;;
esac
