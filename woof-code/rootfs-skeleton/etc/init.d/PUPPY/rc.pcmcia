#!/bin/ash
# BK jan 2008 for Puppy Linux GPL
#based on script from slackware.

DRIVER=probe
DRIVER_OPTS=

case "$1" in
	start)
		#/etc/rc.d/rc.modules should have already loaded a base PCMCIA module...
		if [ "`lsmod | grep -E '^yenta_socket|^i82365|^tcic'`" != "" ];then
 		 echo "Starting PCMCIA services:"
		 pcmcia-socket-startup

_deprecated_load_modules(){
#v4.01 now have /etc/rc.modules2 and /sbin/pup_eventd that load correct modules...
#  #v3.96 temp until get udev working...
  if [ "`ls -1 /sys/bus/pcmcia/devices/`" != "" ];then
   for ONEPCMCIA in `ls -1 /sys/bus/pcmcia/devices/ | tr '\n' ' '`
   do
    [ ! -e /sys/bus/pcmcia/devices/$ONEPCMCIA/modalias ] && continue #precaution
    MODALIAS="`cat /sys/bus/pcmcia/devices/$ONEPCMCIA/modalias`"
    REALMOD="`modprobe.bin --show-depends $MODALIAS | tail -n 1`"
    if [ "$REALMOD" != "" ];then
     REALNAME="`basename $REALMOD .ko`"
     /sbin/modprobe $Q $VERB $REALNAME
    else
     PROD_ID1="`cat /sys/bus/pcmcia/devices/$ONEPCMCIA/prod_id1`"
     PROD_ID2="`cat /sys/bus/pcmcia/devices/$ONEPCMCIA/prod_id2`"
     #database_old is a hacked file out of the old pcmcia-cs package...
     cat /etc/pcmcia/database_old | grep "\"${PROD_ID1}\"" | grep "\"${PROD_ID2}\"" | grep -o '| bind .*' | tr ',' ' ' | tr ' ' '\n' | grep '^"' | tr '"' ' ' | tr '\n' ' ' > /tmp/pcmciamodules
     sync
     for ONEPCMOD in `cat /tmp/pcmciamodules`
     do
      modprobe $Q $VERB $ONEPCMOD
     done
    fi
   done
  fi
}
		fi
		;;

	stop)
	        echo -n "Shutting down PCMCIA services: "
		echo -n "cards "
		/sbin/pccardctl eject
		MODULES=`/sbin/lsmod | grep "pcmcia " | awk '{print $4}' | tr , ' '`
		for i in $MODULES ; do
			echo -n "$i "
			/sbin/modprobe $Q $VERB -r $i >>$OUT 2>>$ERR
		done
		echo -n "pcmcia "
		/sbin/modprobe $Q $VERB -r pcmcia >>$OUT 2>>$ERR
		if [ "$DRIVER" = "probe" ]; then
			for DRV in yenta_socket i82365 tcic ; do
				if grep -w "$DRV" /proc/modules ;then
					modprobe $Q $VERB -r $DRV
					echo -n "$DRV "
					break
				fi
			done
		else
			/sbin/modprobe $Q $VERB -r $DRIVER >>$OUT 2>>$ERR
		fi
		echo -n "rsrc_nonstatic "
		/sbin/modprobe $Q $VERB -r rsrc_nonstatic >>$OUT 2>>$ERR
		echo "pcmcia_core"
		/sbin/modprobe $Q $VERB -r pcmcia_core >>$OUT 2>>$ERR
		;;

	restart)
		$0 stop
		$0 start
		;;
esac
