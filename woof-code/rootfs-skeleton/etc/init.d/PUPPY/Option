#!/bin/sh
#Barry Kauler, LGPL 2009

#If a different modem selected, quit...
[ ! -h /dev/modem ] && MODEM="" || MODEM="`readlink /dev/modem | grep -v '^ttyUSB[0-3]$'`"
[ "$MODEM" != "" ] && exit

[ ! $1 ] && exit
[ "$1" != "start" ] && exit

funcWAIT_FOR_OPTION_KO(){
#Wait for mode switch to start the driver...
WAITMAX=60
WAITCNT=0
while [ "`lsmod | grep '^option '`" = "" ];do
 sleep 1
 WAITCNT=`expr $WAITCNT + 1`
 [ $WAITCNT -gt $WAITMAX ] && echo "Script Option: timeout" >> /tmp/udevtrace-modem.log && exit
done
[ $WAITCNT -gt 0 ] && echo "Script Option: $WAITCNT-second wait for mode switch." >> /tmp/udevtrace-modem.log
}

/sbin/modprobe -vb --first-time option && sleep 2s

#Do not change /dev/modem if any other usbserial-dependent modem driver is loaded.
[ -h /dev/modem ] && [ "`lsmod | grep -E '^ipw |^ipwireless |^moto_modem |^sierra '`" != "" ] && exit

#Allow user to force new ttyUSB# in /etc/modemttyUSBnum if ttyUSB0 not appropriate.
[ ! -e /etc/modemttyUSBnum ] && echo -n 0 > /etc/modemttyUSBnum && sync
MODEM="ttyUSB`grep '^[0-3]$' /etc/modemttyUSBnum | head -n 1`"
[ "$MODEM" = "ttyUSB" ] && MODEM="ttyUSB0"
[ -h /dev/modem ] && rm /dev/modem
ln -snf $MODEM /dev/modem

###END###
