#!/bin/ash
#BK got this from http://murga-linux.com/puppy/viewtopic.php?t=55417&start=15
# but added test for /proc/acpi, bios-date, processor-manufacturer.
# added extra code provided by pakt.
#100603 gamble, any CPU >=2007 can handle acpi-cpufreq, or it will fail to load.

#disable freq scaling for older computers...
BIOS_YEAR_DEFAULT=2007
[ -d /proc/acpi ] || { echo "No /proc/acpi directory"; exit 0; }
[ `dmidecode -s "bios-release-date" | cut -f 3 -d '/'` -lt $BIOS_YEAR_DEFAULT ] && { echo "Bios year older than $BIOS_YEAR_DEFAULT"; exit 0; } #<2006 100603: <2007

INTEL='p4-clockmod speedstep-centrino speedstep-ich'
VIA='longhaul e_powersaver'
CYRIX='gx-suspmod'
FREQMODS="acpi-cpufreq"

GOUVERNORS=
GOUVERNOR=ondemand

 CPUMAN="`dmidecode -s 'processor-manufacturer' | tr '[A-Z]' '[a-z]' | cut -f 1 -d ' '`"
  case $CPUMAN in
   intel) FREQMODS="${INTEL} acpi-cpufreq" ;;
   via)   FREQMODS="${VIA} acpi-cpufreq"   ;;
   cyrix) FREQMODS="${CYRIX} acpi-cpufreq" ;;
  esac

case "$1" in
 start)
  echo "Starting cpu frequenzy scaling initialisation code:"
  for ONEMOD in $FREQMODS
  do
   echo "Trying to load $ONEMOD :"
   modprobe $Q $VERB $ONEMOD
   if [ $? -eq 0 ];then
    echo "Success loading $ONEMOD"
    echo "Trying to load cpufreq_$GOUVERNOR :"
    modprobe cpufreq_$GOUVERNOR
    if [ $? -eq 0 ];then
     echo "Success loading cpufreq_$GOUVERNOR"
     echo "Informing sysfs ..:"
     for CPUNUM in /sys/devices/system/cpu/cpu[0-9]*
     do
      echo $CPUNUM :
      ls -ld $CPUNUM/cpufreq
      test -L $CPUNUM/cpufreq && continue
      ls -l $CPUNUM/cpufreq/*
      test -w $CPUNUM/cpufreq/scaling_governor || continue
      cat $CPUNUM/cpufreq/*
      echo $GOUVERNOR >$CPUNUM/cpufreq/scaling_governor

      cat $CPUNUM/cpufreq/scaling_governor

       #echo $FREQ_MIN >$CPUNUM/cpufreq/scaling_min_freq
       #echo $FREQ_MAX >$CPUNUM/cpufreq/scaling_max_freq
     done
     break
    else
     rmmod $ONEMOD
    fi
   fi
  done
 ;;
esac

