#!/bin/ash

. /etc/rc.d/f4puppy5

_mount_none_filesystems(){
   nFS=`grep '^nodev' /proc/filesystems | tr  '\t' ' ' | cut -f 2 -d ' '`
#NODEV=`echo "$NFS" | grep -v -E 'pipe|sock|bdev|anon|inotify|aufs'`
 NODEV="$nFS"
test -d /nodev || mkdir /nodev

for oneFS in $NODEV ; do
      echo
 echo "$oneFS"
 DIR=`echo "$oneFS" | sed 's#fs$##'`

 if test -z "`grep -Fw "$oneFS" /proc/mounts`" ; then

 test "$1" = start || continue

   case $oneFS in
    debugfs) mkdir $VERB -p /sys/kernel/debug;       /bin/mount $VERB -t debugfs         nodev /sys/kernel/debug;
    echo 'module usb_storage +p' >/sys/kernel/debug/dynamic_debug/control;
    ;;
    fusectl) mkdir $VERB -p /sys/fs/fuse/connections; /bin/mount $VERB -t fusectl fusectl /sys/fs/fuse/connections;;
binfmt_misc) mkdir $VERB -p /proc/sys/fs/binfmt_misc; /bin/mount $VERB -t binfmt_misc     nodev /proc/sys/fs/binfmt_misc;;
 securityfs) mkdir $VERB -p /sys/kernel/security;     /bin/mount $VERB -t securityfs      nodev /sys/kernel/security;;
      usbfs) mkdir $VERB -p /proc/bus/usb;            /bin/mount $VERB -t usbfs           none  /proc/bus/usb;; # -o devmode=0666;;
   configfs) mkdir $VERB -p /config;                  /bin/mount $VERB -t configfs        none  /config;;
  hugetlbfs) mkdir $VERB -p /mnt/huge;                /bin/mount $VERB -t hugetlbfs       none  /mnt/huge;;
     pstore) mkdir $VERB -p /dev/fs/pstore;           /bin/mount $VERB -t pstore          nodev /dev/fs/pstore;;
ubifs|mtd_inodefs|exofs|autofs|nfs4|nfs|coda|bdev|sockfs|pipefs|anon_inodefs|aufs) :;;
      #mount: wrong fs type, bad option, bad superblock on /nodev, ...
    jffs2) :;;   #mount: /nodev is not a block device
    fuse)  :;;   #bin/sh: /nodev: is a directory
    ram*|tmp*) :;;
    rootfs)    :;;
    *)
    test -d /dev/fs/$DIR || mkdir $VERB -p /dev/fs/$DIR
    /bin/mount $VERB -t $oneFS nodev /dev/fs/$DIR
    ;;
   esac

else

 test "$1" = stop || continue
 while read -r _device_ _mountpoint_ _filesystem_ _rest_
 do
 case $_filesystem_ in
 aufs|devpts|proc|*ramfs|rootfs|sysfs|*tmpfs|unionfs|'') continue;;
 esac
 _mountpoint_=`echo -e "$_mountpoint_"`
 case $_mountpoint_ in /dev|/|'') continue;; esac
  _info "Attempting to unmount '$_mountpoint_'"
 /bin/umount "$_mountpoint_"
 done<<EoI
`grep -Fw "$oneFS" /proc/mounts`
EoI

 fi

done

}


echo $0:$*
case $1 in
stop)
 _mount_none_filesystems $1
;;
start)
 _mount_none_filesystems $1
;;
esac
echo $0:$*
