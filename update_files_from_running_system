#!/bin/ash
#set

. /etc/rc.d/f4puppy5

TTY=`tty`

which git || export PATH=/usr/SVC/bin:$PATH

MMIN=-720
MMIN=-1440

_find_topmost_git_dir(){

ME_DIR=`pwd`
TOP_DIR=$ME_DIR

while :;
do
test -d ../.git && { cd .. || exit; } || break
TOP_DIR="$TOP_DIR/../"
done

TOP_DIR=`echo "$TOP_DIR" | sed "s/^$ME_DIR//"`

echo "TOP_DIR='$TOP_DIR'"
}

_find_topmost_git_dir


_do_exit(){
echo exitcode $*
exit $*
}

_do_git(){
#unset YES_NO NO_YES
YES_NO='';
NO_YES='';
#read -p "Replace current file $file ? (y/n) : " <$TTY YES_NO >$TTY
read -p "Replace current file $file ? (y/n) : " YES_NO
echo "YES_NO='$YES_NO'"
case $YES_NO in
y|Y) :;;
n|N) return 0;;
*) _do_exit 3;;
esac
#sleep 1s

#cp -ai "$file" woof-code/rootfs-skeleton/${file%/*}/ <$TTY >$TTY || _do_exit 4
cp -ai "$file" ${TOPDIR}woof-code/rootfs-skeleton/${file%/*}/ || _do_exit 4

#read -n1 -p "Add file woof-code/rootfs-skeleton/$file to git ? (y/n) : " <$TTY NO_YES >$TTY
read -p "Add file woof-code/rootfs-skeleton/$file to git ? (y/n) : " NO_YES
case $NO_YES in
y|Y) :;;
n|N) return 0;;
*) _do_exit 5;;
esac
sleep 1s

git add  ${TOPDIR}woof-code/rootfs-skeleton/${file}

git commit
sleep 1s
return 0
}

for dirDIR in /etc /root /bin /sbin /usr/bin /usr/sbin /usr/local/bin
do
#find $dirDIR -mmin -720 |
dirFIND=`find $dirDIR -maxdepth 3 -mmin $MMIN`

 #while read file;
 oldIFS="$IFS"
 IFS=$'\n'
 for file in $dirFIND
 do
[ "$file" ] || continue
[ -d "${TOPDIR}woof-code/rootfs-skeleton/$file" ] && { echo "$file is a directory"; continue; }
[ -f "${TOPDIR}woof-code/rootfs-skeleton/$file" ] && {
diff -up ${TOPDIR}woof-code/rootfs-skeleton/$file $file && echo "$file not changed" || {

#_do_git <$TTY >$TTY || _do_exit $?;
#_do_git || _do_exit $?;

#unset YES_NO NO_YES
YES_NO='';
NO_YES='';
#read -p "Replace current file $file ? (y/n) : " <$TTY YES_NO >$TTY
read -p "Replace current file $file ? (y/n) : " YES_NO
echo "YES_NO='$YES_NO'"
case $YES_NO in
y|Y) :;;
n|N) continue;;
*) _do_exit 3;;
esac
#sleep 1s

#cp -ai "$file" woof-code/rootfs-skeleton/${file%/*}/ <$TTY >$TTY || _do_exit 4
cp -ai "$file" ${TOPDIR}woof-code/rootfs-skeleton/${file%/*}/ || continue #_do_exit 4

#read -n1 -p "Add file woof-code/rootfs-skeleton/$file to git ? (y/n) : " <$TTY NO_YES >$TTY
read -p "Add file woof-code/rootfs-skeleton/$file to git ? (y/n) : " NO_YES
case $NO_YES in
y|Y) :;;
n|N) continue;;
*) _do_exit 5;;
esac
sleep 1s

git add ${TOPDIR}woof-code/rootfs-skeleton/${file}

git commit
sleep 1s

 };

} || echo "$file not in woof or no regular file therein";

 done
 IFS="$oldIFS"

#done <<EOI
#`echo "$dirFIND"`
#EOI

done
